<!DOCTYPE html>
<!-- Generated by Cython 0.28.4 -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cython: Compute_Similarity_Cython.pyx</title>
    <style type="text/css">
    
body.cython { font-family: courier; font-size: 12; }

.cython.tag  {  }
.cython.line { margin: 0em }
.cython.code { font-size: 9; color: #444444; display: none; margin: 0px 0px 0px 8px; border-left: 8px none; }

.cython.line .run { background-color: #B0FFB0; }
.cython.line .mis { background-color: #FFB0B0; }
.cython.code.run  { border-left: 8px solid #B0FFB0; }
.cython.code.mis  { border-left: 8px solid #FFB0B0; }

.cython.code .py_c_api  { color: red; }
.cython.code .py_macro_api  { color: #FF7000; }
.cython.code .pyx_c_api  { color: #FF3000; }
.cython.code .pyx_macro_api  { color: #FF7000; }
.cython.code .refnanny  { color: #FFA000; }
.cython.code .trace  { color: #FFA000; }
.cython.code .error_goto  { color: #FFA000; }

.cython.code .coerce  { color: #008000; border: 1px dotted #008000 }
.cython.code .py_attr { color: #FF0000; font-weight: bold; }
.cython.code .c_attr  { color: #0000FF; }
.cython.code .py_call { color: #FF0000; font-weight: bold; }
.cython.code .c_call  { color: #0000FF; }

.cython.score-0 {background-color: #FFFFff;}
.cython.score-1 {background-color: #FFFFe7;}
.cython.score-2 {background-color: #FFFFd4;}
.cython.score-3 {background-color: #FFFFc4;}
.cython.score-4 {background-color: #FFFFb6;}
.cython.score-5 {background-color: #FFFFaa;}
.cython.score-6 {background-color: #FFFF9f;}
.cython.score-7 {background-color: #FFFF96;}
.cython.score-8 {background-color: #FFFF8d;}
.cython.score-9 {background-color: #FFFF86;}
.cython.score-10 {background-color: #FFFF7f;}
.cython.score-11 {background-color: #FFFF79;}
.cython.score-12 {background-color: #FFFF73;}
.cython.score-13 {background-color: #FFFF6e;}
.cython.score-14 {background-color: #FFFF6a;}
.cython.score-15 {background-color: #FFFF66;}
.cython.score-16 {background-color: #FFFF62;}
.cython.score-17 {background-color: #FFFF5e;}
.cython.score-18 {background-color: #FFFF5b;}
.cython.score-19 {background-color: #FFFF57;}
.cython.score-20 {background-color: #FFFF55;}
.cython.score-21 {background-color: #FFFF52;}
.cython.score-22 {background-color: #FFFF4f;}
.cython.score-23 {background-color: #FFFF4d;}
.cython.score-24 {background-color: #FFFF4b;}
.cython.score-25 {background-color: #FFFF48;}
.cython.score-26 {background-color: #FFFF46;}
.cython.score-27 {background-color: #FFFF44;}
.cython.score-28 {background-color: #FFFF43;}
.cython.score-29 {background-color: #FFFF41;}
.cython.score-30 {background-color: #FFFF3f;}
.cython.score-31 {background-color: #FFFF3e;}
.cython.score-32 {background-color: #FFFF3c;}
.cython.score-33 {background-color: #FFFF3b;}
.cython.score-34 {background-color: #FFFF39;}
.cython.score-35 {background-color: #FFFF38;}
.cython.score-36 {background-color: #FFFF37;}
.cython.score-37 {background-color: #FFFF36;}
.cython.score-38 {background-color: #FFFF35;}
.cython.score-39 {background-color: #FFFF34;}
.cython.score-40 {background-color: #FFFF33;}
.cython.score-41 {background-color: #FFFF32;}
.cython.score-42 {background-color: #FFFF31;}
.cython.score-43 {background-color: #FFFF30;}
.cython.score-44 {background-color: #FFFF2f;}
.cython.score-45 {background-color: #FFFF2e;}
.cython.score-46 {background-color: #FFFF2d;}
.cython.score-47 {background-color: #FFFF2c;}
.cython.score-48 {background-color: #FFFF2b;}
.cython.score-49 {background-color: #FFFF2b;}
.cython.score-50 {background-color: #FFFF2a;}
.cython.score-51 {background-color: #FFFF29;}
.cython.score-52 {background-color: #FFFF29;}
.cython.score-53 {background-color: #FFFF28;}
.cython.score-54 {background-color: #FFFF27;}
.cython.score-55 {background-color: #FFFF27;}
.cython.score-56 {background-color: #FFFF26;}
.cython.score-57 {background-color: #FFFF26;}
.cython.score-58 {background-color: #FFFF25;}
.cython.score-59 {background-color: #FFFF24;}
.cython.score-60 {background-color: #FFFF24;}
.cython.score-61 {background-color: #FFFF23;}
.cython.score-62 {background-color: #FFFF23;}
.cython.score-63 {background-color: #FFFF22;}
.cython.score-64 {background-color: #FFFF22;}
.cython.score-65 {background-color: #FFFF22;}
.cython.score-66 {background-color: #FFFF21;}
.cython.score-67 {background-color: #FFFF21;}
.cython.score-68 {background-color: #FFFF20;}
.cython.score-69 {background-color: #FFFF20;}
.cython.score-70 {background-color: #FFFF1f;}
.cython.score-71 {background-color: #FFFF1f;}
.cython.score-72 {background-color: #FFFF1f;}
.cython.score-73 {background-color: #FFFF1e;}
.cython.score-74 {background-color: #FFFF1e;}
.cython.score-75 {background-color: #FFFF1e;}
.cython.score-76 {background-color: #FFFF1d;}
.cython.score-77 {background-color: #FFFF1d;}
.cython.score-78 {background-color: #FFFF1c;}
.cython.score-79 {background-color: #FFFF1c;}
.cython.score-80 {background-color: #FFFF1c;}
.cython.score-81 {background-color: #FFFF1c;}
.cython.score-82 {background-color: #FFFF1b;}
.cython.score-83 {background-color: #FFFF1b;}
.cython.score-84 {background-color: #FFFF1b;}
.cython.score-85 {background-color: #FFFF1a;}
.cython.score-86 {background-color: #FFFF1a;}
.cython.score-87 {background-color: #FFFF1a;}
.cython.score-88 {background-color: #FFFF1a;}
.cython.score-89 {background-color: #FFFF19;}
.cython.score-90 {background-color: #FFFF19;}
.cython.score-91 {background-color: #FFFF19;}
.cython.score-92 {background-color: #FFFF19;}
.cython.score-93 {background-color: #FFFF18;}
.cython.score-94 {background-color: #FFFF18;}
.cython.score-95 {background-color: #FFFF18;}
.cython.score-96 {background-color: #FFFF18;}
.cython.score-97 {background-color: #FFFF17;}
.cython.score-98 {background-color: #FFFF17;}
.cython.score-99 {background-color: #FFFF17;}
.cython.score-100 {background-color: #FFFF17;}
.cython.score-101 {background-color: #FFFF16;}
.cython.score-102 {background-color: #FFFF16;}
.cython.score-103 {background-color: #FFFF16;}
.cython.score-104 {background-color: #FFFF16;}
.cython.score-105 {background-color: #FFFF16;}
.cython.score-106 {background-color: #FFFF15;}
.cython.score-107 {background-color: #FFFF15;}
.cython.score-108 {background-color: #FFFF15;}
.cython.score-109 {background-color: #FFFF15;}
.cython.score-110 {background-color: #FFFF15;}
.cython.score-111 {background-color: #FFFF15;}
.cython.score-112 {background-color: #FFFF14;}
.cython.score-113 {background-color: #FFFF14;}
.cython.score-114 {background-color: #FFFF14;}
.cython.score-115 {background-color: #FFFF14;}
.cython.score-116 {background-color: #FFFF14;}
.cython.score-117 {background-color: #FFFF14;}
.cython.score-118 {background-color: #FFFF13;}
.cython.score-119 {background-color: #FFFF13;}
.cython.score-120 {background-color: #FFFF13;}
.cython.score-121 {background-color: #FFFF13;}
.cython.score-122 {background-color: #FFFF13;}
.cython.score-123 {background-color: #FFFF13;}
.cython.score-124 {background-color: #FFFF13;}
.cython.score-125 {background-color: #FFFF12;}
.cython.score-126 {background-color: #FFFF12;}
.cython.score-127 {background-color: #FFFF12;}
.cython.score-128 {background-color: #FFFF12;}
.cython.score-129 {background-color: #FFFF12;}
.cython.score-130 {background-color: #FFFF12;}
.cython.score-131 {background-color: #FFFF12;}
.cython.score-132 {background-color: #FFFF11;}
.cython.score-133 {background-color: #FFFF11;}
.cython.score-134 {background-color: #FFFF11;}
.cython.score-135 {background-color: #FFFF11;}
.cython.score-136 {background-color: #FFFF11;}
.cython.score-137 {background-color: #FFFF11;}
.cython.score-138 {background-color: #FFFF11;}
.cython.score-139 {background-color: #FFFF11;}
.cython.score-140 {background-color: #FFFF11;}
.cython.score-141 {background-color: #FFFF10;}
.cython.score-142 {background-color: #FFFF10;}
.cython.score-143 {background-color: #FFFF10;}
.cython.score-144 {background-color: #FFFF10;}
.cython.score-145 {background-color: #FFFF10;}
.cython.score-146 {background-color: #FFFF10;}
.cython.score-147 {background-color: #FFFF10;}
.cython.score-148 {background-color: #FFFF10;}
.cython.score-149 {background-color: #FFFF10;}
.cython.score-150 {background-color: #FFFF0f;}
.cython.score-151 {background-color: #FFFF0f;}
.cython.score-152 {background-color: #FFFF0f;}
.cython.score-153 {background-color: #FFFF0f;}
.cython.score-154 {background-color: #FFFF0f;}
.cython.score-155 {background-color: #FFFF0f;}
.cython.score-156 {background-color: #FFFF0f;}
.cython.score-157 {background-color: #FFFF0f;}
.cython.score-158 {background-color: #FFFF0f;}
.cython.score-159 {background-color: #FFFF0f;}
.cython.score-160 {background-color: #FFFF0f;}
.cython.score-161 {background-color: #FFFF0e;}
.cython.score-162 {background-color: #FFFF0e;}
.cython.score-163 {background-color: #FFFF0e;}
.cython.score-164 {background-color: #FFFF0e;}
.cython.score-165 {background-color: #FFFF0e;}
.cython.score-166 {background-color: #FFFF0e;}
.cython.score-167 {background-color: #FFFF0e;}
.cython.score-168 {background-color: #FFFF0e;}
.cython.score-169 {background-color: #FFFF0e;}
.cython.score-170 {background-color: #FFFF0e;}
.cython.score-171 {background-color: #FFFF0e;}
.cython.score-172 {background-color: #FFFF0e;}
.cython.score-173 {background-color: #FFFF0d;}
.cython.score-174 {background-color: #FFFF0d;}
.cython.score-175 {background-color: #FFFF0d;}
.cython.score-176 {background-color: #FFFF0d;}
.cython.score-177 {background-color: #FFFF0d;}
.cython.score-178 {background-color: #FFFF0d;}
.cython.score-179 {background-color: #FFFF0d;}
.cython.score-180 {background-color: #FFFF0d;}
.cython.score-181 {background-color: #FFFF0d;}
.cython.score-182 {background-color: #FFFF0d;}
.cython.score-183 {background-color: #FFFF0d;}
.cython.score-184 {background-color: #FFFF0d;}
.cython.score-185 {background-color: #FFFF0d;}
.cython.score-186 {background-color: #FFFF0d;}
.cython.score-187 {background-color: #FFFF0c;}
.cython.score-188 {background-color: #FFFF0c;}
.cython.score-189 {background-color: #FFFF0c;}
.cython.score-190 {background-color: #FFFF0c;}
.cython.score-191 {background-color: #FFFF0c;}
.cython.score-192 {background-color: #FFFF0c;}
.cython.score-193 {background-color: #FFFF0c;}
.cython.score-194 {background-color: #FFFF0c;}
.cython.score-195 {background-color: #FFFF0c;}
.cython.score-196 {background-color: #FFFF0c;}
.cython.score-197 {background-color: #FFFF0c;}
.cython.score-198 {background-color: #FFFF0c;}
.cython.score-199 {background-color: #FFFF0c;}
.cython.score-200 {background-color: #FFFF0c;}
.cython.score-201 {background-color: #FFFF0c;}
.cython.score-202 {background-color: #FFFF0c;}
.cython.score-203 {background-color: #FFFF0b;}
.cython.score-204 {background-color: #FFFF0b;}
.cython.score-205 {background-color: #FFFF0b;}
.cython.score-206 {background-color: #FFFF0b;}
.cython.score-207 {background-color: #FFFF0b;}
.cython.score-208 {background-color: #FFFF0b;}
.cython.score-209 {background-color: #FFFF0b;}
.cython.score-210 {background-color: #FFFF0b;}
.cython.score-211 {background-color: #FFFF0b;}
.cython.score-212 {background-color: #FFFF0b;}
.cython.score-213 {background-color: #FFFF0b;}
.cython.score-214 {background-color: #FFFF0b;}
.cython.score-215 {background-color: #FFFF0b;}
.cython.score-216 {background-color: #FFFF0b;}
.cython.score-217 {background-color: #FFFF0b;}
.cython.score-218 {background-color: #FFFF0b;}
.cython.score-219 {background-color: #FFFF0b;}
.cython.score-220 {background-color: #FFFF0b;}
.cython.score-221 {background-color: #FFFF0b;}
.cython.score-222 {background-color: #FFFF0a;}
.cython.score-223 {background-color: #FFFF0a;}
.cython.score-224 {background-color: #FFFF0a;}
.cython.score-225 {background-color: #FFFF0a;}
.cython.score-226 {background-color: #FFFF0a;}
.cython.score-227 {background-color: #FFFF0a;}
.cython.score-228 {background-color: #FFFF0a;}
.cython.score-229 {background-color: #FFFF0a;}
.cython.score-230 {background-color: #FFFF0a;}
.cython.score-231 {background-color: #FFFF0a;}
.cython.score-232 {background-color: #FFFF0a;}
.cython.score-233 {background-color: #FFFF0a;}
.cython.score-234 {background-color: #FFFF0a;}
.cython.score-235 {background-color: #FFFF0a;}
.cython.score-236 {background-color: #FFFF0a;}
.cython.score-237 {background-color: #FFFF0a;}
.cython.score-238 {background-color: #FFFF0a;}
.cython.score-239 {background-color: #FFFF0a;}
.cython.score-240 {background-color: #FFFF0a;}
.cython.score-241 {background-color: #FFFF0a;}
.cython.score-242 {background-color: #FFFF0a;}
.cython.score-243 {background-color: #FFFF0a;}
.cython.score-244 {background-color: #FFFF0a;}
.cython.score-245 {background-color: #FFFF0a;}
.cython.score-246 {background-color: #FFFF09;}
.cython.score-247 {background-color: #FFFF09;}
.cython.score-248 {background-color: #FFFF09;}
.cython.score-249 {background-color: #FFFF09;}
.cython.score-250 {background-color: #FFFF09;}
.cython.score-251 {background-color: #FFFF09;}
.cython.score-252 {background-color: #FFFF09;}
.cython.score-253 {background-color: #FFFF09;}
.cython.score-254 {background-color: #FFFF09;}
.cython .hll { background-color: #ffffcc }
.cython  { background: #f8f8f8; }
.cython .c { color: #408080; font-style: italic } /* Comment */
.cython .err { border: 1px solid #FF0000 } /* Error */
.cython .k { color: #008000; font-weight: bold } /* Keyword */
.cython .o { color: #666666 } /* Operator */
.cython .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.cython .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.cython .cp { color: #BC7A00 } /* Comment.Preproc */
.cython .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.cython .c1 { color: #408080; font-style: italic } /* Comment.Single */
.cython .cs { color: #408080; font-style: italic } /* Comment.Special */
.cython .gd { color: #A00000 } /* Generic.Deleted */
.cython .ge { font-style: italic } /* Generic.Emph */
.cython .gr { color: #FF0000 } /* Generic.Error */
.cython .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.cython .gi { color: #00A000 } /* Generic.Inserted */
.cython .go { color: #888888 } /* Generic.Output */
.cython .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.cython .gs { font-weight: bold } /* Generic.Strong */
.cython .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.cython .gt { color: #0044DD } /* Generic.Traceback */
.cython .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.cython .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.cython .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.cython .kp { color: #008000 } /* Keyword.Pseudo */
.cython .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.cython .kt { color: #B00040 } /* Keyword.Type */
.cython .m { color: #666666 } /* Literal.Number */
.cython .s { color: #BA2121 } /* Literal.String */
.cython .na { color: #7D9029 } /* Name.Attribute */
.cython .nb { color: #008000 } /* Name.Builtin */
.cython .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.cython .no { color: #880000 } /* Name.Constant */
.cython .nd { color: #AA22FF } /* Name.Decorator */
.cython .ni { color: #999999; font-weight: bold } /* Name.Entity */
.cython .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.cython .nf { color: #0000FF } /* Name.Function */
.cython .nl { color: #A0A000 } /* Name.Label */
.cython .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.cython .nt { color: #008000; font-weight: bold } /* Name.Tag */
.cython .nv { color: #19177C } /* Name.Variable */
.cython .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.cython .w { color: #bbbbbb } /* Text.Whitespace */
.cython .mb { color: #666666 } /* Literal.Number.Bin */
.cython .mf { color: #666666 } /* Literal.Number.Float */
.cython .mh { color: #666666 } /* Literal.Number.Hex */
.cython .mi { color: #666666 } /* Literal.Number.Integer */
.cython .mo { color: #666666 } /* Literal.Number.Oct */
.cython .sa { color: #BA2121 } /* Literal.String.Affix */
.cython .sb { color: #BA2121 } /* Literal.String.Backtick */
.cython .sc { color: #BA2121 } /* Literal.String.Char */
.cython .dl { color: #BA2121 } /* Literal.String.Delimiter */
.cython .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.cython .s2 { color: #BA2121 } /* Literal.String.Double */
.cython .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.cython .sh { color: #BA2121 } /* Literal.String.Heredoc */
.cython .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.cython .sx { color: #008000 } /* Literal.String.Other */
.cython .sr { color: #BB6688 } /* Literal.String.Regex */
.cython .s1 { color: #BA2121 } /* Literal.String.Single */
.cython .ss { color: #19177C } /* Literal.String.Symbol */
.cython .bp { color: #008000 } /* Name.Builtin.Pseudo */
.cython .fm { color: #0000FF } /* Name.Function.Magic */
.cython .vc { color: #19177C } /* Name.Variable.Class */
.cython .vg { color: #19177C } /* Name.Variable.Global */
.cython .vi { color: #19177C } /* Name.Variable.Instance */
.cython .vm { color: #19177C } /* Name.Variable.Magic */
.cython .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
</head>
<body class="cython">
<p><span style="border-bottom: solid 1px grey;">Generated by Cython 0.28.4</span></p>
<p>
    <span style="background-color: #FFFF00">Yellow lines</span> hint at Python interaction.<br />
    Click on a line that starts with a "<code>+</code>" to see the C code that Cython generated for it.
</p>
<p>Raw output: <a href="Compute_Similarity_Cython.c">Compute_Similarity_Cython.c</a></p>
<div class="cython"><pre class="cython line score-8" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">001</span>: <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class='cython code score-8 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(0);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_test, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">002</span>: <span class="sd">Created on 23/10/17</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">003</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">004</span>: <span class="sd">@author: Maurizio Ferrari Dacrema</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">005</span>: <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">006</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">007</span>: <span class="c">#cython: boundscheck=False</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">008</span>: <span class="c">#cython: wraparound=True</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">009</span>: <span class="c">#cython: initializedcheck=False</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">010</span>: <span class="c">#cython: language_level=3</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">011</span>: <span class="c">#cython: nonecheck=False</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">012</span>: <span class="c">#cython: cdivision=True</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">013</span>: <span class="c">#cython: unpack_method_calls=True</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">014</span>: <span class="c">#cython: overflowcheck=False</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">015</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">016</span>: </pre>
<pre class="cython line score-16" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">017</span>: <span class="k">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">sys</span></pre>
<pre class='cython code score-16 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_time, 0, -1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 17, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_time, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 17, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_sys, 0, -1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 17, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_sys, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 17, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">018</span>: </pre>
<pre class="cython line score-8" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">019</span>: <span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span></pre>
<pre class='cython code score-8 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_numpy, 0, -1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 19, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_np, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 19, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">020</span>: <span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">021</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">022</span>: <span class="k">from</span> <span class="nn">cpython.array</span> <span class="k">cimport</span> <span class="n">array</span><span class="p">,</span> <span class="n">clone</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">023</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">024</span>: <span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sqrt</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">025</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">026</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">027</span>: </pre>
<pre class="cython line score-16" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">028</span>: <span class="k">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sps</span></pre>
<pre class='cython code score-16 '>  __pyx_t_1 = <span class='py_c_api'>PyList_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 28, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s__34);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s__34);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_1, 0, __pyx_n_s__34);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_scipy_sparse, __pyx_t_1, -1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 28, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_sps, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 28, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-19" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">029</span>: <span class="k">from</span> <span class="nn">Base.Recommender_utils</span> <span class="k">import</span> <span class="n">check_matrix</span></pre>
<pre class='cython code score-19 '>  __pyx_t_2 = <span class='py_c_api'>PyList_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 29, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s_check_matrix);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s_check_matrix);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_2, 0, __pyx_n_s_check_matrix);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_Base_Recommender_utils, __pyx_t_2, -1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 29, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_ImportFrom</span>(__pyx_t_1, __pyx_n_s_check_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 29, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_check_matrix, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 29, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">030</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">031</span>: <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">032</span>: <span class="c"># ctypedef struct data_pointer_s:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">033</span>: <span class="c">#     long start_position</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">034</span>: <span class="c">#     long num_elements</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">035</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">036</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">037</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">038</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">039</span>: <span class="k">cdef</span> <span class="k">class</span> <span class="nf">Compute_Similarity_Cython</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython {
  PyObject_HEAD
  struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_vtab;
  int TopK;
  long n_columns;
  long n_rows;
  __Pyx_memviewslice this_item_weights;
  __Pyx_memviewslice this_item_weights_mask;
  __Pyx_memviewslice this_item_weights_id;
  int this_item_weights_counter;
  __Pyx_memviewslice user_to_item_row_ptr;
  __Pyx_memviewslice user_to_item_cols;
  __Pyx_memviewslice item_to_user_rows;
  __Pyx_memviewslice item_to_user_col_ptr;
  __Pyx_memviewslice user_to_item_data;
  __Pyx_memviewslice item_to_user_data;
  __Pyx_memviewslice sumOfSquared;
  int shrink;
  int normalize;
  int adjusted_cosine;
  int pearson_correlation;
  int tanimoto_coefficient;
  int use_row_weights;
  __Pyx_memviewslice row_weights;
  __Pyx_memviewslice W_dense;
};
/* … */
struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython {
  PyObject *(*useOnlyBooleanInteractions)(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *, PyObject *);
  PyObject *(*applyPearsonCorrelation)(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *, PyObject *);
  PyObject *(*applyAdjustedCosine)(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *, PyObject *);
  __Pyx_memviewslice (*getUsersThatRatedItem)(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *, long);
  __Pyx_memviewslice (*getItemsRatedByUser)(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *, long);
  PyObject *(*computeItemSimilarities)(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *, long);
};
static struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_vtabptr_25Compute_Similarity_Cython_Compute_Similarity_Cython;

</pre><pre class="cython line score-0">&#xA0;<span class="">040</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">041</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">TopK</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">042</span>:     <span class="k">cdef</span> <span class="kt">long</span> <span class="nf">n_columns</span><span class="p">,</span> <span class="nf">n_rows</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">043</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">044</span>:     <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">this_item_weights</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">045</span>:     <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">this_item_weights_mask</span><span class="p">,</span> <span class="n">this_item_weights_id</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">046</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">this_item_weights_counter</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">047</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">048</span>:     <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">user_to_item_row_ptr</span><span class="p">,</span> <span class="n">user_to_item_cols</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">049</span>:     <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">item_to_user_rows</span><span class="p">,</span> <span class="n">item_to_user_col_ptr</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">050</span>:     <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">user_to_item_data</span><span class="p">,</span> <span class="n">item_to_user_data</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">051</span>:     <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">sumOfSquared</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">052</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">shrink</span><span class="p">,</span> <span class="nf">normalize</span><span class="p">,</span> <span class="nf">adjusted_cosine</span><span class="p">,</span> <span class="nf">pearson_correlation</span><span class="p">,</span> <span class="nf">tanimoto_coefficient</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">053</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">054</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">use_row_weights</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">055</span>:     <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">row_weights</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">056</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">057</span>:     <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:,:]</span> <span class="n">W_dense</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">058</span>: </pre>
<pre class="cython line score-10" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">059</span>:     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataMatrix</span><span class="p">,</span> <span class="n">topK</span> <span class="o">=</span> <span class="mf">100</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span></pre>
<pre class='cython code score-10 '>/* Python wrapper */
static int __pyx_pw_25Compute_Similarity_Cython_25Compute_Similarity_Cython_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_25Compute_Similarity_Cython_25Compute_Similarity_Cython___init__[] = "\n        Computes the cosine similarity on the columns of dataMatrix\n        If it is computed on URM=|users|x|items|, pass the URM as is.\n        If it is computed on ICM=|items|x|features|, pass the ICM transposed.\n        :param dataMatrix:\n        :param topK:\n        :param shrink:\n        :param normalize:           If True divide the dot product by the product of the norms\n        :param row_weights:         Multiply the values in each row by a specified value. Array\n        :param similarity:  \"cosine\"    computes Cosine similarity\n                            \"adjusted\"  computes Adjusted Cosine, removing the average of the users\n                            \"pearson\"   computes Pearson Correlation, removing the average of the items\n                            \"jaccard\"   computes Jaccard similarity for binary interactions using Tanimoto\n                            \"tanimoto\"  computes Tanimoto coefficient for binary interactions\n\n        ";
#if CYTHON_COMPILING_IN_CPYTHON
struct wrapperbase __pyx_wrapperbase_25Compute_Similarity_Cython_25Compute_Similarity_Cython___init__;
#endif
static int __pyx_pw_25Compute_Similarity_Cython_25Compute_Similarity_Cython_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyObject *__pyx_v_dataMatrix = 0;
  PyObject *__pyx_v_topK = 0;
  PyObject *__pyx_v_shrink = 0;
  PyObject *__pyx_v_normalize = 0;
  PyObject *__pyx_v_similarity = 0;
  PyObject *__pyx_v_row_weights = 0;
  int __pyx_r;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__init__ (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_dataMatrix,&amp;__pyx_n_s_topK,&amp;__pyx_n_s_shrink,&amp;__pyx_n_s_normalize,&amp;__pyx_n_s_similarity,&amp;__pyx_n_s_row_weights,0};
    PyObject* values[6] = {0,0,0,0,0,0};
    values[1] = ((PyObject *)__pyx_int_100);
    values[2] = ((PyObject *)__pyx_int_0);
    values[3] = ((PyObject *)Py_True);
    values[4] = ((PyObject *)__pyx_n_s_cosine);
/* … */
  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static int __pyx_pf_25Compute_Similarity_Cython_25Compute_Similarity_Cython___init__(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_v_self, PyObject *__pyx_v_dataMatrix, PyObject *__pyx_v_topK, PyObject *__pyx_v_shrink, PyObject *__pyx_v_normalize, PyObject *__pyx_v_similarity, PyObject *__pyx_v_row_weights) {
  int __pyx_r;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__init__", 0);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
/* … */
  /* function exit code */
  __pyx_r = 0;
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_9);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_10, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_12);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_14, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = -1;
  __pyx_L0:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_dataMatrix);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-38" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">060</span>:                  <span class="n">similarity</span> <span class="o">=</span> <span class="s">&quot;cosine&quot;</span><span class="p">,</span> <span class="n">row_weights</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span></pre>
<pre class='cython code score-38 '>    values[5] = ((PyObject *)Py_None);
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  6: values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
        CYTHON_FALLTHROUGH;
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_dataMatrix)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_topK);
          if (value) { values[1] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  2:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_shrink);
          if (value) { values[2] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  3:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_normalize);
          if (value) { values[3] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  4:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_similarity);
          if (value) { values[4] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  5:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_row_weights);
          if (value) { values[5] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 59, __pyx_L3_error)</span>
      }
    } else {
      switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
        case  6: values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
        CYTHON_FALLTHROUGH;
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_dataMatrix = values[0];
    __pyx_v_topK = values[1];
    __pyx_v_shrink = values[2];
    __pyx_v_normalize = values[3];
    __pyx_v_similarity = values[4];
    __pyx_v_row_weights = values[5];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("__init__", 0, 1, 6, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 59, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return -1;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_25Compute_Similarity_Cython_25Compute_Similarity_Cython___init__(((struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *)__pyx_v_self), __pyx_v_dataMatrix, __pyx_v_topK, __pyx_v_shrink, __pyx_v_normalize, __pyx_v_similarity, __pyx_v_row_weights);
</pre><pre class="cython line score-0">&#xA0;<span class="">061</span>:         <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">062</span>: <span class="sd">        Computes the cosine similarity on the columns of dataMatrix</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">063</span>: <span class="sd">        If it is computed on URM=|users|x|items|, pass the URM as is.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">064</span>: <span class="sd">        If it is computed on ICM=|items|x|features|, pass the ICM transposed.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">065</span>: <span class="sd">        :param dataMatrix:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">066</span>: <span class="sd">        :param topK:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">067</span>: <span class="sd">        :param shrink:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">068</span>: <span class="sd">        :param normalize:           If True divide the dot product by the product of the norms</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">069</span>: <span class="sd">        :param row_weights:         Multiply the values in each row by a specified value. Array</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">070</span>: <span class="sd">        :param similarity:  &quot;cosine&quot;    computes Cosine similarity</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">071</span>: <span class="sd">                            &quot;adjusted&quot;  computes Adjusted Cosine, removing the average of the users</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">072</span>: <span class="sd">                            &quot;pearson&quot;   computes Pearson Correlation, removing the average of the items</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">073</span>: <span class="sd">                            &quot;jaccard&quot;   computes Jaccard similarity for binary interactions using Tanimoto</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">074</span>: <span class="sd">                            &quot;tanimoto&quot;  computes Tanimoto coefficient for binary interactions</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">075</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">076</span>: <span class="sd">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">077</span>: </pre>
<pre class="cython line score-32" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">078</span>:         <span class="nb">super</span><span class="p">(</span><span class="n">Compute_Similarity_Cython</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span></pre>
<pre class='cython code score-32 '>  __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 78, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_ptype_25Compute_Similarity_Cython_Compute_Similarity_Cython));
  <span class='refnanny'>__Pyx_GIVEREF</span>(((PyObject *)__pyx_ptype_25Compute_Similarity_Cython_Compute_Similarity_Cython));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, ((PyObject *)__pyx_ptype_25Compute_Similarity_Cython_Compute_Similarity_Cython));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_self));
  <span class='refnanny'>__Pyx_GIVEREF</span>(((PyObject *)__pyx_v_self));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 1, ((PyObject *)__pyx_v_self));
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_super, __pyx_t_2, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 78, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_init);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 78, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
    __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
    }
  }
  if (__pyx_t_3) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_2, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 78, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  } else {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 78, __pyx_L1_error)</span>
  }
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">079</span>: </pre>
<pre class="cython line score-13" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">080</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-13 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 80, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 80, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyInt_As_long</span>(__pyx_t_2); if (unlikely((__pyx_t_4 == (long)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 80, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_self-&gt;n_columns = __pyx_t_4;
</pre><pre class="cython line score-13" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">081</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">n_rows</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-13 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 81, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_2, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 81, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyInt_As_long</span>(__pyx_t_1); if (unlikely((__pyx_t_4 == (long)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 81, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_self-&gt;n_rows = __pyx_t_4;
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">082</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">shrink</span> <span class="o">=</span> <span class="n">shrink</span></pre>
<pre class='cython code score-7 '>  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyInt_As_int</span>(__pyx_v_shrink); if (unlikely((__pyx_t_5 == (int)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 82, __pyx_L1_error)</span>
  __pyx_v_self-&gt;shrink = __pyx_t_5;
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">083</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span></pre>
<pre class='cython code score-7 '>  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyInt_As_int</span>(__pyx_v_normalize); if (unlikely((__pyx_t_5 == (int)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 83, __pyx_L1_error)</span>
  __pyx_v_self-&gt;normalize = __pyx_t_5;
</pre><pre class="cython line score-0">&#xA0;<span class="">084</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">085</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">adjusted_cosine</span> <span class="o">=</span> <span class="bp">False</span></pre>
<pre class='cython code score-0 '>  __pyx_v_self-&gt;adjusted_cosine = 0;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">086</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">pearson_correlation</span> <span class="o">=</span> <span class="bp">False</span></pre>
<pre class='cython code score-0 '>  __pyx_v_self-&gt;pearson_correlation = 0;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">087</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">tanimoto_coefficient</span> <span class="o">=</span> <span class="bp">False</span></pre>
<pre class='cython code score-0 '>  __pyx_v_self-&gt;tanimoto_coefficient = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">088</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">089</span>:         <span class="k">if</span> <span class="n">similarity</span> <span class="o">==</span> <span class="s">&quot;adjusted&quot;</span><span class="p">:</span></pre>
<pre class='cython code score-2 '>  __pyx_t_6 = (<span class='pyx_c_api'>__Pyx_PyString_Equals</span>(__pyx_v_similarity, __pyx_n_s_adjusted, Py_EQ)); if (unlikely(__pyx_t_6 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L1_error)</span>
  if (__pyx_t_6) {
/* … */
    goto __pyx_L3;
  }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">090</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">adjusted_cosine</span> <span class="o">=</span> <span class="bp">True</span></pre>
<pre class='cython code score-0 '>    __pyx_v_self-&gt;adjusted_cosine = 1;
</pre><pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">091</span>:         <span class="k">elif</span> <span class="n">similarity</span> <span class="o">==</span> <span class="s">&quot;pearson&quot;</span><span class="p">:</span></pre>
<pre class='cython code score-2 '>  __pyx_t_6 = (<span class='pyx_c_api'>__Pyx_PyString_Equals</span>(__pyx_v_similarity, __pyx_n_s_pearson, Py_EQ)); if (unlikely(__pyx_t_6 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 91, __pyx_L1_error)</span>
  if (__pyx_t_6) {
/* … */
    goto __pyx_L3;
  }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">092</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">pearson_correlation</span> <span class="o">=</span> <span class="bp">True</span></pre>
<pre class='cython code score-0 '>    __pyx_v_self-&gt;pearson_correlation = 1;
</pre><pre class="cython line score-4" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">093</span>:         <span class="k">elif</span> <span class="n">similarity</span> <span class="o">==</span> <span class="s">&quot;jaccard&quot;</span> <span class="ow">or</span> <span class="n">similarity</span> <span class="o">==</span> <span class="s">&quot;tanimoto&quot;</span><span class="p">:</span></pre>
<pre class='cython code score-4 '>  __pyx_t_7 = (<span class='pyx_c_api'>__Pyx_PyString_Equals</span>(__pyx_v_similarity, __pyx_n_s_jaccard, Py_EQ)); if (unlikely(__pyx_t_7 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 93, __pyx_L1_error)</span>
  if (!__pyx_t_7) {
  } else {
    __pyx_t_6 = __pyx_t_7;
    goto __pyx_L4_bool_binop_done;
  }
  __pyx_t_7 = (<span class='pyx_c_api'>__Pyx_PyString_Equals</span>(__pyx_v_similarity, __pyx_n_s_tanimoto, Py_EQ)); if (unlikely(__pyx_t_7 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 93, __pyx_L1_error)</span>
  __pyx_t_6 = __pyx_t_7;
  __pyx_L4_bool_binop_done:;
  if (__pyx_t_6) {
/* … */
    goto __pyx_L3;
  }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">094</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">tanimoto_coefficient</span> <span class="o">=</span> <span class="bp">True</span></pre>
<pre class='cython code score-0 '>    __pyx_v_self-&gt;tanimoto_coefficient = 1;
</pre><pre class="cython line score-0">&#xA0;<span class="">095</span>:             <span class="c"># Tanimoto has a specific kind of normalization</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">096</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="bp">False</span></pre>
<pre class='cython code score-0 '>    __pyx_v_self-&gt;normalize = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">097</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">098</span>:         <span class="k">elif</span> <span class="n">similarity</span> <span class="o">==</span> <span class="s">&quot;cosine&quot;</span><span class="p">:</span></pre>
<pre class='cython code score-2 '>  __pyx_t_6 = (<span class='pyx_c_api'>__Pyx_PyString_Equals</span>(__pyx_v_similarity, __pyx_n_s_cosine, Py_EQ)); if (unlikely(__pyx_t_6 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 98, __pyx_L1_error)</span>
  if (likely(__pyx_t_6)) {
    goto __pyx_L3;
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">099</span>:             <span class="k">pass</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">100</span>:         <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-6" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">101</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cosine_Similarity: value for paramether &#39;mode&#39; not recognized.&quot;</span></pre>
<pre class='cython code score-6 '>  /*else*/ {
/* … */
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_builtin_ValueError, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 101, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_2, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='error_goto'>__PYX_ERR(0, 101, __pyx_L1_error)</span>
  }
  __pyx_L3:;
</pre><pre class="cython line score-0">&#xA0;<span class="">102</span>:                              <span class="s">&quot; Allowed values are: &#39;cosine&#39;, &#39;pearson&#39;, &#39;adjusted&#39;, &#39;jaccard&#39;, &#39;tanimoto&#39;.&quot;</span></pre>
<pre class="cython line score-39" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">103</span>:                              <span class="s">&quot; Passed value was &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">similarity</span><span class="p">))</span></pre>
<pre class='cython code score-39 '>    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_kp_s_Cosine_Similarity_value_for_para, __pyx_n_s_format);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_3 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
      __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
      if (likely(__pyx_t_3)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_2, __pyx_v_similarity);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_2)) {
        PyObject *__pyx_temp[2] = {__pyx_t_3, __pyx_v_similarity};
        __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_2)) {
        PyObject *__pyx_temp[2] = {__pyx_t_3, __pyx_v_similarity};
        __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      } else
      #endif
      {
        __pyx_t_8 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 0, __pyx_t_3); __pyx_t_3 = NULL;
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_similarity);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_similarity);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 0+1, __pyx_v_similarity);
        __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_8, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">104</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">105</span>: </pre>
<pre class="cython line score-24" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">106</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">TopK</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">topK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">)</span></pre>
<pre class='cython code score-24 '>  __pyx_t_4 = __pyx_v_self-&gt;n_columns;
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_topK);
  __pyx_t_2 = __pyx_v_topK;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 106, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_3 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_8, __pyx_t_2, Py_LT); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 106, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_3); if (unlikely(__pyx_t_6 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 106, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  if (__pyx_t_6) {
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 106, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    __pyx_t_1 = __pyx_t_3;
    __pyx_t_3 = 0;
  } else {
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
    __pyx_t_1 = __pyx_t_2;
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyInt_As_int</span>(__pyx_t_1); if (unlikely((__pyx_t_5 == (int)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 106, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_self-&gt;TopK = __pyx_t_5;
</pre><pre class="cython line score-34" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">107</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-34 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_1);
  __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_8, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_9) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_3, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_9, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 107, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;this_item_weights, 0);
  __pyx_v_self-&gt;this_item_weights = __pyx_t_10;
  __pyx_t_10.memview = NULL;
  __pyx_t_10.data = NULL;
</pre><pre class="cython line score-34" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">108</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></pre>
<pre class='cython code score-34 '>  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_9, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_9);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_9);
  __pyx_t_9 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_int32);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_9, __pyx_n_s_dtype, __pyx_t_8) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_1, __pyx_t_3, __pyx_t_9);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_8, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_11.memview)) __PYX_ERR(0, 108, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;this_item_weights_id, 0);
  __pyx_v_self-&gt;this_item_weights_id = __pyx_t_11;
  __pyx_t_11.memview = NULL;
  __pyx_t_11.data = NULL;
</pre><pre class="cython line score-34" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">109</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></pre>
<pre class='cython code score-34 '>  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_8, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_8);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_8);
  __pyx_t_8 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_int32);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_8, __pyx_n_s_dtype, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_9, __pyx_t_3, __pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_2, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_11.memview)) __PYX_ERR(0, 109, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;this_item_weights_mask, 0);
  __pyx_v_self-&gt;this_item_weights_mask = __pyx_t_11;
  __pyx_t_11.memview = NULL;
  __pyx_t_11.data = NULL;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">110</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_counter</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  __pyx_v_self-&gt;this_item_weights_counter = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">111</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">112</span>:         <span class="c"># Copy data to avoid altering the original object</span></pre>
<pre class="cython line score-19" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">113</span>:         <span class="n">dataMatrix</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></pre>
<pre class='cython code score-19 '>  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_copy);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_3 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_8))) {
    __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_8);
    if (likely(__pyx_t_3)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_8);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_8, function);
    }
  }
  if (__pyx_t_3) {
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_8, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  } else {
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
  }
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_dataMatrix, __pyx_t_2);
  __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">114</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">115</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">116</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">117</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">118</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">119</span>:         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusted_cosine</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_6 = (__pyx_v_self-&gt;adjusted_cosine != 0);
  if (__pyx_t_6) {
/* … */
    goto __pyx_L6;
  }
</pre><pre class="cython line score-1" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">120</span>:             <span class="n">dataMatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyAdjustedCosine</span><span class="p">(</span><span class="n">dataMatrix</span><span class="p">)</span></pre>
<pre class='cython code score-1 '>    __pyx_t_2 = ((struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython *)__pyx_v_self-&gt;__pyx_vtab)-&gt;applyAdjustedCosine(__pyx_v_self, __pyx_v_dataMatrix);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 120, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_dataMatrix, __pyx_t_2);
    __pyx_t_2 = 0;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">121</span>:         <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pearson_correlation</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_6 = (__pyx_v_self-&gt;pearson_correlation != 0);
  if (__pyx_t_6) {
/* … */
    goto __pyx_L6;
  }
</pre><pre class="cython line score-1" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">122</span>:             <span class="n">dataMatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyPearsonCorrelation</span><span class="p">(</span><span class="n">dataMatrix</span><span class="p">)</span></pre>
<pre class='cython code score-1 '>    __pyx_t_2 = ((struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython *)__pyx_v_self-&gt;__pyx_vtab)-&gt;applyPearsonCorrelation(__pyx_v_self, __pyx_v_dataMatrix);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 122, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_dataMatrix, __pyx_t_2);
    __pyx_t_2 = 0;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">123</span>:         <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanimoto_coefficient</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_6 = (__pyx_v_self-&gt;tanimoto_coefficient != 0);
  if (__pyx_t_6) {
/* … */
  }
  __pyx_L6:;
</pre><pre class="cython line score-1" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">124</span>:             <span class="n">dataMatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">useOnlyBooleanInteractions</span><span class="p">(</span><span class="n">dataMatrix</span><span class="p">)</span></pre>
<pre class='cython code score-1 '>    __pyx_t_2 = ((struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython *)__pyx_v_self-&gt;__pyx_vtab)-&gt;useOnlyBooleanInteractions(__pyx_v_self, __pyx_v_dataMatrix);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 124, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_dataMatrix, __pyx_t_2);
    __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">125</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">126</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">127</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">128</span>:         <span class="c"># Compute sum of squared values to be used in normalization</span></pre>
<pre class="cython line score-75" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">129</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">sumOfSquared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataMatrix</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mf">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></pre>
<pre class='cython code score-75 '>  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_8, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_power);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_8, __pyx_tuple_, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_9, __pyx_n_s_sum);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_9, __pyx_n_s_axis, __pyx_int_0) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 129, __pyx_L1_error)</span>
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_8, __pyx_empty_tuple, __pyx_t_9);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 0, __pyx_t_1);
  __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_8, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_12) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_9, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_12, __pyx_n_s_ravel);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  __pyx_t_12 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_1))) {
    __pyx_t_12 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_1);
    if (likely(__pyx_t_12)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_12);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_1, function);
    }
  }
  if (__pyx_t_12) {
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_1, __pyx_t_12);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  } else {
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  }
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_2, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;sumOfSquared, 0);
  __pyx_v_self-&gt;sumOfSquared = __pyx_t_10;
  __pyx_t_10.memview = NULL;
  __pyx_t_10.data = NULL;
/* … */
  __pyx_tuple_ = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_int_2);<span class='error_goto'> if (unlikely(!__pyx_tuple_)) __PYX_ERR(0, 129, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple_);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple_);
</pre><pre class="cython line score-0">&#xA0;<span class="">130</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">131</span>:         <span class="c"># Tanimoto does not require the square root to be applied</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">132</span>:         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanimoto_coefficient</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_6 = ((!(__pyx_v_self-&gt;tanimoto_coefficient != 0)) != 0);
  if (__pyx_t_6) {
/* … */
  }
</pre><pre class="cython line score-52" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">133</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">sumOfSquared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sumOfSquared</span><span class="p">)</span></pre>
<pre class='cython code score-52 '>    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_sqrt);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    if (unlikely(!__pyx_v_self-&gt;sumOfSquared.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 133, __pyx_L1_error)</span>}
    __pyx_t_1 = __pyx_memoryview_fromslice(__pyx_v_self-&gt;sumOfSquared, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    __pyx_t_9 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_12))) {
      __pyx_t_9 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_12);
      if (likely(__pyx_t_9)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_12);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_9);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_12, function);
      }
    }
    if (!__pyx_t_9) {
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_12, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_12)) {
        PyObject *__pyx_temp[2] = {__pyx_t_9, __pyx_t_1};
        __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_12, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_12)) {
        PyObject *__pyx_temp[2] = {__pyx_t_9, __pyx_t_1};
        __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_12, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      } else
      #endif
      {
        __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_9); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_9); __pyx_t_9 = NULL;
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0+1, __pyx_t_1);
        __pyx_t_1 = 0;
        __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_12, __pyx_t_3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
    __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_2, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;sumOfSquared, 0);
    __pyx_v_self-&gt;sumOfSquared = __pyx_t_10;
    __pyx_t_10.memview = NULL;
    __pyx_t_10.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">134</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">135</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">136</span>:         <span class="c"># Apply weight after sumOfSquared has been computed but before the matrix is</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">137</span>:         <span class="c"># split in its inner data structures</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">138</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">use_row_weights</span> <span class="o">=</span> <span class="bp">False</span></pre>
<pre class='cython code score-0 '>  __pyx_v_self-&gt;use_row_weights = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">139</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">140</span>:         <span class="k">if</span> <span class="n">row_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_6 = (__pyx_v_row_weights != Py_None);
  __pyx_t_7 = (__pyx_t_6 != 0);
  if (__pyx_t_7) {
/* … */
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">141</span>: </pre>
<pre class="cython line score-25" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">142</span>:             <span class="k">if</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_weights</span><span class="p">):</span></pre>
<pre class='cython code score-25 '>    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 142, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_2, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 142, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_13 = <span class='py_c_api'>PyObject_Length</span>(__pyx_v_row_weights);<span class='error_goto'> if (unlikely(__pyx_t_13 == ((Py_ssize_t)-1))) __PYX_ERR(0, 142, __pyx_L1_error)</span>
    __pyx_t_2 = <span class='py_c_api'>PyInt_FromSsize_t</span>(__pyx_t_13);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 142, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_3 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_12, __pyx_t_2, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 142, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_3); if (unlikely(__pyx_t_7 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 142, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    if (unlikely(__pyx_t_7)) {
/* … */
    }
</pre><pre class="cython line score-6" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">143</span>:                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cosine_Similarity: provided row_weights and dataMatrix have different number of rows.&quot;</span></pre>
<pre class='cython code score-6 '>      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_builtin_ValueError, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 143, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_2, 0, 0, 0);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      <span class='error_goto'>__PYX_ERR(0, 143, __pyx_L1_error)</span>
</pre><pre class="cython line score-56" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">144</span>:                                  <span class="s">&quot;Row_weights has {} rows, dataMatrix has {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row_weights</span><span class="p">),</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span></pre>
<pre class='cython code score-56 '>      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_kp_s_Cosine_Similarity_provided_row_w, __pyx_n_s_format);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_13 = <span class='py_c_api'>PyObject_Length</span>(__pyx_v_row_weights);<span class='error_goto'> if (unlikely(__pyx_t_13 == ((Py_ssize_t)-1))) __PYX_ERR(0, 144, __pyx_L1_error)</span>
      __pyx_t_12 = <span class='py_c_api'>PyInt_FromSsize_t</span>(__pyx_t_13);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      __pyx_t_9 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_1 = NULL;
      __pyx_t_5 = 0;
      if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
        __pyx_t_1 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
        if (likely(__pyx_t_1)) {
          PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_1);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
          <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
          __pyx_t_5 = 1;
        }
      }
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_2)) {
        PyObject *__pyx_temp[3] = {__pyx_t_1, __pyx_t_12, __pyx_t_9};
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-__pyx_t_5, 2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_2)) {
        PyObject *__pyx_temp[3] = {__pyx_t_1, __pyx_t_12, __pyx_t_9};
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-__pyx_t_5, 2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
      } else
      #endif
      {
        __pyx_t_8 = <span class='py_c_api'>PyTuple_New</span>(2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
        if (__pyx_t_1) {
          <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 0, __pyx_t_1); __pyx_t_1 = NULL;
        }
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_12);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 0+__pyx_t_5, __pyx_t_12);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_9);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 1+__pyx_t_5, __pyx_t_9);
        __pyx_t_12 = 0;
        __pyx_t_9 = 0;
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_8, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
      }
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">145</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">146</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">147</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">use_row_weights</span> <span class="o">=</span> <span class="bp">True</span></pre>
<pre class='cython code score-0 '>    __pyx_v_self-&gt;use_row_weights = 1;
</pre><pre class="cython line score-33" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">148</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">row_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row_weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-33 '>    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_row_weights);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_row_weights);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_v_row_weights);
    __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
    __pyx_t_9 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_9, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_8, __pyx_n_s_dtype, __pyx_t_12) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_2, __pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
    __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_12, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
    __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;row_weights, 0);
    __pyx_v_self-&gt;row_weights = __pyx_t_10;
    __pyx_t_10.memview = NULL;
    __pyx_t_10.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">149</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">150</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">151</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">152</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">153</span>: </pre>
<pre class="cython line score-40" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">154</span>:         <span class="n">dataMatrix</span> <span class="o">=</span> <span class="n">check_matrix</span><span class="p">(</span><span class="n">dataMatrix</span><span class="p">,</span> <span class="s">&#39;csr&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-40 '>  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_check_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_2 = NULL;
  __pyx_t_5 = 0;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_8))) {
    __pyx_t_2 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_8);
    if (likely(__pyx_t_2)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_8);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_8, function);
      __pyx_t_5 = 1;
    }
  }
  #if CYTHON_FAST_PYCALL
  if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_8)) {
    PyObject *__pyx_temp[3] = {__pyx_t_2, __pyx_v_dataMatrix, __pyx_n_s_csr};
    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_8, __pyx_temp+1-__pyx_t_5, 2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  } else
  #endif
  #if CYTHON_FAST_PYCCALL
  if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_8)) {
    PyObject *__pyx_temp[3] = {__pyx_t_2, __pyx_v_dataMatrix, __pyx_n_s_csr};
    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_8, __pyx_temp+1-__pyx_t_5, 2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  } else
  #endif
  {
    __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    if (__pyx_t_2) {
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_2); __pyx_t_2 = NULL;
    }
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_dataMatrix);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0+__pyx_t_5, __pyx_v_dataMatrix);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s_csr);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s_csr);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 1+__pyx_t_5, __pyx_n_s_csr);
    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_8, __pyx_t_3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_dataMatrix, __pyx_t_12);
  __pyx_t_12 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">155</span>: </pre>
<pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">156</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">user_to_item_row_ptr</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">indptr</span></pre>
<pre class='cython code score-5 '>  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 156, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_12, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_11.memview)) __PYX_ERR(0, 156, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;user_to_item_row_ptr, 0);
  __pyx_v_self-&gt;user_to_item_row_ptr = __pyx_t_11;
  __pyx_t_11.memview = NULL;
  __pyx_t_11.data = NULL;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">157</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">user_to_item_cols</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">indices</span></pre>
<pre class='cython code score-5 '>  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indices);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 157, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_12, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_11.memview)) __PYX_ERR(0, 157, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;user_to_item_cols, 0);
  __pyx_v_self-&gt;user_to_item_cols = __pyx_t_11;
  __pyx_t_11.memview = NULL;
  __pyx_t_11.data = NULL;
</pre><pre class="cython line score-34" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">158</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">user_to_item_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataMatrix</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-34 '>  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_12, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_data);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_12);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_12);
  __pyx_t_12 = 0;
  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_12, __pyx_n_s_dtype, __pyx_t_9) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_8, __pyx_t_3, __pyx_t_12);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_9, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;user_to_item_data, 0);
  __pyx_v_self-&gt;user_to_item_data = __pyx_t_10;
  __pyx_t_10.memview = NULL;
  __pyx_t_10.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">159</span>: </pre>
<pre class="cython line score-40" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">160</span>:         <span class="n">dataMatrix</span> <span class="o">=</span> <span class="n">check_matrix</span><span class="p">(</span><span class="n">dataMatrix</span><span class="p">,</span> <span class="s">&#39;csc&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-40 '>  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_check_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 160, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  __pyx_t_3 = NULL;
  __pyx_t_5 = 0;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_12))) {
    __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_12);
    if (likely(__pyx_t_3)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_12);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_12, function);
      __pyx_t_5 = 1;
    }
  }
  #if CYTHON_FAST_PYCALL
  if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_12)) {
    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_dataMatrix, __pyx_n_s_csc};
    __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_12, __pyx_temp+1-__pyx_t_5, 2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 160, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  } else
  #endif
  #if CYTHON_FAST_PYCCALL
  if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_12)) {
    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_dataMatrix, __pyx_n_s_csc};
    __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_12, __pyx_temp+1-__pyx_t_5, 2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 160, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  } else
  #endif
  {
    __pyx_t_8 = <span class='py_c_api'>PyTuple_New</span>(2+__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 160, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
    if (__pyx_t_3) {
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 0, __pyx_t_3); __pyx_t_3 = NULL;
    }
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_dataMatrix);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 0+__pyx_t_5, __pyx_v_dataMatrix);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s_csc);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s_csc);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 1+__pyx_t_5, __pyx_n_s_csc);
    __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_12, __pyx_t_8, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 160, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_dataMatrix, __pyx_t_9);
  __pyx_t_9 = 0;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">161</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">item_to_user_rows</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">indices</span></pre>
<pre class='cython code score-5 '>  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indices);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 161, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_9, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_11.memview)) __PYX_ERR(0, 161, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;item_to_user_rows, 0);
  __pyx_v_self-&gt;item_to_user_rows = __pyx_t_11;
  __pyx_t_11.memview = NULL;
  __pyx_t_11.data = NULL;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">162</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">item_to_user_col_ptr</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">indptr</span></pre>
<pre class='cython code score-5 '>  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 162, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_9, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_11.memview)) __PYX_ERR(0, 162, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;item_to_user_col_ptr, 0);
  __pyx_v_self-&gt;item_to_user_col_ptr = __pyx_t_11;
  __pyx_t_11.memview = NULL;
  __pyx_t_11.data = NULL;
</pre><pre class="cython line score-34" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">163</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">item_to_user_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataMatrix</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-34 '>  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_9, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_data);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_8 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_9);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_8, 0, __pyx_t_9);
  __pyx_t_9 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_9, __pyx_n_s_dtype, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_12, __pyx_t_8, __pyx_t_9);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_2, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;item_to_user_data, 0);
  __pyx_v_self-&gt;item_to_user_data = __pyx_t_10;
  __pyx_t_10.memview = NULL;
  __pyx_t_10.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">164</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">165</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">166</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">167</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">168</span>:         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TopK</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_7 = ((__pyx_v_self-&gt;TopK == 0) != 0);
  if (__pyx_t_7) {
/* … */
  }
</pre><pre class="cython line score-58" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">169</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">W_dense</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">))</span></pre>
<pre class='cython code score-58 '>    __pyx_t_9 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
    __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_9, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
    __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_12);
    __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_9);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_9);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_12);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 1, __pyx_t_12);
    __pyx_t_9 = 0;
    __pyx_t_12 = 0;
    __pyx_t_12 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_8))) {
      __pyx_t_12 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_8);
      if (likely(__pyx_t_12)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_8);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_12);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_8, function);
      }
    }
    if (!__pyx_t_12) {
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_8, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_8)) {
        PyObject *__pyx_temp[2] = {__pyx_t_12, __pyx_t_3};
        __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_8, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_8)) {
        PyObject *__pyx_temp[2] = {__pyx_t_12, __pyx_t_3};
        __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_8, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_12); __pyx_t_12 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      } else
      #endif
      {
        __pyx_t_9 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_12); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 0, __pyx_t_12); __pyx_t_12 = NULL;
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_8, __pyx_t_9, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
    __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_2, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_14.memview)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __PYX_XDEC_MEMVIEW(&amp;__pyx_v_self-&gt;W_dense, 0);
    __pyx_v_self-&gt;W_dense = __pyx_t_14;
    __pyx_t_14.memview = NULL;
    __pyx_t_14.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">170</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">171</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">172</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">173</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">174</span>: </pre>
<pre class="cython line score-3" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">175</span>:     <span class="k">cdef</span> <span class="nf">useOnlyBooleanInteractions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataMatrix</span><span class="p">):</span></pre>
<pre class='cython code score-3 '>static PyObject *__pyx_f_25Compute_Similarity_Cython_25Compute_Similarity_Cython_useOnlyBooleanInteractions(CYTHON_UNUSED struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_v_self, PyObject *__pyx_v_dataMatrix) {
  long __pyx_v_index;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("useOnlyBooleanInteractions", 0);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.useOnlyBooleanInteractions", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">176</span>:         <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">177</span>: <span class="sd">        Set to 1 all data points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">178</span>: <span class="sd">        :return:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">179</span>: <span class="sd">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">180</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">181</span>:         <span class="k">cdef</span> <span class="kt">long</span> <span class="nf">index</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">182</span>: </pre>
<pre class="cython line score-8" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">183</span>:         <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataMatrix</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span></pre>
<pre class='cython code score-8 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_data);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 183, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='py_c_api'>PyObject_Length</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(__pyx_t_2 == ((Py_ssize_t)-1))) __PYX_ERR(0, 183, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_3 = __pyx_t_2;
  for (__pyx_t_4 = 0; __pyx_t_4 &lt; __pyx_t_3; __pyx_t_4+=1) {
    __pyx_v_index = __pyx_t_4;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">184</span>:             <span class="n">dataMatrix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1</span></pre>
<pre class='cython code score-5 '>    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_data);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 184, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    if (unlikely(<span class='pyx_c_api'>__Pyx_SetItemInt</span>(__pyx_t_1, __pyx_v_index, __pyx_int_1, long, 1, __Pyx_PyInt_From_long, 0, 1, 1) &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 184, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">185</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">186</span>:         <span class="k">return</span> <span class="n">dataMatrix</span></pre>
<pre class='cython code score-2 '>  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
  __pyx_r = __pyx_v_dataMatrix;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">187</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">188</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">189</span>: </pre>
<pre class="cython line score-10" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">190</span>:     <span class="k">cdef</span> <span class="nf">applyPearsonCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataMatrix</span><span class="p">):</span></pre>
<pre class='cython code score-10 '>static PyObject *__pyx_f_25Compute_Similarity_Cython_25Compute_Similarity_Cython_applyPearsonCorrelation(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_v_self, PyObject *__pyx_v_dataMatrix) {
  __Pyx_memviewslice __pyx_v_sumPerCol = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_interactionsPerCol = { 0, 0, { 0 }, { 0 }, { 0 } };
  long __pyx_v_colIndex;
  long __pyx_v_innerIndex;
  long __pyx_v_start_pos;
  long __pyx_v_end_pos;
  double __pyx_v_colAverage;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("applyPearsonCorrelation", 0);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_7);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_8, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.applyPearsonCorrelation", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_sumPerCol, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_interactionsPerCol, 1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_dataMatrix);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">191</span>:         <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">192</span>: <span class="sd">        Remove from every data point the average for the corresponding column</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">193</span>: <span class="sd">        :return:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">194</span>: <span class="sd">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">195</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">196</span>:         <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">sumPerCol</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">197</span>:         <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">interactionsPerCol</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">198</span>:         <span class="k">cdef</span> <span class="kt">long</span> <span class="nf">colIndex</span><span class="p">,</span> <span class="nf">innerIndex</span><span class="p">,</span> <span class="nf">start_pos</span><span class="p">,</span> <span class="nf">end_pos</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">199</span>:         <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">colAverage</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">200</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">201</span>: </pre>
<pre class="cython line score-40" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">202</span>:         <span class="n">dataMatrix</span> <span class="o">=</span> <span class="n">check_matrix</span><span class="p">(</span><span class="n">dataMatrix</span><span class="p">,</span> <span class="s">&#39;csc&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-40 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_check_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = NULL;
  __pyx_t_4 = 0;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
    __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
      __pyx_t_4 = 1;
    }
  }
  #if CYTHON_FAST_PYCALL
  if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_2)) {
    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_dataMatrix, __pyx_n_s_csc};
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else
  #endif
  #if CYTHON_FAST_PYCCALL
  if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_2)) {
    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_dataMatrix, __pyx_n_s_csc};
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else
  #endif
  {
    __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    if (__pyx_t_3) {
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
    }
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_dataMatrix);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+__pyx_t_4, __pyx_v_dataMatrix);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s_csc);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s_csc);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 1+__pyx_t_4, __pyx_n_s_csc);
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_dataMatrix, __pyx_t_1);
  __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">203</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">204</span>: </pre>
<pre class="cython line score-64" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">205</span>:         <span class="n">sumPerCol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataMatrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mf">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></pre>
<pre class='cython code score-64 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_sum);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_axis, __pyx_int_0) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 205, __pyx_L1_error)</span>
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_6);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_6);
  __pyx_t_6 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_6, __pyx_n_s_dtype, __pyx_t_7) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_5, __pyx_t_3, __pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_7, __pyx_n_s_ravel);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_6))) {
    __pyx_t_7 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_6);
    if (likely(__pyx_t_7)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_6);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_7);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_6, function);
    }
  }
  if (__pyx_t_7) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_6, __pyx_t_7);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  } else {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  }
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_8.memview)) __PYX_ERR(0, 205, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_sumPerCol = __pyx_t_8;
  __pyx_t_8.memview = NULL;
  __pyx_t_8.data = NULL;
</pre><pre class="cython line score-49" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">206</span>:         <span class="n">interactionsPerCol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dataMatrix</span><span class="o">.</span><span class="n">indptr</span><span class="p">)</span></pre>
<pre class='cython code score-49 '>  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_6, __pyx_n_s_diff);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  __pyx_t_3 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_7))) {
    __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_7);
    if (likely(__pyx_t_3)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_7);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_7, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_7, __pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else {
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_7)) {
      PyObject *__pyx_temp[2] = {__pyx_t_3, __pyx_t_6};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_7, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_7)) {
      PyObject *__pyx_temp[2] = {__pyx_t_3, __pyx_t_6};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_7, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    } else
    #endif
    {
      __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_6);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+1, __pyx_t_6);
      __pyx_t_6 = 0;
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_7, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    }
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_9.memview)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_interactionsPerCol = __pyx_t_9;
  __pyx_t_9.memview = NULL;
  __pyx_t_9.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">207</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">208</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">209</span>:         <span class="c">#Remove for every row the corresponding average</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">210</span>:         <span class="k">for</span> <span class="n">colIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>  __pyx_t_10 = __pyx_v_self-&gt;n_columns;
  __pyx_t_11 = __pyx_t_10;
  for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_11; __pyx_t_12+=1) {
    __pyx_v_colIndex = __pyx_t_12;
</pre><pre class="cython line score-0">&#xA0;<span class="">211</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">212</span>:             <span class="k">if</span> <span class="n">interactionsPerCol</span><span class="p">[</span><span class="n">colIndex</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-2 '>    __pyx_t_13 = __pyx_v_colIndex;
    __pyx_t_4 = -1;
    if (__pyx_t_13 &lt; 0) {
      __pyx_t_13 += __pyx_v_interactionsPerCol.shape[0];
      if (unlikely(__pyx_t_13 &lt; 0)) __pyx_t_4 = 0;
    } else if (unlikely(__pyx_t_13 &gt;= __pyx_v_interactionsPerCol.shape[0])) __pyx_t_4 = 0;
    if (unlikely(__pyx_t_4 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_4);
      <span class='error_goto'>__PYX_ERR(0, 212, __pyx_L1_error)</span>
    }
    __pyx_t_14 = (((*((int *) ( /* dim=0 */ (__pyx_v_interactionsPerCol.data + __pyx_t_13 * __pyx_v_interactionsPerCol.strides[0]) ))) &gt; 0) != 0);
    if (__pyx_t_14) {
/* … */
    }
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">213</span>: </pre>
<pre class="cython line score-9" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">214</span>:                 <span class="n">colAverage</span> <span class="o">=</span> <span class="n">sumPerCol</span><span class="p">[</span><span class="n">colIndex</span><span class="p">]</span> <span class="o">/</span> <span class="n">interactionsPerCol</span><span class="p">[</span><span class="n">colIndex</span><span class="p">]</span></pre>
<pre class='cython code score-9 '>      __pyx_t_15 = __pyx_v_colIndex;
      __pyx_t_4 = -1;
      if (__pyx_t_15 &lt; 0) {
        __pyx_t_15 += __pyx_v_sumPerCol.shape[0];
        if (unlikely(__pyx_t_15 &lt; 0)) __pyx_t_4 = 0;
      } else if (unlikely(__pyx_t_15 &gt;= __pyx_v_sumPerCol.shape[0])) __pyx_t_4 = 0;
      if (unlikely(__pyx_t_4 != -1)) {
        <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_4);
        <span class='error_goto'>__PYX_ERR(0, 214, __pyx_L1_error)</span>
      }
      __pyx_t_16 = (*((double *) ( /* dim=0 */ (__pyx_v_sumPerCol.data + __pyx_t_15 * __pyx_v_sumPerCol.strides[0]) )));
      __pyx_t_17 = __pyx_v_colIndex;
      __pyx_t_4 = -1;
      if (__pyx_t_17 &lt; 0) {
        __pyx_t_17 += __pyx_v_interactionsPerCol.shape[0];
        if (unlikely(__pyx_t_17 &lt; 0)) __pyx_t_4 = 0;
      } else if (unlikely(__pyx_t_17 &gt;= __pyx_v_interactionsPerCol.shape[0])) __pyx_t_4 = 0;
      if (unlikely(__pyx_t_4 != -1)) {
        <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_4);
        <span class='error_goto'>__PYX_ERR(0, 214, __pyx_L1_error)</span>
      }
      __pyx_t_4 = (*((int *) ( /* dim=0 */ (__pyx_v_interactionsPerCol.data + __pyx_t_17 * __pyx_v_interactionsPerCol.strides[0]) )));
      if (unlikely(__pyx_t_4 == 0)) {
        <span class='py_c_api'>PyErr_SetString</span>(PyExc_ZeroDivisionError, "float division");
        <span class='error_goto'>__PYX_ERR(0, 214, __pyx_L1_error)</span>
      }
      __pyx_v_colAverage = (__pyx_t_16 / __pyx_t_4);
</pre><pre class="cython line score-0">&#xA0;<span class="">215</span>: </pre>
<pre class="cython line score-13" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">216</span>:                 <span class="n">start_pos</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">colIndex</span><span class="p">]</span></pre>
<pre class='cython code score-13 '>      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 216, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, __pyx_v_colIndex, long, 1, __Pyx_PyInt_From_long, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 216, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_18 = <span class='pyx_c_api'>__Pyx_PyInt_As_long</span>(__pyx_t_7); if (unlikely((__pyx_t_18 == (long)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 216, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_v_start_pos = __pyx_t_18;
</pre><pre class="cython line score-13" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">217</span>:                 <span class="n">end_pos</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">colIndex</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-13 '>      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 217, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
      __pyx_t_18 = (__pyx_v_colIndex + 1);
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_7, __pyx_t_18, long, 1, __Pyx_PyInt_From_long, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 217, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_18 = <span class='pyx_c_api'>__Pyx_PyInt_As_long</span>(__pyx_t_1); if (unlikely((__pyx_t_18 == (long)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 217, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_v_end_pos = __pyx_t_18;
</pre><pre class="cython line score-0">&#xA0;<span class="">218</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">219</span>:                 <span class="n">innerIndex</span> <span class="o">=</span> <span class="n">start_pos</span></pre>
<pre class='cython code score-0 '>      __pyx_v_innerIndex = __pyx_v_start_pos;
</pre><pre class="cython line score-0">&#xA0;<span class="">220</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">221</span>:                 <span class="k">while</span> <span class="n">innerIndex</span> <span class="o">&lt;</span> <span class="n">end_pos</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>      while (1) {
        __pyx_t_14 = ((__pyx_v_innerIndex &lt; __pyx_v_end_pos) != 0);
        if (!__pyx_t_14) break;
</pre><pre class="cython line score-0">&#xA0;<span class="">222</span>: </pre>
<pre class="cython line score-20" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">223</span>:                     <span class="n">dataMatrix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">innerIndex</span><span class="p">]</span> <span class="o">-=</span> <span class="n">colAverage</span></pre>
<pre class='cython code score-20 '>        __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_data);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 223, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
        __pyx_t_18 = __pyx_v_innerIndex;
        __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, __pyx_t_18, long, 1, __Pyx_PyInt_From_long, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 223, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
        __pyx_t_5 = <span class='py_c_api'>PyFloat_FromDouble</span>(__pyx_v_colAverage);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 223, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        __pyx_t_6 = <span class='py_c_api'>PyNumber_InPlaceSubtract</span>(__pyx_t_7, __pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 223, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        if (unlikely(<span class='pyx_c_api'>__Pyx_SetItemInt</span>(__pyx_t_1, __pyx_t_18, __pyx_t_6, long, 1, __Pyx_PyInt_From_long, 0, 1, 1) &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 223, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">224</span>:                     <span class="n">innerIndex</span><span class="o">+=</span><span class="mf">1</span></pre>
<pre class='cython code score-0 '>        __pyx_v_innerIndex = (__pyx_v_innerIndex + 1);
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">225</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">226</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">227</span>:         <span class="k">return</span> <span class="n">dataMatrix</span></pre>
<pre class='cython code score-2 '>  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
  __pyx_r = __pyx_v_dataMatrix;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">228</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">229</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">230</span>: </pre>
<pre class="cython line score-10" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">231</span>:     <span class="k">cdef</span> <span class="nf">applyAdjustedCosine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataMatrix</span><span class="p">):</span></pre>
<pre class='cython code score-10 '>static PyObject *__pyx_f_25Compute_Similarity_Cython_25Compute_Similarity_Cython_applyAdjustedCosine(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_v_self, PyObject *__pyx_v_dataMatrix) {
  __Pyx_memviewslice __pyx_v_sumPerRow = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_interactionsPerRow = { 0, 0, { 0 }, { 0 }, { 0 } };
  long __pyx_v_rowIndex;
  long __pyx_v_innerIndex;
  long __pyx_v_start_pos;
  long __pyx_v_end_pos;
  double __pyx_v_rowAverage;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("applyAdjustedCosine", 0);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_7);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_8, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.applyAdjustedCosine", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_sumPerRow, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_interactionsPerRow, 1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_dataMatrix);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">232</span>:         <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">233</span>: <span class="sd">        Remove from every data point the average for the corresponding row</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">234</span>: <span class="sd">        :return:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">235</span>: <span class="sd">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">236</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">237</span>:         <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">sumPerRow</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">238</span>:         <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">interactionsPerRow</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">239</span>:         <span class="k">cdef</span> <span class="kt">long</span> <span class="nf">rowIndex</span><span class="p">,</span> <span class="nf">innerIndex</span><span class="p">,</span> <span class="nf">start_pos</span><span class="p">,</span> <span class="nf">end_pos</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">240</span>:         <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">rowAverage</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">241</span>: </pre>
<pre class="cython line score-40" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">242</span>:         <span class="n">dataMatrix</span> <span class="o">=</span> <span class="n">check_matrix</span><span class="p">(</span><span class="n">dataMatrix</span><span class="p">,</span> <span class="s">&#39;csr&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-40 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_check_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 242, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = NULL;
  __pyx_t_4 = 0;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
    __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
      __pyx_t_4 = 1;
    }
  }
  #if CYTHON_FAST_PYCALL
  if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_2)) {
    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_dataMatrix, __pyx_n_s_csr};
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 242, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else
  #endif
  #if CYTHON_FAST_PYCCALL
  if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_2)) {
    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_dataMatrix, __pyx_n_s_csr};
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 242, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else
  #endif
  {
    __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 242, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    if (__pyx_t_3) {
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
    }
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_dataMatrix);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+__pyx_t_4, __pyx_v_dataMatrix);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s_csr);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s_csr);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 1+__pyx_t_4, __pyx_n_s_csr);
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 242, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_dataMatrix, __pyx_t_1);
  __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">243</span>: </pre>
<pre class="cython line score-64" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">244</span>:         <span class="n">sumPerRow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataMatrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mf">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></pre>
<pre class='cython code score-64 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_sum);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_axis, __pyx_int_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 244, __pyx_L1_error)</span>
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_6);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_6);
  __pyx_t_6 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_6, __pyx_n_s_dtype, __pyx_t_7) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_5, __pyx_t_3, __pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_7, __pyx_n_s_ravel);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_6))) {
    __pyx_t_7 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_6);
    if (likely(__pyx_t_7)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_6);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_7);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_6, function);
    }
  }
  if (__pyx_t_7) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_6, __pyx_t_7);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  } else {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  }
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_8.memview)) __PYX_ERR(0, 244, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_sumPerRow = __pyx_t_8;
  __pyx_t_8.memview = NULL;
  __pyx_t_8.data = NULL;
</pre><pre class="cython line score-49" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">245</span>:         <span class="n">interactionsPerRow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dataMatrix</span><span class="o">.</span><span class="n">indptr</span><span class="p">)</span></pre>
<pre class='cython code score-49 '>  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_6, __pyx_n_s_diff);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
  __pyx_t_3 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_7))) {
    __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_7);
    if (likely(__pyx_t_3)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_7);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_7, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_7, __pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else {
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_7)) {
      PyObject *__pyx_temp[2] = {__pyx_t_3, __pyx_t_6};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_7, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_7)) {
      PyObject *__pyx_temp[2] = {__pyx_t_3, __pyx_t_6};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_7, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    } else
    #endif
    {
      __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_6);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+1, __pyx_t_6);
      __pyx_t_6 = 0;
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_7, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    }
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_9.memview)) __PYX_ERR(0, 245, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_interactionsPerRow = __pyx_t_9;
  __pyx_t_9.memview = NULL;
  __pyx_t_9.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">246</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">247</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">248</span>:         <span class="c">#Remove for every row the corresponding average</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">249</span>:         <span class="k">for</span> <span class="n">rowIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rows</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>  __pyx_t_10 = __pyx_v_self-&gt;n_rows;
  __pyx_t_11 = __pyx_t_10;
  for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_11; __pyx_t_12+=1) {
    __pyx_v_rowIndex = __pyx_t_12;
</pre><pre class="cython line score-0">&#xA0;<span class="">250</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">251</span>:             <span class="k">if</span> <span class="n">interactionsPerRow</span><span class="p">[</span><span class="n">rowIndex</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-2 '>    __pyx_t_13 = __pyx_v_rowIndex;
    __pyx_t_4 = -1;
    if (__pyx_t_13 &lt; 0) {
      __pyx_t_13 += __pyx_v_interactionsPerRow.shape[0];
      if (unlikely(__pyx_t_13 &lt; 0)) __pyx_t_4 = 0;
    } else if (unlikely(__pyx_t_13 &gt;= __pyx_v_interactionsPerRow.shape[0])) __pyx_t_4 = 0;
    if (unlikely(__pyx_t_4 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_4);
      <span class='error_goto'>__PYX_ERR(0, 251, __pyx_L1_error)</span>
    }
    __pyx_t_14 = (((*((int *) ( /* dim=0 */ (__pyx_v_interactionsPerRow.data + __pyx_t_13 * __pyx_v_interactionsPerRow.strides[0]) ))) &gt; 0) != 0);
    if (__pyx_t_14) {
/* … */
    }
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">252</span>: </pre>
<pre class="cython line score-9" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">253</span>:                 <span class="n">rowAverage</span> <span class="o">=</span> <span class="n">sumPerRow</span><span class="p">[</span><span class="n">rowIndex</span><span class="p">]</span> <span class="o">/</span> <span class="n">interactionsPerRow</span><span class="p">[</span><span class="n">rowIndex</span><span class="p">]</span></pre>
<pre class='cython code score-9 '>      __pyx_t_15 = __pyx_v_rowIndex;
      __pyx_t_4 = -1;
      if (__pyx_t_15 &lt; 0) {
        __pyx_t_15 += __pyx_v_sumPerRow.shape[0];
        if (unlikely(__pyx_t_15 &lt; 0)) __pyx_t_4 = 0;
      } else if (unlikely(__pyx_t_15 &gt;= __pyx_v_sumPerRow.shape[0])) __pyx_t_4 = 0;
      if (unlikely(__pyx_t_4 != -1)) {
        <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_4);
        <span class='error_goto'>__PYX_ERR(0, 253, __pyx_L1_error)</span>
      }
      __pyx_t_16 = (*((double *) ( /* dim=0 */ (__pyx_v_sumPerRow.data + __pyx_t_15 * __pyx_v_sumPerRow.strides[0]) )));
      __pyx_t_17 = __pyx_v_rowIndex;
      __pyx_t_4 = -1;
      if (__pyx_t_17 &lt; 0) {
        __pyx_t_17 += __pyx_v_interactionsPerRow.shape[0];
        if (unlikely(__pyx_t_17 &lt; 0)) __pyx_t_4 = 0;
      } else if (unlikely(__pyx_t_17 &gt;= __pyx_v_interactionsPerRow.shape[0])) __pyx_t_4 = 0;
      if (unlikely(__pyx_t_4 != -1)) {
        <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_4);
        <span class='error_goto'>__PYX_ERR(0, 253, __pyx_L1_error)</span>
      }
      __pyx_t_4 = (*((int *) ( /* dim=0 */ (__pyx_v_interactionsPerRow.data + __pyx_t_17 * __pyx_v_interactionsPerRow.strides[0]) )));
      if (unlikely(__pyx_t_4 == 0)) {
        <span class='py_c_api'>PyErr_SetString</span>(PyExc_ZeroDivisionError, "float division");
        <span class='error_goto'>__PYX_ERR(0, 253, __pyx_L1_error)</span>
      }
      __pyx_v_rowAverage = (__pyx_t_16 / __pyx_t_4);
</pre><pre class="cython line score-0">&#xA0;<span class="">254</span>: </pre>
<pre class="cython line score-13" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">255</span>:                 <span class="n">start_pos</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">rowIndex</span><span class="p">]</span></pre>
<pre class='cython code score-13 '>      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 255, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, __pyx_v_rowIndex, long, 1, __Pyx_PyInt_From_long, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 255, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_18 = <span class='pyx_c_api'>__Pyx_PyInt_As_long</span>(__pyx_t_7); if (unlikely((__pyx_t_18 == (long)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 255, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_v_start_pos = __pyx_t_18;
</pre><pre class="cython line score-13" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">256</span>:                 <span class="n">end_pos</span> <span class="o">=</span> <span class="n">dataMatrix</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">rowIndex</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-13 '>      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 256, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
      __pyx_t_18 = (__pyx_v_rowIndex + 1);
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_7, __pyx_t_18, long, 1, __Pyx_PyInt_From_long, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 256, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_18 = <span class='pyx_c_api'>__Pyx_PyInt_As_long</span>(__pyx_t_1); if (unlikely((__pyx_t_18 == (long)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 256, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_v_end_pos = __pyx_t_18;
</pre><pre class="cython line score-0">&#xA0;<span class="">257</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">258</span>:                 <span class="n">innerIndex</span> <span class="o">=</span> <span class="n">start_pos</span></pre>
<pre class='cython code score-0 '>      __pyx_v_innerIndex = __pyx_v_start_pos;
</pre><pre class="cython line score-0">&#xA0;<span class="">259</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">260</span>:                 <span class="k">while</span> <span class="n">innerIndex</span> <span class="o">&lt;</span> <span class="n">end_pos</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>      while (1) {
        __pyx_t_14 = ((__pyx_v_innerIndex &lt; __pyx_v_end_pos) != 0);
        if (!__pyx_t_14) break;
</pre><pre class="cython line score-0">&#xA0;<span class="">261</span>: </pre>
<pre class="cython line score-20" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">262</span>:                     <span class="n">dataMatrix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">innerIndex</span><span class="p">]</span> <span class="o">-=</span> <span class="n">rowAverage</span></pre>
<pre class='cython code score-20 '>        __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_dataMatrix, __pyx_n_s_data);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 262, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
        __pyx_t_18 = __pyx_v_innerIndex;
        __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, __pyx_t_18, long, 1, __Pyx_PyInt_From_long, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 262, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
        __pyx_t_5 = <span class='py_c_api'>PyFloat_FromDouble</span>(__pyx_v_rowAverage);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 262, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        __pyx_t_6 = <span class='py_c_api'>PyNumber_InPlaceSubtract</span>(__pyx_t_7, __pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 262, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        if (unlikely(<span class='pyx_c_api'>__Pyx_SetItemInt</span>(__pyx_t_1, __pyx_t_18, __pyx_t_6, long, 1, __Pyx_PyInt_From_long, 0, 1, 1) &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 262, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">263</span>:                     <span class="n">innerIndex</span><span class="o">+=</span><span class="mf">1</span></pre>
<pre class='cython code score-0 '>        __pyx_v_innerIndex = (__pyx_v_innerIndex + 1);
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">264</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">265</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">266</span>:         <span class="k">return</span> <span class="n">dataMatrix</span></pre>
<pre class='cython code score-2 '>  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dataMatrix);
  __pyx_r = __pyx_v_dataMatrix;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">267</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">268</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">269</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">270</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">271</span>: </pre>
<pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">272</span>:     <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">getUsersThatRatedItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">long</span> <span class="n">item_id</span><span class="p">):</span></pre>
<pre class='cython code score-7 '>static __Pyx_memviewslice __pyx_f_25Compute_Similarity_Cython_25Compute_Similarity_Cython_getUsersThatRatedItem(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_v_self, long __pyx_v_item_id) {
  __Pyx_memviewslice __pyx_r = { 0, 0, { 0 }, { 0 }, { 0 } };
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("getUsersThatRatedItem", 0);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_4, 1);
  __pyx_r.data = NULL;
  __pyx_r.memview = NULL;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.getUsersThatRatedItem", __pyx_clineno, __pyx_lineno, __pyx_filename);

  goto __pyx_L2;
  __pyx_L0:;
  if (unlikely(!__pyx_r.memview)) {
    <span class='py_c_api'>PyErr_SetString</span>(PyExc_TypeError, "Memoryview return value is not initialized");
  }
  __pyx_L2:;
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-19" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">273</span>:         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_to_user_rows</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_to_user_col_ptr</span><span class="p">[</span><span class="n">item_id</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">item_to_user_col_ptr</span><span class="p">[</span><span class="n">item_id</span><span class="o">+</span><span class="mf">1</span><span class="p">]]</span></pre>
<pre class='cython code score-19 '>  if (unlikely(!__pyx_v_self-&gt;item_to_user_rows.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 273, __pyx_L1_error)</span>}
  if (unlikely(!__pyx_v_self-&gt;item_to_user_col_ptr.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 273, __pyx_L1_error)</span>}
  __pyx_t_1 = __pyx_v_item_id;
  __pyx_t_2 = -1;
  if (__pyx_t_1 &lt; 0) {
    __pyx_t_1 += __pyx_v_self-&gt;item_to_user_col_ptr.shape[0];
    if (unlikely(__pyx_t_1 &lt; 0)) __pyx_t_2 = 0;
  } else if (unlikely(__pyx_t_1 &gt;= __pyx_v_self-&gt;item_to_user_col_ptr.shape[0])) __pyx_t_2 = 0;
  if (unlikely(__pyx_t_2 != -1)) {
    <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
    <span class='error_goto'>__PYX_ERR(0, 273, __pyx_L1_error)</span>
  }
  if (unlikely(!__pyx_v_self-&gt;item_to_user_col_ptr.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 273, __pyx_L1_error)</span>}
  __pyx_t_3 = (__pyx_v_item_id + 1);
  __pyx_t_2 = -1;
  if (__pyx_t_3 &lt; 0) {
    __pyx_t_3 += __pyx_v_self-&gt;item_to_user_col_ptr.shape[0];
    if (unlikely(__pyx_t_3 &lt; 0)) __pyx_t_2 = 0;
  } else if (unlikely(__pyx_t_3 &gt;= __pyx_v_self-&gt;item_to_user_col_ptr.shape[0])) __pyx_t_2 = 0;
  if (unlikely(__pyx_t_2 != -1)) {
    <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
    <span class='error_goto'>__PYX_ERR(0, 273, __pyx_L1_error)</span>
  }
  __pyx_t_4.data = __pyx_v_self-&gt;item_to_user_rows.data;
  __pyx_t_4.memview = __pyx_v_self-&gt;item_to_user_rows.memview;
  __PYX_INC_MEMVIEW(&amp;__pyx_t_4, 0);
  __pyx_t_2 = -1;
  if (unlikely(__pyx_memoryview_slice_memviewslice(
    &amp;__pyx_t_4,
    __pyx_v_self-&gt;item_to_user_rows.shape[0], __pyx_v_self-&gt;item_to_user_rows.strides[0], __pyx_v_self-&gt;item_to_user_rows.suboffsets[0],
    0,
    0,
    &amp;__pyx_t_2,
    (*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;item_to_user_col_ptr.data + __pyx_t_1 * __pyx_v_self-&gt;item_to_user_col_ptr.strides[0]) ))),
    (*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;item_to_user_col_ptr.data + __pyx_t_3 * __pyx_v_self-&gt;item_to_user_col_ptr.strides[0]) ))),
    0,
    1,
    1,
    0,
    1) &lt; 0))
{
    <span class='error_goto'>__PYX_ERR(0, 273, __pyx_L1_error)</span>
}

__pyx_r = __pyx_t_4;
  __pyx_t_4.memview = NULL;
  __pyx_t_4.data = NULL;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">274</span>: </pre>
<pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">275</span>:     <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">getItemsRatedByUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">long</span> <span class="n">user_id</span><span class="p">):</span></pre>
<pre class='cython code score-7 '>static __Pyx_memviewslice __pyx_f_25Compute_Similarity_Cython_25Compute_Similarity_Cython_getItemsRatedByUser(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_v_self, long __pyx_v_user_id) {
  __Pyx_memviewslice __pyx_r = { 0, 0, { 0 }, { 0 }, { 0 } };
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("getItemsRatedByUser", 0);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_4, 1);
  __pyx_r.data = NULL;
  __pyx_r.memview = NULL;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.getItemsRatedByUser", __pyx_clineno, __pyx_lineno, __pyx_filename);

  goto __pyx_L2;
  __pyx_L0:;
  if (unlikely(!__pyx_r.memview)) {
    <span class='py_c_api'>PyErr_SetString</span>(PyExc_TypeError, "Memoryview return value is not initialized");
  }
  __pyx_L2:;
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-19" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">276</span>:         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_item_cols</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_to_item_row_ptr</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">user_to_item_row_ptr</span><span class="p">[</span><span class="n">user_id</span><span class="o">+</span><span class="mf">1</span><span class="p">]]</span></pre>
<pre class='cython code score-19 '>  if (unlikely(!__pyx_v_self-&gt;user_to_item_cols.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 276, __pyx_L1_error)</span>}
  if (unlikely(!__pyx_v_self-&gt;user_to_item_row_ptr.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 276, __pyx_L1_error)</span>}
  __pyx_t_1 = __pyx_v_user_id;
  __pyx_t_2 = -1;
  if (__pyx_t_1 &lt; 0) {
    __pyx_t_1 += __pyx_v_self-&gt;user_to_item_row_ptr.shape[0];
    if (unlikely(__pyx_t_1 &lt; 0)) __pyx_t_2 = 0;
  } else if (unlikely(__pyx_t_1 &gt;= __pyx_v_self-&gt;user_to_item_row_ptr.shape[0])) __pyx_t_2 = 0;
  if (unlikely(__pyx_t_2 != -1)) {
    <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
    <span class='error_goto'>__PYX_ERR(0, 276, __pyx_L1_error)</span>
  }
  if (unlikely(!__pyx_v_self-&gt;user_to_item_row_ptr.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 276, __pyx_L1_error)</span>}
  __pyx_t_3 = (__pyx_v_user_id + 1);
  __pyx_t_2 = -1;
  if (__pyx_t_3 &lt; 0) {
    __pyx_t_3 += __pyx_v_self-&gt;user_to_item_row_ptr.shape[0];
    if (unlikely(__pyx_t_3 &lt; 0)) __pyx_t_2 = 0;
  } else if (unlikely(__pyx_t_3 &gt;= __pyx_v_self-&gt;user_to_item_row_ptr.shape[0])) __pyx_t_2 = 0;
  if (unlikely(__pyx_t_2 != -1)) {
    <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
    <span class='error_goto'>__PYX_ERR(0, 276, __pyx_L1_error)</span>
  }
  __pyx_t_4.data = __pyx_v_self-&gt;user_to_item_cols.data;
  __pyx_t_4.memview = __pyx_v_self-&gt;user_to_item_cols.memview;
  __PYX_INC_MEMVIEW(&amp;__pyx_t_4, 0);
  __pyx_t_2 = -1;
  if (unlikely(__pyx_memoryview_slice_memviewslice(
    &amp;__pyx_t_4,
    __pyx_v_self-&gt;user_to_item_cols.shape[0], __pyx_v_self-&gt;user_to_item_cols.strides[0], __pyx_v_self-&gt;user_to_item_cols.suboffsets[0],
    0,
    0,
    &amp;__pyx_t_2,
    (*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;user_to_item_row_ptr.data + __pyx_t_1 * __pyx_v_self-&gt;user_to_item_row_ptr.strides[0]) ))),
    (*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;user_to_item_row_ptr.data + __pyx_t_3 * __pyx_v_self-&gt;user_to_item_row_ptr.strides[0]) ))),
    0,
    1,
    1,
    0,
    1) &lt; 0))
{
    <span class='error_goto'>__PYX_ERR(0, 276, __pyx_L1_error)</span>
}

__pyx_r = __pyx_t_4;
  __pyx_t_4.memview = NULL;
  __pyx_t_4.data = NULL;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">277</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">278</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">279</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">280</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">281</span>:     <span class="c"># cdef data_pointer_s getUsersThatRatedItem_pointer(self, long item_id):</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">282</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">283</span>:     <span class="c">#     cdef data_pointer_s pointer = data_pointer_s()</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">284</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">285</span>:     <span class="c">#     pointer.start_position = self.item_to_user_col_ptr[item_id]</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">286</span>:     <span class="c">#     pointer.num_elements = self.item_to_user_col_ptr[item_id+1] - pointer.start_position</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">287</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">288</span>:     <span class="c">#     return pointer</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">289</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">290</span>:     <span class="c"># cdef data_pointer_s getItemsRatedByUser_pointer(self, long user_id):</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">291</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">292</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">293</span>:     <span class="c">#     cdef data_pointer_s pointer = data_pointer_s()</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">294</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">295</span>:     <span class="c">#     pointer.start_position = self.user_to_item_row_ptr[user_id]</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">296</span>:     <span class="c">#     pointer.num_elements = self.user_to_item_row_ptr[user_id+1] - pointer.start_position</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">297</span>:     <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">298</span>:     <span class="c">#     return pointer</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">299</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">300</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">301</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">302</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">303</span>: </pre>
<pre class="cython line score-3" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">304</span>:     <span class="k">cdef</span> <span class="nf">computeItemSimilarities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">long</span> <span class="n">item_id_input</span><span class="p">):</span></pre>
<pre class='cython code score-3 '>static PyObject *__pyx_f_25Compute_Similarity_Cython_25Compute_Similarity_Cython_computeItemSimilarities(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_v_self, long __pyx_v_item_id_input) {
  long __pyx_v_user_index;
  long __pyx_v_user_id;
  long __pyx_v_item_index;
  long __pyx_v_item_id;
  long __pyx_v_item_id_second;
  __Pyx_memviewslice __pyx_v_users_that_rated_item = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_items_rated_by_user = { 0, 0, { 0 }, { 0 }, { 0 } };
  double __pyx_v_rating_item_input;
  double __pyx_v_rating_item_second;
  double __pyx_v_row_weight;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("computeItemSimilarities", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_1, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.computeItemSimilarities", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_users_that_rated_item, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_items_rated_by_user, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">305</span>:         <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">306</span>: <span class="sd">        For every item the cosine similarity against other items depends on whether they have users in common. The more</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">307</span>: <span class="sd">        common users the higher the similarity.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">308</span>: <span class="sd">        </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">309</span>: <span class="sd">        The basic implementation is:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">310</span>: <span class="sd">        - Select the first item</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">311</span>: <span class="sd">        - Loop through all other items</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">312</span>: <span class="sd">        -- Given the two items, get the users they have in common</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">313</span>: <span class="sd">        -- Update the similarity for all common users</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">314</span>: <span class="sd">        </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">315</span>: <span class="sd">        That is VERY slow due to the common user part, in which a long data structure is looped multiple times.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">316</span>: <span class="sd">        </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">317</span>: <span class="sd">        A better way is to use the data structure in a different way skipping the search part, getting directly the</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">318</span>: <span class="sd">        information we need.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">319</span>: <span class="sd">        </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">320</span>: <span class="sd">        The implementation here used is:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">321</span>: <span class="sd">        - Select the first item</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">322</span>: <span class="sd">        - Initialize a zero valued array for the similarities</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">323</span>: <span class="sd">        - Get the users who rated the first item</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">324</span>: <span class="sd">        - Loop through the users</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">325</span>: <span class="sd">        -- Given a user, get the items he rated (second item)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">326</span>: <span class="sd">        -- Update the similarity of the items he rated</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">327</span>: <span class="sd">        </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">328</span>: <span class="sd">        </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">329</span>: <span class="sd">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">330</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">331</span>:         <span class="c"># Create template used to initialize an array with zeros</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">332</span>:         <span class="c"># Much faster than np.zeros(self.n_columns)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">333</span>:         <span class="c">#cdef array[double] template_zero = array(&#39;d&#39;)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">334</span>:         <span class="c">#cdef array[double] result = clone(template_zero, self.n_columns, zero=True)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">335</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">336</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">337</span>:         <span class="k">cdef</span> <span class="kt">long</span> <span class="nf">user_index</span><span class="p">,</span> <span class="nf">user_id</span><span class="p">,</span> <span class="nf">item_index</span><span class="p">,</span> <span class="nf">item_id</span><span class="p">,</span> <span class="nf">item_id_second</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">338</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">339</span>:         <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">users_that_rated_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUsersThatRatedItem</span><span class="p">(</span><span class="n">item_id_input</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>  __pyx_t_1 = ((struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython *)__pyx_v_self-&gt;__pyx_vtab)-&gt;getUsersThatRatedItem(__pyx_v_self, __pyx_v_item_id_input);<span class='error_goto'> if (unlikely(!__pyx_t_1.memview)) __PYX_ERR(0, 339, __pyx_L1_error)</span>
  __pyx_v_users_that_rated_item = __pyx_t_1;
  __pyx_t_1.memview = NULL;
  __pyx_t_1.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">340</span>:         <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">items_rated_by_user</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">341</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">342</span>:         <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">rating_item_input</span><span class="p">,</span> <span class="nf">rating_item_second</span><span class="p">,</span> <span class="nf">row_weight</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">343</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">344</span>:         <span class="c"># Clean previous item</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">345</span>:         <span class="k">for</span> <span class="n">item_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_counter</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>  __pyx_t_2 = __pyx_v_self-&gt;this_item_weights_counter;
  __pyx_t_3 = __pyx_t_2;
  for (__pyx_t_4 = 0; __pyx_t_4 &lt; __pyx_t_3; __pyx_t_4+=1) {
    __pyx_v_item_index = __pyx_t_4;
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">346</span>:             <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_id</span><span class="p">[</span><span class="n">item_index</span><span class="p">]</span></pre>
<pre class='cython code score-7 '>    if (unlikely(!__pyx_v_self-&gt;this_item_weights_id.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 346, __pyx_L1_error)</span>}
    __pyx_t_5 = __pyx_v_item_index;
    __pyx_t_6 = -1;
    if (__pyx_t_5 &lt; 0) {
      __pyx_t_5 += __pyx_v_self-&gt;this_item_weights_id.shape[0];
      if (unlikely(__pyx_t_5 &lt; 0)) __pyx_t_6 = 0;
    } else if (unlikely(__pyx_t_5 &gt;= __pyx_v_self-&gt;this_item_weights_id.shape[0])) __pyx_t_6 = 0;
    if (unlikely(__pyx_t_6 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_6);
      <span class='error_goto'>__PYX_ERR(0, 346, __pyx_L1_error)</span>
    }
    __pyx_v_item_id = (*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights_id.data + __pyx_t_5 * __pyx_v_self-&gt;this_item_weights_id.strides[0]) )));
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">347</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_mask</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span></pre>
<pre class='cython code score-7 '>    if (unlikely(!__pyx_v_self-&gt;this_item_weights_mask.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 347, __pyx_L1_error)</span>}
    __pyx_t_7 = __pyx_v_item_id;
    __pyx_t_6 = -1;
    if (__pyx_t_7 &lt; 0) {
      __pyx_t_7 += __pyx_v_self-&gt;this_item_weights_mask.shape[0];
      if (unlikely(__pyx_t_7 &lt; 0)) __pyx_t_6 = 0;
    } else if (unlikely(__pyx_t_7 &gt;= __pyx_v_self-&gt;this_item_weights_mask.shape[0])) __pyx_t_6 = 0;
    if (unlikely(__pyx_t_6 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_6);
      <span class='error_goto'>__PYX_ERR(0, 347, __pyx_L1_error)</span>
    }
    *((int *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights_mask.data + __pyx_t_7 * __pyx_v_self-&gt;this_item_weights_mask.strides[0]) )) = 0;
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">348</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span></pre>
<pre class='cython code score-7 '>    if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 348, __pyx_L1_error)</span>}
    __pyx_t_8 = __pyx_v_item_id;
    __pyx_t_6 = -1;
    if (__pyx_t_8 &lt; 0) {
      __pyx_t_8 += __pyx_v_self-&gt;this_item_weights.shape[0];
      if (unlikely(__pyx_t_8 &lt; 0)) __pyx_t_6 = 0;
    } else if (unlikely(__pyx_t_8 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_6 = 0;
    if (unlikely(__pyx_t_6 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_6);
      <span class='error_goto'>__PYX_ERR(0, 348, __pyx_L1_error)</span>
    }
    *((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_8 * __pyx_v_self-&gt;this_item_weights.strides[0]) )) = 0.0;
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">349</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">350</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_counter</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  __pyx_v_self-&gt;this_item_weights_counter = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">351</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">352</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">353</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">354</span>:         <span class="c"># Get users that rated the items</span></pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">355</span>:         <span class="k">for</span> <span class="n">user_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">users_that_rated_item</span><span class="p">)):</span></pre>
<pre class='cython code score-2 '>  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_MemoryView_Len</span>(__pyx_v_users_that_rated_item); 
  __pyx_t_10 = __pyx_t_9;
  for (__pyx_t_4 = 0; __pyx_t_4 &lt; __pyx_t_10; __pyx_t_4+=1) {
    __pyx_v_user_index = __pyx_t_4;
</pre><pre class="cython line score-0">&#xA0;<span class="">356</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">357</span>:             <span class="n">user_id</span> <span class="o">=</span> <span class="n">users_that_rated_item</span><span class="p">[</span><span class="n">user_index</span><span class="p">]</span></pre>
<pre class='cython code score-2 '>    __pyx_t_11 = __pyx_v_user_index;
    __pyx_t_2 = -1;
    if (__pyx_t_11 &lt; 0) {
      __pyx_t_11 += __pyx_v_users_that_rated_item.shape[0];
      if (unlikely(__pyx_t_11 &lt; 0)) __pyx_t_2 = 0;
    } else if (unlikely(__pyx_t_11 &gt;= __pyx_v_users_that_rated_item.shape[0])) __pyx_t_2 = 0;
    if (unlikely(__pyx_t_2 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
      <span class='error_goto'>__PYX_ERR(0, 357, __pyx_L1_error)</span>
    }
    __pyx_v_user_id = (*((int *) ( /* dim=0 */ (__pyx_v_users_that_rated_item.data + __pyx_t_11 * __pyx_v_users_that_rated_item.strides[0]) )));
</pre><pre class="cython line score-14" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">358</span>:             <span class="n">rating_item_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_to_user_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_to_user_col_ptr</span><span class="p">[</span><span class="n">item_id_input</span><span class="p">]</span><span class="o">+</span><span class="n">user_index</span><span class="p">]</span></pre>
<pre class='cython code score-14 '>    if (unlikely(!__pyx_v_self-&gt;item_to_user_data.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 358, __pyx_L1_error)</span>}
    if (unlikely(!__pyx_v_self-&gt;item_to_user_col_ptr.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 358, __pyx_L1_error)</span>}
    __pyx_t_12 = __pyx_v_item_id_input;
    __pyx_t_2 = -1;
    if (__pyx_t_12 &lt; 0) {
      __pyx_t_12 += __pyx_v_self-&gt;item_to_user_col_ptr.shape[0];
      if (unlikely(__pyx_t_12 &lt; 0)) __pyx_t_2 = 0;
    } else if (unlikely(__pyx_t_12 &gt;= __pyx_v_self-&gt;item_to_user_col_ptr.shape[0])) __pyx_t_2 = 0;
    if (unlikely(__pyx_t_2 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
      <span class='error_goto'>__PYX_ERR(0, 358, __pyx_L1_error)</span>
    }
    __pyx_t_13 = ((*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;item_to_user_col_ptr.data + __pyx_t_12 * __pyx_v_self-&gt;item_to_user_col_ptr.strides[0]) ))) + __pyx_v_user_index);
    __pyx_t_2 = -1;
    if (__pyx_t_13 &lt; 0) {
      __pyx_t_13 += __pyx_v_self-&gt;item_to_user_data.shape[0];
      if (unlikely(__pyx_t_13 &lt; 0)) __pyx_t_2 = 0;
    } else if (unlikely(__pyx_t_13 &gt;= __pyx_v_self-&gt;item_to_user_data.shape[0])) __pyx_t_2 = 0;
    if (unlikely(__pyx_t_2 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
      <span class='error_goto'>__PYX_ERR(0, 358, __pyx_L1_error)</span>
    }
    __pyx_v_rating_item_input = (*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;item_to_user_data.data + __pyx_t_13 * __pyx_v_self-&gt;item_to_user_data.strides[0]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">359</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">360</span>:             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_row_weights</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>    __pyx_t_14 = (__pyx_v_self-&gt;use_row_weights != 0);
    if (__pyx_t_14) {
/* … */
      goto __pyx_L7;
    }
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">361</span>:                 <span class="n">row_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_weights</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span></pre>
<pre class='cython code score-7 '>      if (unlikely(!__pyx_v_self-&gt;row_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 361, __pyx_L1_error)</span>}
      __pyx_t_15 = __pyx_v_user_id;
      __pyx_t_2 = -1;
      if (__pyx_t_15 &lt; 0) {
        __pyx_t_15 += __pyx_v_self-&gt;row_weights.shape[0];
        if (unlikely(__pyx_t_15 &lt; 0)) __pyx_t_2 = 0;
      } else if (unlikely(__pyx_t_15 &gt;= __pyx_v_self-&gt;row_weights.shape[0])) __pyx_t_2 = 0;
      if (unlikely(__pyx_t_2 != -1)) {
        <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
        <span class='error_goto'>__PYX_ERR(0, 361, __pyx_L1_error)</span>
      }
      __pyx_v_row_weight = (*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;row_weights.data + __pyx_t_15 * __pyx_v_self-&gt;row_weights.strides[0]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">362</span>:             <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">363</span>:                 <span class="n">row_weight</span> <span class="o">=</span> <span class="mf">1.0</span></pre>
<pre class='cython code score-0 '>    /*else*/ {
      __pyx_v_row_weight = 1.0;
    }
    __pyx_L7:;
</pre><pre class="cython line score-0">&#xA0;<span class="">364</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">365</span>:             <span class="c"># Get all items rated by that user</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">366</span>:             <span class="n">items_rated_by_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getItemsRatedByUser</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>    __pyx_t_1 = ((struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython *)__pyx_v_self-&gt;__pyx_vtab)-&gt;getItemsRatedByUser(__pyx_v_self, __pyx_v_user_id);<span class='error_goto'> if (unlikely(!__pyx_t_1.memview)) __PYX_ERR(0, 366, __pyx_L1_error)</span>
    __PYX_XDEC_MEMVIEW(&amp;__pyx_v_items_rated_by_user, 1);
    __pyx_v_items_rated_by_user = __pyx_t_1;
    __pyx_t_1.memview = NULL;
    __pyx_t_1.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">367</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">368</span>:             <span class="k">for</span> <span class="n">item_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items_rated_by_user</span><span class="p">)):</span></pre>
<pre class='cython code score-2 '>    __pyx_t_16 = <span class='pyx_c_api'>__Pyx_MemoryView_Len</span>(__pyx_v_items_rated_by_user); 
    __pyx_t_17 = __pyx_t_16;
    for (__pyx_t_18 = 0; __pyx_t_18 &lt; __pyx_t_17; __pyx_t_18+=1) {
      __pyx_v_item_index = __pyx_t_18;
</pre><pre class="cython line score-0">&#xA0;<span class="">369</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">370</span>:                 <span class="n">item_id_second</span> <span class="o">=</span> <span class="n">items_rated_by_user</span><span class="p">[</span><span class="n">item_index</span><span class="p">]</span></pre>
<pre class='cython code score-2 '>      __pyx_t_19 = __pyx_v_item_index;
      __pyx_t_2 = -1;
      if (__pyx_t_19 &lt; 0) {
        __pyx_t_19 += __pyx_v_items_rated_by_user.shape[0];
        if (unlikely(__pyx_t_19 &lt; 0)) __pyx_t_2 = 0;
      } else if (unlikely(__pyx_t_19 &gt;= __pyx_v_items_rated_by_user.shape[0])) __pyx_t_2 = 0;
      if (unlikely(__pyx_t_2 != -1)) {
        <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
        <span class='error_goto'>__PYX_ERR(0, 370, __pyx_L1_error)</span>
      }
      __pyx_v_item_id_second = (*((int *) ( /* dim=0 */ (__pyx_v_items_rated_by_user.data + __pyx_t_19 * __pyx_v_items_rated_by_user.strides[0]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">371</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">372</span>:                 <span class="c"># Do not compute the similarity on the diagonal</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">373</span>:                 <span class="k">if</span> <span class="n">item_id_second</span> <span class="o">!=</span> <span class="n">item_id_input</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>      __pyx_t_14 = ((__pyx_v_item_id_second != __pyx_v_item_id_input) != 0);
      if (__pyx_t_14) {
/* … */
      }
    }
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">374</span>:                     <span class="c"># Increment similairty</span></pre>
<pre class="cython line score-14" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">375</span>:                     <span class="n">rating_item_second</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_item_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_to_item_row_ptr</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">+</span><span class="n">item_index</span><span class="p">]</span></pre>
<pre class='cython code score-14 '>        if (unlikely(!__pyx_v_self-&gt;user_to_item_data.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 375, __pyx_L1_error)</span>}
        if (unlikely(!__pyx_v_self-&gt;user_to_item_row_ptr.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 375, __pyx_L1_error)</span>}
        __pyx_t_20 = __pyx_v_user_id;
        __pyx_t_2 = -1;
        if (__pyx_t_20 &lt; 0) {
          __pyx_t_20 += __pyx_v_self-&gt;user_to_item_row_ptr.shape[0];
          if (unlikely(__pyx_t_20 &lt; 0)) __pyx_t_2 = 0;
        } else if (unlikely(__pyx_t_20 &gt;= __pyx_v_self-&gt;user_to_item_row_ptr.shape[0])) __pyx_t_2 = 0;
        if (unlikely(__pyx_t_2 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
          <span class='error_goto'>__PYX_ERR(0, 375, __pyx_L1_error)</span>
        }
        __pyx_t_21 = ((*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;user_to_item_row_ptr.data + __pyx_t_20 * __pyx_v_self-&gt;user_to_item_row_ptr.strides[0]) ))) + __pyx_v_item_index);
        __pyx_t_2 = -1;
        if (__pyx_t_21 &lt; 0) {
          __pyx_t_21 += __pyx_v_self-&gt;user_to_item_data.shape[0];
          if (unlikely(__pyx_t_21 &lt; 0)) __pyx_t_2 = 0;
        } else if (unlikely(__pyx_t_21 &gt;= __pyx_v_self-&gt;user_to_item_data.shape[0])) __pyx_t_2 = 0;
        if (unlikely(__pyx_t_2 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
          <span class='error_goto'>__PYX_ERR(0, 375, __pyx_L1_error)</span>
        }
        __pyx_v_rating_item_second = (*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;user_to_item_data.data + __pyx_t_21 * __pyx_v_self-&gt;user_to_item_data.strides[0]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">376</span>: </pre>
<pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">377</span>:                     <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">item_id_second</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rating_item_input</span><span class="o">*</span><span class="n">rating_item_second</span><span class="o">*</span><span class="n">row_weight</span></pre>
<pre class='cython code score-7 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 377, __pyx_L1_error)</span>}
        __pyx_t_22 = __pyx_v_item_id_second;
        __pyx_t_2 = -1;
        if (__pyx_t_22 &lt; 0) {
          __pyx_t_22 += __pyx_v_self-&gt;this_item_weights.shape[0];
          if (unlikely(__pyx_t_22 &lt; 0)) __pyx_t_2 = 0;
        } else if (unlikely(__pyx_t_22 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_2 = 0;
        if (unlikely(__pyx_t_2 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
          <span class='error_goto'>__PYX_ERR(0, 377, __pyx_L1_error)</span>
        }
        *((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_22 * __pyx_v_self-&gt;this_item_weights.strides[0]) )) += ((__pyx_v_rating_item_input * __pyx_v_rating_item_second) * __pyx_v_row_weight);
</pre><pre class="cython line score-0">&#xA0;<span class="">378</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">379</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">380</span>:                     <span class="c"># Update global data structure</span></pre>
<pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">381</span>:                     <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_mask</span><span class="p">[</span><span class="n">item_id_second</span><span class="p">]:</span></pre>
<pre class='cython code score-7 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights_mask.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 381, __pyx_L1_error)</span>}
        __pyx_t_23 = __pyx_v_item_id_second;
        __pyx_t_2 = -1;
        if (__pyx_t_23 &lt; 0) {
          __pyx_t_23 += __pyx_v_self-&gt;this_item_weights_mask.shape[0];
          if (unlikely(__pyx_t_23 &lt; 0)) __pyx_t_2 = 0;
        } else if (unlikely(__pyx_t_23 &gt;= __pyx_v_self-&gt;this_item_weights_mask.shape[0])) __pyx_t_2 = 0;
        if (unlikely(__pyx_t_2 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
          <span class='error_goto'>__PYX_ERR(0, 381, __pyx_L1_error)</span>
        }
        __pyx_t_14 = ((!((*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights_mask.data + __pyx_t_23 * __pyx_v_self-&gt;this_item_weights_mask.strides[0]) ))) != 0)) != 0);
        if (__pyx_t_14) {
/* … */
        }
</pre><pre class="cython line score-0">&#xA0;<span class="">382</span>: </pre>
<pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">383</span>:                         <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_mask</span><span class="p">[</span><span class="n">item_id_second</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span></pre>
<pre class='cython code score-7 '>          if (unlikely(!__pyx_v_self-&gt;this_item_weights_mask.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 383, __pyx_L1_error)</span>}
          __pyx_t_24 = __pyx_v_item_id_second;
          __pyx_t_2 = -1;
          if (__pyx_t_24 &lt; 0) {
            __pyx_t_24 += __pyx_v_self-&gt;this_item_weights_mask.shape[0];
            if (unlikely(__pyx_t_24 &lt; 0)) __pyx_t_2 = 0;
          } else if (unlikely(__pyx_t_24 &gt;= __pyx_v_self-&gt;this_item_weights_mask.shape[0])) __pyx_t_2 = 0;
          if (unlikely(__pyx_t_2 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
            <span class='error_goto'>__PYX_ERR(0, 383, __pyx_L1_error)</span>
          }
          *((int *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights_mask.data + __pyx_t_24 * __pyx_v_self-&gt;this_item_weights_mask.strides[0]) )) = 1;
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">384</span>:                         <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_id</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_id_second</span></pre>
<pre class='cython code score-7 '>          if (unlikely(!__pyx_v_self-&gt;this_item_weights_id.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 384, __pyx_L1_error)</span>}
          __pyx_t_25 = __pyx_v_self-&gt;this_item_weights_counter;
          __pyx_t_2 = -1;
          if (__pyx_t_25 &lt; 0) {
            __pyx_t_25 += __pyx_v_self-&gt;this_item_weights_id.shape[0];
            if (unlikely(__pyx_t_25 &lt; 0)) __pyx_t_2 = 0;
          } else if (unlikely(__pyx_t_25 &gt;= __pyx_v_self-&gt;this_item_weights_id.shape[0])) __pyx_t_2 = 0;
          if (unlikely(__pyx_t_2 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_2);
            <span class='error_goto'>__PYX_ERR(0, 384, __pyx_L1_error)</span>
          }
          *((int *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights_id.data + __pyx_t_25 * __pyx_v_self-&gt;this_item_weights_id.strides[0]) )) = __pyx_v_item_id_second;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">385</span>:                         <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_counter</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>          __pyx_v_self-&gt;this_item_weights_counter = (__pyx_v_self-&gt;this_item_weights_counter + 1);
</pre><pre class="cython line score-0">&#xA0;<span class="">386</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">387</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">388</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">389</span>: </pre>
<pre class="cython line score-60" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">390</span>:     <span class="k">def</span> <span class="nf">compute_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_col</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end_col</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre>
<pre class='cython code score-60 '>/* Python wrapper */
static PyObject *__pyx_pw_25Compute_Similarity_Cython_25Compute_Similarity_Cython_3compute_similarity(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_25Compute_Similarity_Cython_25Compute_Similarity_Cython_2compute_similarity[] = "\n        Compute the similarity for the given dataset\n        :param self:\n        :param start_col: column to begin with\n        :param end_col: column to stop before, end_col is excluded\n        :return:\n        ";
static PyObject *__pyx_pw_25Compute_Similarity_Cython_25Compute_Similarity_Cython_3compute_similarity(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyObject *__pyx_v_start_col = 0;
  PyObject *__pyx_v_end_col = 0;
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("compute_similarity (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_start_col,&amp;__pyx_n_s_end_col,0};
    PyObject* values[2] = {0,0};
    values[0] = ((PyObject *)Py_None);
    values[1] = ((PyObject *)Py_None);
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_start_col);
          if (value) { values[0] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  1:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_end_col);
          if (value) { values[1] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "compute_similarity") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 390, __pyx_L3_error)</span>
      }
    } else {
      switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_start_col = values[0];
    __pyx_v_end_col = values[1];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("compute_similarity", 0, 0, 2, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 390, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.compute_similarity", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_25Compute_Similarity_Cython_25Compute_Similarity_Cython_2compute_similarity(((struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *)__pyx_v_self), __pyx_v_start_col, __pyx_v_end_col);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_25Compute_Similarity_Cython_25Compute_Similarity_Cython_2compute_similarity(struct __pyx_obj_25Compute_Similarity_Cython_Compute_Similarity_Cython *__pyx_v_self, PyObject *__pyx_v_start_col, PyObject *__pyx_v_end_col) {
  int __pyx_v_print_block_size;
  int __pyx_v_itemIndex;
  int __pyx_v_innerItemIndex;
  int __pyx_v_item_id;
  int __pyx_v_local_topK;
  PY_LONG_LONG __pyx_v_topKItemIndex;
  __Pyx_memviewslice __pyx_v_top_k_idx = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyArrayObject *__pyx_v_top_k_partition = 0;
  PyArrayObject *__pyx_v_top_k_partition_sorting = 0;
  PyArrayObject *__pyx_v_this_item_weights_np = 0;
  long __pyx_v_processedItems;
  __Pyx_memviewslice __pyx_v_values = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_rows = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_cols = { 0, 0, { 0 }, { 0 }, { 0 } };
  long __pyx_v_sparse_data_pointer;
  int __pyx_v_start_col_local;
  int __pyx_v_end_col_local;
  CYTHON_UNUSED arrayobject *__pyx_v_template_zero = 0;
  PyObject *__pyx_v_start_time = NULL;
  PyObject *__pyx_v_last_print_time = NULL;
  PyObject *__pyx_v_current_time = NULL;
  PyObject *__pyx_v_itemPerSec = NULL;
  PyObject *__pyx_v_W_sparse = NULL;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_template_zero;
  __Pyx_Buffer __pyx_pybuffer_template_zero;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_this_item_weights_np;
  __Pyx_Buffer __pyx_pybuffer_this_item_weights_np;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_top_k_partition;
  __Pyx_Buffer __pyx_pybuffer_top_k_partition;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_top_k_partition_sorting;
  __Pyx_Buffer __pyx_pybuffer_top_k_partition_sorting;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("compute_similarity", 0);
  __pyx_pybuffer_top_k_partition.pybuffer.buf = NULL;
  __pyx_pybuffer_top_k_partition.refcount = 0;
  __pyx_pybuffernd_top_k_partition.data = NULL;
  __pyx_pybuffernd_top_k_partition.rcbuffer = &amp;__pyx_pybuffer_top_k_partition;
  __pyx_pybuffer_top_k_partition_sorting.pybuffer.buf = NULL;
  __pyx_pybuffer_top_k_partition_sorting.refcount = 0;
  __pyx_pybuffernd_top_k_partition_sorting.data = NULL;
  __pyx_pybuffernd_top_k_partition_sorting.rcbuffer = &amp;__pyx_pybuffer_top_k_partition_sorting;
  __pyx_pybuffer_this_item_weights_np.pybuffer.buf = NULL;
  __pyx_pybuffer_this_item_weights_np.refcount = 0;
  __pyx_pybuffernd_this_item_weights_np.data = NULL;
  __pyx_pybuffernd_this_item_weights_np.rcbuffer = &amp;__pyx_pybuffer_this_item_weights_np;
  __pyx_pybuffer_template_zero.pybuffer.buf = NULL;
  __pyx_pybuffer_template_zero.refcount = 0;
  __pyx_pybuffernd_template_zero.data = NULL;
  __pyx_pybuffernd_template_zero.rcbuffer = &amp;__pyx_pybuffer_template_zero;
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_14);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_15);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_39, 1);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&amp;__pyx_type, &amp;__pyx_value, &amp;__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_this_item_weights_np.rcbuffer-&gt;pybuffer);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_top_k_partition.rcbuffer-&gt;pybuffer);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_top_k_partition_sorting.rcbuffer-&gt;pybuffer);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.Compute_Similarity_Cython.compute_similarity", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_this_item_weights_np.rcbuffer-&gt;pybuffer);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_top_k_partition.rcbuffer-&gt;pybuffer);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_top_k_partition_sorting.rcbuffer-&gt;pybuffer);
  __pyx_L2:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_top_k_idx, 1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>((PyObject *)__pyx_v_top_k_partition);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>((PyObject *)__pyx_v_top_k_partition_sorting);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>((PyObject *)__pyx_v_this_item_weights_np);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_values, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_rows, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_cols, 1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>((PyObject *)__pyx_v_template_zero);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_start_time);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_last_print_time);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_current_time);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_itemPerSec);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_W_sparse);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">391</span>:         <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">392</span>: <span class="sd">        Compute the similarity for the given dataset</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">393</span>: <span class="sd">        :param self:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">394</span>: <span class="sd">        :param start_col: column to begin with</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">395</span>: <span class="sd">        :param end_col: column to stop before, end_col is excluded</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">396</span>: <span class="sd">        :return:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">397</span>: <span class="sd">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">398</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">399</span>:         <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">print_block_size</span> <span class="o">=</span> <span class="mf">500</span></pre>
<pre class='cython code score-0 '>  __pyx_v_print_block_size = 0x1F4;
</pre><pre class="cython line score-0">&#xA0;<span class="">400</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">401</span>:         <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">itemIndex</span><span class="p">,</span> <span class="nf">innerItemIndex</span><span class="p">,</span> <span class="nf">item_id</span><span class="p">,</span> <span class="nf">local_topK</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">402</span>:         <span class="k">cdef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">topKItemIndex</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">403</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">404</span>:         <span class="k">cdef</span> <span class="kt">long</span> <span class="kt">long</span>[<span class="p">:]</span> <span class="n">top_k_idx</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">405</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">406</span>:         <span class="c"># Declare numpy data type to use vetor indexing and simplify the topK selection code</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">407</span>:         <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span>[<span class="nf">long</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">]</span> <span class="n">top_k_partition</span><span class="p">,</span> <span class="n">top_k_partition_sorting</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">408</span>:         <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span>[<span class="kt">np</span>.<span class="nf">float64_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">]</span> <span class="n">this_item_weights_np</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">409</span>:         <span class="c">#cdef double[:] this_item_weights</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">410</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">411</span>:         <span class="k">cdef</span> <span class="kt">long</span> <span class="nf">processedItems</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  __pyx_v_processedItems = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">412</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">413</span>:         <span class="c"># Data structure to incrementally build sparse matrix</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">414</span>:         <span class="c"># Preinitialize max possible length</span></pre>
<pre class="cython line score-49" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">415</span>:         <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:]</span> <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TopK</span><span class="p">))</span></pre>
<pre class='cython code score-49 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>((__pyx_v_self-&gt;n_columns * __pyx_v_self-&gt;TopK));<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_3))) {
    __pyx_t_4 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_3);
    if (likely(__pyx_t_4)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_4);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_3, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else {
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_3)) {
      PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_t_2};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_3)) {
      PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_t_2};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    } else
    #endif
    {
      __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+1, __pyx_t_2);
      __pyx_t_2 = 0;
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    }
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_6.memview)) __PYX_ERR(0, 415, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_values = __pyx_t_6;
  __pyx_t_6.memview = NULL;
  __pyx_t_6.data = NULL;
</pre><pre class="cython line score-40" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">416</span>:         <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TopK</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></pre>
<pre class='cython code score-40 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>((__pyx_v_self-&gt;n_columns * __pyx_v_self-&gt;TopK));<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_1);
  __pyx_t_1 = 0;
  __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_5);
  __pyx_t_5 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_int32);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_5, __pyx_n_s_dtype, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_1, __pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_4, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_7.memview)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_rows = __pyx_t_7;
  __pyx_t_7.memview = NULL;
  __pyx_t_7.data = NULL;
</pre><pre class="cython line score-40" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">417</span>:         <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">:]</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TopK</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></pre>
<pre class='cython code score-40 '>  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>((__pyx_v_self-&gt;n_columns * __pyx_v_self-&gt;TopK));<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_1);
  __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_int32);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_5, __pyx_t_4, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_2, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_7.memview)) __PYX_ERR(0, 417, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_cols = __pyx_t_7;
  __pyx_t_7.memview = NULL;
  __pyx_t_7.data = NULL;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">418</span>:         <span class="k">cdef</span> <span class="kt">long</span> <span class="nf">sparse_data_pointer</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  __pyx_v_sparse_data_pointer = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">419</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">420</span>:         <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">start_col_local</span> <span class="o">=</span> <span class="mf">0</span><span class="p">,</span> <span class="n">end_col_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span></pre>
<pre class='cython code score-0 '>  __pyx_v_start_col_local = 0;
  __pyx_t_8 = __pyx_v_self-&gt;n_columns;
  __pyx_v_end_col_local = __pyx_t_8;
</pre><pre class="cython line score-0">&#xA0;<span class="">421</span>: </pre>
<pre class="cython line score-10" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">422</span>:         <span class="k">cdef</span> <span class="kt">array</span>[<span class="kt">double</span>] <span class="nf">template_zero</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(((PyObject *)__pyx_ptype_7cpython_5array_array), __pyx_tuple__2, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 422, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer, (PyObject*)((arrayobject *)__pyx_t_2), &amp;__Pyx_TypeInfo_double, PyBUF_FORMAT| PyBUF_INDIRECT, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_template_zero = ((arrayobject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None); __pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer.buf = NULL;
      <span class='error_goto'>__PYX_ERR(0, 422, __pyx_L1_error)</span>
    } else {__pyx_pybuffernd_template_zero.diminfo[0].strides = __pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer.strides[0]; __pyx_pybuffernd_template_zero.diminfo[0].shape = __pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer.shape[0]; __pyx_pybuffernd_template_zero.diminfo[0].suboffsets = __pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer.suboffsets[0];
    }
  }
  __pyx_v_template_zero = ((arrayobject *)__pyx_t_2);
  __pyx_t_2 = 0;
/* … */
  __pyx_tuple__2 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_n_s_d);<span class='error_goto'> if (unlikely(!__pyx_tuple__2)) __PYX_ERR(0, 422, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__2);
</pre><pre class="cython line score-0">&#xA0;<span class="">423</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">424</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">425</span>: </pre>
<pre class="cython line score-19" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">426</span>:         <span class="k">if</span> <span class="n">start_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">start_col</span><span class="o">&gt;</span><span class="mf">0</span> <span class="ow">and</span> <span class="n">start_col</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">:</span></pre>
<pre class='cython code score-19 '>  __pyx_t_10 = (__pyx_v_start_col != Py_None);
  __pyx_t_11 = (__pyx_t_10 != 0);
  if (__pyx_t_11) {
  } else {
    __pyx_t_9 = __pyx_t_11;
    goto __pyx_L4_bool_binop_done;
  }
  __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_v_start_col, __pyx_int_0, Py_GT); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 426, __pyx_L1_error)</span>
  __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_11 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 426, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (__pyx_t_11) {
  } else {
    __pyx_t_9 = __pyx_t_11;
    goto __pyx_L4_bool_binop_done;
  }
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 426, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_1 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_v_start_col, __pyx_t_2, Py_LT); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 426, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_11 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 426, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_9 = __pyx_t_11;
  __pyx_L4_bool_binop_done:;
  if (__pyx_t_9) {
/* … */
  }
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">427</span>:             <span class="n">start_col_local</span> <span class="o">=</span> <span class="n">start_col</span></pre>
<pre class='cython code score-7 '>    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyInt_As_int</span>(__pyx_v_start_col); if (unlikely((__pyx_t_12 == (int)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 427, __pyx_L1_error)</span>
    __pyx_v_start_col_local = __pyx_t_12;
</pre><pre class="cython line score-0">&#xA0;<span class="">428</span>: </pre>
<pre class="cython line score-22" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">429</span>:         <span class="k">if</span> <span class="n">end_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">end_col</span><span class="o">&gt;</span><span class="n">start_col_local</span> <span class="ow">and</span> <span class="n">end_col</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">:</span></pre>
<pre class='cython code score-22 '>  __pyx_t_11 = (__pyx_v_end_col != Py_None);
  __pyx_t_10 = (__pyx_t_11 != 0);
  if (__pyx_t_10) {
  } else {
    __pyx_t_9 = __pyx_t_10;
    goto __pyx_L8_bool_binop_done;
  }
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyInt_From_int</span>(__pyx_v_start_col_local);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_v_end_col, __pyx_t_1, Py_GT); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_10 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (__pyx_t_10) {
  } else {
    __pyx_t_9 = __pyx_t_10;
    goto __pyx_L8_bool_binop_done;
  }
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_1 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_v_end_col, __pyx_t_2, Py_LT); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_10 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_9 = __pyx_t_10;
  __pyx_L8_bool_binop_done:;
  if (__pyx_t_9) {
/* … */
  }
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">430</span>:             <span class="n">end_col_local</span> <span class="o">=</span> <span class="n">end_col</span></pre>
<pre class='cython code score-7 '>    __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyInt_As_int</span>(__pyx_v_end_col); if (unlikely((__pyx_t_12 == (int)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 430, __pyx_L1_error)</span>
    __pyx_v_end_col_local = __pyx_t_12;
</pre><pre class="cython line score-0">&#xA0;<span class="">431</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">432</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">433</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">434</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">435</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">436</span>: </pre>
<pre class="cython line score-21" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">437</span>:         <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></pre>
<pre class='cython code score-21 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_time);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 437, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_time);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 437, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_4))) {
    __pyx_t_2 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_4);
    if (likely(__pyx_t_2)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_4);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_4, function);
    }
  }
  if (__pyx_t_2) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_4, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 437, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  } else {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 437, __pyx_L1_error)</span>
  }
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_start_time = __pyx_t_1;
  __pyx_t_1 = 0;
</pre><pre class="cython line score-1" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">438</span>:         <span class="n">last_print_time</span> <span class="o">=</span> <span class="n">start_time</span></pre>
<pre class='cython code score-1 '>  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_start_time);
  __pyx_v_last_print_time = __pyx_v_start_time;
</pre><pre class="cython line score-0">&#xA0;<span class="">439</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">440</span>:         <span class="n">itemIndex</span> <span class="o">=</span> <span class="n">start_col_local</span></pre>
<pre class='cython code score-0 '>  __pyx_v_itemIndex = __pyx_v_start_col_local;
</pre><pre class="cython line score-0">&#xA0;<span class="">441</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">442</span>:         <span class="c"># Compute all similarities for each item</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">443</span>:         <span class="k">while</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">end_col_local</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  while (1) {
    __pyx_t_9 = ((__pyx_v_itemIndex &lt; __pyx_v_end_col_local) != 0);
    if (!__pyx_t_9) break;
</pre><pre class="cython line score-0">&#xA0;<span class="">444</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">445</span>:             <span class="n">processedItems</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>    __pyx_v_processedItems = (__pyx_v_processedItems + 1);
</pre><pre class="cython line score-0">&#xA0;<span class="">446</span>: </pre>
<pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">447</span>:             <span class="k">if</span> <span class="n">processedItems</span> <span class="o">%</span> <span class="n">print_block_size</span><span class="o">==</span><span class="mf">0</span> <span class="ow">or</span> <span class="n">processedItems</span><span class="o">==</span><span class="n">end_col_local</span><span class="p">:</span></pre>
<pre class='cython code score-5 '>    if (unlikely(__pyx_v_print_block_size == 0)) {
      <span class='py_c_api'>PyErr_SetString</span>(PyExc_ZeroDivisionError, "integer division or modulo by zero");
      <span class='error_goto'>__PYX_ERR(0, 447, __pyx_L1_error)</span>
    }
    __pyx_t_10 = ((__Pyx_mod_long(__pyx_v_processedItems, __pyx_v_print_block_size) == 0) != 0);
    if (!__pyx_t_10) {
    } else {
      __pyx_t_9 = __pyx_t_10;
      goto __pyx_L14_bool_binop_done;
    }
    __pyx_t_10 = ((__pyx_v_processedItems == __pyx_v_end_col_local) != 0);
    __pyx_t_9 = __pyx_t_10;
    __pyx_L14_bool_binop_done:;
    if (__pyx_t_9) {
/* … */
    }
</pre><pre class="cython line score-0">&#xA0;<span class="">448</span>: </pre>
<pre class="cython line score-22" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">449</span>:                 <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></pre>
<pre class='cython code score-22 '>      __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_time);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 449, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_time);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 449, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = NULL;
      if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
        __pyx_t_4 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
        if (likely(__pyx_t_4)) {
          PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_4);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
          <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
        }
      }
      if (__pyx_t_4) {
        __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_2, __pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 449, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      } else {
        __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 449, __pyx_L1_error)</span>
      }
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      <span class='pyx_macro_api'>__Pyx_XDECREF_SET</span>(__pyx_v_current_time, __pyx_t_1);
      __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">450</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">451</span>:                 <span class="c"># Set block size to the number of items necessary in order to print every 30 seconds</span></pre>
<pre class="cython line score-34" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">452</span>:                 <span class="n">itemPerSec</span> <span class="o">=</span> <span class="n">processedItems</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span></pre>
<pre class='cython code score-34 '>      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_processedItems);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 452, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_time);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 452, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
      __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_time);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 452, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = NULL;
      if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_5))) {
        __pyx_t_4 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_5);
        if (likely(__pyx_t_4)) {
          PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_5);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_4);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
          <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_5, function);
        }
      }
      if (__pyx_t_4) {
        __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_5, __pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 452, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      } else {
        __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 452, __pyx_L1_error)</span>
      }
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = <span class='py_c_api'>PyNumber_Subtract</span>(__pyx_t_2, __pyx_v_start_time);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 452, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyNumber_Divide</span>(__pyx_t_1, __pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 452, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      <span class='pyx_macro_api'>__Pyx_XDECREF_SET</span>(__pyx_v_itemPerSec, __pyx_t_2);
      __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">453</span>: </pre>
<pre class="cython line score-16" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">454</span>:                 <span class="n">print_block_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">itemPerSec</span><span class="o">*</span><span class="mf">30</span><span class="p">)</span></pre>
<pre class='cython code score-16 '>      __pyx_t_2 = <span class='py_c_api'>PyNumber_Multiply</span>(__pyx_v_itemPerSec, __pyx_int_30);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 454, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyNumber_Int</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 454, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyInt_As_int</span>(__pyx_t_5); if (unlikely((__pyx_t_12 == (int)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 454, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_v_print_block_size = __pyx_t_12;
</pre><pre class="cython line score-0">&#xA0;<span class="">455</span>: </pre>
<pre class="cython line score-14" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">456</span>:                 <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_print_time</span> <span class="o">&gt;</span> <span class="mf">30</span>  <span class="ow">or</span> <span class="n">processedItems</span><span class="o">==</span><span class="n">end_col_local</span><span class="p">:</span></pre>
<pre class='cython code score-14 '>      __pyx_t_5 = <span class='py_c_api'>PyNumber_Subtract</span>(__pyx_v_current_time, __pyx_v_last_print_time);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 456, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_5, __pyx_int_30, Py_GT); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 456, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_10 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 456, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      if (!__pyx_t_10) {
      } else {
        __pyx_t_9 = __pyx_t_10;
        goto __pyx_L17_bool_binop_done;
      }
      __pyx_t_10 = ((__pyx_v_processedItems == __pyx_v_end_col_local) != 0);
      __pyx_t_9 = __pyx_t_10;
      __pyx_L17_bool_binop_done:;
      if (__pyx_t_9) {
/* … */
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">457</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">458</span>:                     <span class="k">print</span><span class="p">(</span><span class="s">&quot;Similarity column {} ( {:2.0f} % ), {:.2f} column/sec, elapsed time {:.2f} min&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span></pre>
<pre class='cython code score-2 '>        __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_kp_s_Similarity_column_2_0f_2f_column, __pyx_n_s_format);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 458, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
</pre><pre class="cython line score-89" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">459</span>:                         <span class="n">processedItems</span><span class="p">,</span> <span class="n">processedItems</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">end_col_local</span><span class="o">-</span><span class="n">start_col_local</span><span class="p">)</span><span class="o">*</span><span class="mf">100</span><span class="p">,</span> <span class="n">itemPerSec</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60</span><span class="p">))</span></pre>
<pre class='cython code score-89 '>        __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_processedItems);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 459, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
        __pyx_t_13 = (__pyx_v_processedItems * 1.0);
        __pyx_t_12 = (__pyx_v_end_col_local - __pyx_v_start_col_local);
        if (unlikely(__pyx_t_12 == 0)) {
          <span class='py_c_api'>PyErr_SetString</span>(PyExc_ZeroDivisionError, "float division");
          <span class='error_goto'>__PYX_ERR(0, 459, __pyx_L1_error)</span>
        }
        __pyx_t_4 = <span class='py_c_api'>PyFloat_FromDouble</span>(((__pyx_t_13 / __pyx_t_12) * 100.0));<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 459, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_time);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 459, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        __pyx_t_15 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_14, __pyx_n_s_time);<span class='error_goto'> if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 459, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_15);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
        __pyx_t_14 = NULL;
        if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_15))) {
          __pyx_t_14 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_15);
          if (likely(__pyx_t_14)) {
            PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_15);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_14);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
            <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_15, function);
          }
        }
        if (__pyx_t_14) {
          __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_15, __pyx_t_14);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 459, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
        } else {
          __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_15);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 459, __pyx_L1_error)</span>
        }
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_15); __pyx_t_15 = 0;
        __pyx_t_15 = <span class='py_c_api'>PyNumber_Subtract</span>(__pyx_t_3, __pyx_v_start_time);<span class='error_goto'> if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 459, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_15);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyNumber_Divide</span>(__pyx_t_15, __pyx_int_60);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 459, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_15); __pyx_t_15 = 0;
        __pyx_t_15 = NULL;
        __pyx_t_12 = 0;
        if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_5))) {
          __pyx_t_15 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_5);
          if (likely(__pyx_t_15)) {
            PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_5);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_15);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
            <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_5, function);
            __pyx_t_12 = 1;
          }
        }
        #if CYTHON_FAST_PYCALL
        if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_5)) {
          PyObject *__pyx_temp[5] = {__pyx_t_15, __pyx_t_1, __pyx_t_4, __pyx_v_itemPerSec, __pyx_t_3};
          __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_5, __pyx_temp+1-__pyx_t_12, 4+__pyx_t_12);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 458, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_15); __pyx_t_15 = 0;
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        } else
        #endif
        #if CYTHON_FAST_PYCCALL
        if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_5)) {
          PyObject *__pyx_temp[5] = {__pyx_t_15, __pyx_t_1, __pyx_t_4, __pyx_v_itemPerSec, __pyx_t_3};
          __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_5, __pyx_temp+1-__pyx_t_12, 4+__pyx_t_12);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 458, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_15); __pyx_t_15 = 0;
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        } else
        #endif
        {
          __pyx_t_14 = <span class='py_c_api'>PyTuple_New</span>(4+__pyx_t_12);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 458, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
          if (__pyx_t_15) {
            <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_15); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_14, 0, __pyx_t_15); __pyx_t_15 = NULL;
          }
          <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
          <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_14, 0+__pyx_t_12, __pyx_t_1);
          <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
          <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_14, 1+__pyx_t_12, __pyx_t_4);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_itemPerSec);
          <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_itemPerSec);
          <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_14, 2+__pyx_t_12, __pyx_v_itemPerSec);
          <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
          <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_14, 3+__pyx_t_12, __pyx_t_3);
          __pyx_t_1 = 0;
          __pyx_t_4 = 0;
          __pyx_t_3 = 0;
          __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_5, __pyx_t_14, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 458, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
        }
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        if (<span class='pyx_c_api'>__Pyx_PrintOne</span>(0, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 458, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">460</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">461</span>:                     <span class="n">last_print_time</span> <span class="o">=</span> <span class="n">current_time</span></pre>
<pre class='cython code score-2 '>        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_current_time);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_last_print_time, __pyx_v_current_time);
</pre><pre class="cython line score-0">&#xA0;<span class="">462</span>: </pre>
<pre class="cython line score-25" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">463</span>:                     <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre>
<pre class='cython code score-25 '>        __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_sys);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 463, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_5, __pyx_n_s_stdout);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 463, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_14, __pyx_n_s_flush);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 463, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
        __pyx_t_14 = NULL;
        if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_5))) {
          __pyx_t_14 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_5);
          if (likely(__pyx_t_14)) {
            PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_5);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_14);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
            <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_5, function);
          }
        }
        if (__pyx_t_14) {
          __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_5, __pyx_t_14);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 463, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
        } else {
          __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 463, __pyx_L1_error)</span>
        }
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-25" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">464</span>:                     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre>
<pre class='cython code score-25 '>        __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_sys);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 464, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_5, __pyx_n_s_stderr);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 464, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_14, __pyx_n_s_flush);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 464, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
        __pyx_t_14 = NULL;
        if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_5))) {
          __pyx_t_14 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_5);
          if (likely(__pyx_t_14)) {
            PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_5);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_14);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
            <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_5, function);
          }
        }
        if (__pyx_t_14) {
          __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_5, __pyx_t_14);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 464, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
        } else {
          __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallNoArg</span>(__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 464, __pyx_L1_error)</span>
        }
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">465</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">466</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">467</span>:             <span class="c"># Computed similarities go in self.this_item_weights</span></pre>
<pre class="cython line score-1" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">468</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">computeItemSimilarities</span><span class="p">(</span><span class="n">itemIndex</span><span class="p">)</span></pre>
<pre class='cython code score-1 '>    __pyx_t_2 = ((struct __pyx_vtabstruct_25Compute_Similarity_Cython_Compute_Similarity_Cython *)__pyx_v_self-&gt;__pyx_vtab)-&gt;computeItemSimilarities(__pyx_v_self, __pyx_v_itemIndex);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 468, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">469</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">470</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">471</span>:             <span class="c"># Apply normalization and shrinkage, ensure denominator != 0</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">472</span>:             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>    __pyx_t_9 = (__pyx_v_self-&gt;normalize != 0);
    if (__pyx_t_9) {
/* … */
      goto __pyx_L19;
    }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">473</span>:                 <span class="k">for</span> <span class="n">innerItemIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_8 = __pyx_v_self-&gt;n_columns;
      __pyx_t_16 = __pyx_t_8;
      for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_16; __pyx_t_12+=1) {
        __pyx_v_innerItemIndex = __pyx_t_12;
</pre><pre class="cython line score-21" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">474</span>:                     <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sumOfSquared</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sumOfSquared</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span>\</pre>
<pre class='cython code score-21 '>        if (unlikely(!__pyx_v_self-&gt;sumOfSquared.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 474, __pyx_L1_error)</span>}
        __pyx_t_17 = __pyx_v_itemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_17 &lt; 0) {
          __pyx_t_17 += __pyx_v_self-&gt;sumOfSquared.shape[0];
          if (unlikely(__pyx_t_17 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_17 &gt;= __pyx_v_self-&gt;sumOfSquared.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 474, __pyx_L1_error)</span>
        }
        if (unlikely(!__pyx_v_self-&gt;sumOfSquared.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 474, __pyx_L1_error)</span>}
        __pyx_t_19 = __pyx_v_innerItemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_19 &lt; 0) {
          __pyx_t_19 += __pyx_v_self-&gt;sumOfSquared.shape[0];
          if (unlikely(__pyx_t_19 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_19 &gt;= __pyx_v_self-&gt;sumOfSquared.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 474, __pyx_L1_error)</span>
        }
/* … */
        if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 474, __pyx_L1_error)</span>}
/* … */
        __pyx_t_20 = __pyx_v_innerItemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_20 &lt; 0) {
          __pyx_t_20 += __pyx_v_self-&gt;this_item_weights.shape[0];
          if (unlikely(__pyx_t_20 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_20 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 474, __pyx_L1_error)</span>
        }
        *((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_20 * __pyx_v_self-&gt;this_item_weights.strides[0]) )) /= ((((*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;sumOfSquared.data + __pyx_t_17 * __pyx_v_self-&gt;sumOfSquared.strides[0]) ))) * (*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;sumOfSquared.data + __pyx_t_19 * __pyx_v_self-&gt;sumOfSquared.strides[0]) )))) + __pyx_v_self-&gt;shrink) + 1e-6);
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">475</span>:                                                          <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shrink</span> <span class="o">+</span> <span class="mf">1e-6</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">476</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">477</span>:             <span class="c"># Apply the specific denominator for Tanimoto</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">478</span>:             <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanimoto_coefficient</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>    __pyx_t_9 = (__pyx_v_self-&gt;tanimoto_coefficient != 0);
    if (__pyx_t_9) {
/* … */
      goto __pyx_L19;
    }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">479</span>:                 <span class="k">for</span> <span class="n">innerItemIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_8 = __pyx_v_self-&gt;n_columns;
      __pyx_t_16 = __pyx_t_8;
      for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_16; __pyx_t_12+=1) {
        __pyx_v_innerItemIndex = __pyx_t_12;
</pre><pre class="cython line score-21" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">480</span>:                     <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sumOfSquared</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sumOfSquared</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span> <span class="o">-</span>\</pre>
<pre class='cython code score-21 '>        if (unlikely(!__pyx_v_self-&gt;sumOfSquared.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 480, __pyx_L1_error)</span>}
        __pyx_t_21 = __pyx_v_itemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_21 &lt; 0) {
          __pyx_t_21 += __pyx_v_self-&gt;sumOfSquared.shape[0];
          if (unlikely(__pyx_t_21 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_21 &gt;= __pyx_v_self-&gt;sumOfSquared.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 480, __pyx_L1_error)</span>
        }
        if (unlikely(!__pyx_v_self-&gt;sumOfSquared.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 480, __pyx_L1_error)</span>}
        __pyx_t_22 = __pyx_v_innerItemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_22 &lt; 0) {
          __pyx_t_22 += __pyx_v_self-&gt;sumOfSquared.shape[0];
          if (unlikely(__pyx_t_22 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_22 &gt;= __pyx_v_self-&gt;sumOfSquared.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 480, __pyx_L1_error)</span>
        }
/* … */
        if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 480, __pyx_L1_error)</span>}
        __pyx_t_24 = __pyx_v_innerItemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_24 &lt; 0) {
          __pyx_t_24 += __pyx_v_self-&gt;this_item_weights.shape[0];
          if (unlikely(__pyx_t_24 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_24 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 480, __pyx_L1_error)</span>
        }
        *((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_24 * __pyx_v_self-&gt;this_item_weights.strides[0]) )) /= (((((*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;sumOfSquared.data + __pyx_t_21 * __pyx_v_self-&gt;sumOfSquared.strides[0]) ))) + (*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;sumOfSquared.data + __pyx_t_22 * __pyx_v_self-&gt;sumOfSquared.strides[0]) )))) - (*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_23 * __pyx_v_self-&gt;this_item_weights.strides[0]) )))) + __pyx_v_self-&gt;shrink) + 1e-6);
      }
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">481</span>:                                                          <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shrink</span> <span class="o">+</span> <span class="mf">1e-6</span></pre>
<pre class='cython code score-7 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 481, __pyx_L1_error)</span>}
        __pyx_t_23 = __pyx_v_innerItemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_23 &lt; 0) {
          __pyx_t_23 += __pyx_v_self-&gt;this_item_weights.shape[0];
          if (unlikely(__pyx_t_23 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_23 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 481, __pyx_L1_error)</span>
        }
</pre><pre class="cython line score-0">&#xA0;<span class="">482</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">483</span>:             <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shrink</span> <span class="o">!=</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>    __pyx_t_9 = ((__pyx_v_self-&gt;shrink != 0) != 0);
    if (__pyx_t_9) {
/* … */
    }
    __pyx_L19:;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">484</span>:                 <span class="k">for</span> <span class="n">innerItemIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_8 = __pyx_v_self-&gt;n_columns;
      __pyx_t_16 = __pyx_t_8;
      for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_16; __pyx_t_12+=1) {
        __pyx_v_innerItemIndex = __pyx_t_12;
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">485</span>:                     <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shrink</span></pre>
<pre class='cython code score-7 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 485, __pyx_L1_error)</span>}
        __pyx_t_25 = __pyx_v_innerItemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_25 &lt; 0) {
          __pyx_t_25 += __pyx_v_self-&gt;this_item_weights.shape[0];
          if (unlikely(__pyx_t_25 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_25 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 485, __pyx_L1_error)</span>
        }
        *((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_25 * __pyx_v_self-&gt;this_item_weights.strides[0]) )) /= __pyx_v_self-&gt;shrink;
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">486</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">487</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">488</span>:             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TopK</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>    __pyx_t_9 = ((__pyx_v_self-&gt;TopK == 0) != 0);
    if (__pyx_t_9) {
/* … */
      goto __pyx_L26;
    }
</pre><pre class="cython line score-0">&#xA0;<span class="">489</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">490</span>:                 <span class="k">for</span> <span class="n">innerItemIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_8 = __pyx_v_self-&gt;n_columns;
      __pyx_t_16 = __pyx_t_8;
      for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_16; __pyx_t_12+=1) {
        __pyx_v_innerItemIndex = __pyx_t_12;
</pre><pre class="cython line score-14" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">491</span>:                     <span class="bp">self</span><span class="o">.</span><span class="n">W_dense</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">,</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span></pre>
<pre class='cython code score-14 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 491, __pyx_L1_error)</span>}
        __pyx_t_26 = __pyx_v_innerItemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_26 &lt; 0) {
          __pyx_t_26 += __pyx_v_self-&gt;this_item_weights.shape[0];
          if (unlikely(__pyx_t_26 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_26 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_18 = 0;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 491, __pyx_L1_error)</span>
        }
        if (unlikely(!__pyx_v_self-&gt;W_dense.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 491, __pyx_L1_error)</span>}
        __pyx_t_27 = __pyx_v_innerItemIndex;
        __pyx_t_28 = __pyx_v_itemIndex;
        __pyx_t_18 = -1;
        if (__pyx_t_27 &lt; 0) {
          __pyx_t_27 += __pyx_v_self-&gt;W_dense.shape[0];
          if (unlikely(__pyx_t_27 &lt; 0)) __pyx_t_18 = 0;
        } else if (unlikely(__pyx_t_27 &gt;= __pyx_v_self-&gt;W_dense.shape[0])) __pyx_t_18 = 0;
        if (__pyx_t_28 &lt; 0) {
          __pyx_t_28 += __pyx_v_self-&gt;W_dense.shape[1];
          if (unlikely(__pyx_t_28 &lt; 0)) __pyx_t_18 = 1;
        } else if (unlikely(__pyx_t_28 &gt;= __pyx_v_self-&gt;W_dense.shape[1])) __pyx_t_18 = 1;
        if (unlikely(__pyx_t_18 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_18);
          <span class='error_goto'>__PYX_ERR(0, 491, __pyx_L1_error)</span>
        }
        *((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_self-&gt;W_dense.data + __pyx_t_27 * __pyx_v_self-&gt;W_dense.strides[0]) ) + __pyx_t_28 * __pyx_v_self-&gt;W_dense.strides[1]) )) = (*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_26 * __pyx_v_self-&gt;this_item_weights.strides[0]) )));
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">492</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">493</span>:             <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">494</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">495</span>:                 <span class="c"># Sort indices and select TopK</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">496</span>:                 <span class="c"># Using numpy implies some overhead, unfortunately the plain C qsort function is even slower</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">497</span>:                 <span class="c">#top_k_idx = np.argsort(this_item_weights) [-self.TopK:]</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">498</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">499</span>:                 <span class="c"># Sorting is done in three steps. Faster then plain np.argsort for higher number of items</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">500</span>:                 <span class="c"># because we avoid sorting elements we already know we don&#39;t care about</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">501</span>:                 <span class="c"># - Partition the data to extract the set of TopK items, this set is unsorted</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">502</span>:                 <span class="c"># - Sort only the TopK items, discarding the rest</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">503</span>:                 <span class="c"># - Get the original item index</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">504</span>:                 <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">505</span>:                 <span class="c"># this_item_weights_np = - np.array(self.this_item_weights)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">506</span>:                 <span class="c"># #</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">507</span>:                 <span class="c"># # Get the unordered set of topK items</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">508</span>:                 <span class="c"># top_k_partition = np.argpartition(this_item_weights_np, self.TopK-1)[0:self.TopK]</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">509</span>:                 <span class="c"># # Sort only the elements in the partition</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">510</span>:                 <span class="c"># top_k_partition_sorting = np.argsort(this_item_weights_np[top_k_partition])</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">511</span>:                 <span class="c"># # Get original index</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">512</span>:                 <span class="c"># top_k_idx = top_k_partition[top_k_partition_sorting]</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">513</span>:                 <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">514</span>:                 <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">515</span>:                 <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">516</span>:                 <span class="c"># # Incrementally build sparse matrix, do not add zeros</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">517</span>:                 <span class="c"># for innerItemIndex in range(len(top_k_idx)):</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">518</span>:                 <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">519</span>:                 <span class="c">#     topKItemIndex = top_k_idx[innerItemIndex]</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">520</span>:                 <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">521</span>:                 <span class="c">#     if this_item_weights[topKItemIndex] != 0.0:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">522</span>:                 <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">523</span>:                 <span class="c">#         values[sparse_data_pointer] = this_item_weights[topKItemIndex]</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">524</span>:                 <span class="c">#         rows[sparse_data_pointer] = topKItemIndex</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">525</span>:                 <span class="c">#         cols[sparse_data_pointer] = itemIndex</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">526</span>:                 <span class="c">#</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">527</span>:                 <span class="c">#         sparse_data_pointer += 1</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">528</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">529</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">530</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">531</span>:                 <span class="c">#this_item_weights_np = clone(template_zero, self.this_item_weights_counter, zero=False)</span></pre>
<pre class="cython line score-52" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">532</span>:                 <span class="n">this_item_weights_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-52 '>    /*else*/ {
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_14 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_14, 0, __pyx_t_2);
      __pyx_t_2 = 0;
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_2, __pyx_n_s_dtype, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_5, __pyx_t_14, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 532, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      if (!(likely(((__pyx_t_4) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) <span class='error_goto'>__PYX_ERR(0, 532, __pyx_L1_error)</span>
      __pyx_t_29 = ((PyArrayObject *)__pyx_t_4);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_this_item_weights_np.rcbuffer-&gt;pybuffer);
        __pyx_t_12 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_this_item_weights_np.rcbuffer-&gt;pybuffer, (PyObject*)__pyx_t_29, &amp;__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
        if (unlikely(__pyx_t_12 &lt; 0)) {
          <span class='py_c_api'>PyErr_Fetch</span>(&amp;__pyx_t_30, &amp;__pyx_t_31, &amp;__pyx_t_32);
          if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_this_item_weights_np.rcbuffer-&gt;pybuffer, (PyObject*)__pyx_v_this_item_weights_np, &amp;__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_30); Py_XDECREF(__pyx_t_31); Py_XDECREF(__pyx_t_32);
            <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
          } else {
            <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_30, __pyx_t_31, __pyx_t_32);
          }
          __pyx_t_30 = __pyx_t_31 = __pyx_t_32 = 0;
        }
        __pyx_pybuffernd_this_item_weights_np.diminfo[0].strides = __pyx_pybuffernd_this_item_weights_np.rcbuffer-&gt;pybuffer.strides[0]; __pyx_pybuffernd_this_item_weights_np.diminfo[0].shape = __pyx_pybuffernd_this_item_weights_np.rcbuffer-&gt;pybuffer.shape[0];
        if (unlikely(__pyx_t_12 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 532, __pyx_L1_error)</span>
      }
      __pyx_t_29 = 0;
      <span class='pyx_macro_api'>__Pyx_XDECREF_SET</span>(__pyx_v_this_item_weights_np, ((PyArrayObject *)__pyx_t_4));
      __pyx_t_4 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">533</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">534</span>:                 <span class="c"># Add weights in the same ordering as the self.this_item_weights_id data structure</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">535</span>:                 <span class="k">for</span> <span class="n">innerItemIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_counter</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_12 = __pyx_v_self-&gt;this_item_weights_counter;
      __pyx_t_18 = __pyx_t_12;
      for (__pyx_t_33 = 0; __pyx_t_33 &lt; __pyx_t_18; __pyx_t_33+=1) {
        __pyx_v_innerItemIndex = __pyx_t_33;
</pre><pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">536</span>:                     <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_id</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span></pre>
<pre class='cython code score-7 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights_id.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 536, __pyx_L1_error)</span>}
        __pyx_t_34 = __pyx_v_innerItemIndex;
        __pyx_t_35 = -1;
        if (__pyx_t_34 &lt; 0) {
          __pyx_t_34 += __pyx_v_self-&gt;this_item_weights_id.shape[0];
          if (unlikely(__pyx_t_34 &lt; 0)) __pyx_t_35 = 0;
        } else if (unlikely(__pyx_t_34 &gt;= __pyx_v_self-&gt;this_item_weights_id.shape[0])) __pyx_t_35 = 0;
        if (unlikely(__pyx_t_35 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_35);
          <span class='error_goto'>__PYX_ERR(0, 536, __pyx_L1_error)</span>
        }
        __pyx_v_item_id = (*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights_id.data + __pyx_t_34 * __pyx_v_self-&gt;this_item_weights_id.strides[0]) )));
</pre><pre class="cython line score-9" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">537</span>:                     <span class="n">this_item_weights_np</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span></pre>
<pre class='cython code score-9 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 537, __pyx_L1_error)</span>}
        __pyx_t_36 = __pyx_v_item_id;
        __pyx_t_35 = -1;
        if (__pyx_t_36 &lt; 0) {
          __pyx_t_36 += __pyx_v_self-&gt;this_item_weights.shape[0];
          if (unlikely(__pyx_t_36 &lt; 0)) __pyx_t_35 = 0;
        } else if (unlikely(__pyx_t_36 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_35 = 0;
        if (unlikely(__pyx_t_35 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_35);
          <span class='error_goto'>__PYX_ERR(0, 537, __pyx_L1_error)</span>
        }
        __pyx_t_37 = __pyx_v_innerItemIndex;
        __pyx_t_35 = -1;
        if (__pyx_t_37 &lt; 0) {
          __pyx_t_37 += __pyx_pybuffernd_this_item_weights_np.diminfo[0].shape;
          if (unlikely(__pyx_t_37 &lt; 0)) __pyx_t_35 = 0;
        } else if (unlikely(__pyx_t_37 &gt;= __pyx_pybuffernd_this_item_weights_np.diminfo[0].shape)) __pyx_t_35 = 0;
        if (unlikely(__pyx_t_35 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_35);
          <span class='error_goto'>__PYX_ERR(0, 537, __pyx_L1_error)</span>
        }
        *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_this_item_weights_np.rcbuffer-&gt;pybuffer.buf, __pyx_t_37, __pyx_pybuffernd_this_item_weights_np.diminfo[0].strides) = (-(*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_36 * __pyx_v_self-&gt;this_item_weights.strides[0]) ))));
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">538</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">539</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">540</span>:                 <span class="n">local_topK</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">TopK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_counter</span><span class="p">])</span></pre>
<pre class='cython code score-0 '>      __pyx_t_12 = __pyx_v_self-&gt;this_item_weights_counter;
      __pyx_t_18 = __pyx_v_self-&gt;TopK;
      if (((__pyx_t_12 &lt; __pyx_t_18) != 0)) {
        __pyx_t_33 = __pyx_t_12;
      } else {
        __pyx_t_33 = __pyx_t_18;
      }
      __pyx_v_local_topK = __pyx_t_33;
</pre><pre class="cython line score-0">&#xA0;<span class="">541</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">542</span>:                 <span class="c"># Get the unordered set of topK items</span></pre>
<pre class="cython line score-69" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">543</span>:                 <span class="n">top_k_partition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">this_item_weights_np</span><span class="p">,</span> <span class="n">local_topK</span><span class="o">-</span><span class="mf">1</span><span class="p">)[</span><span class="mf">0</span><span class="p">:</span><span class="n">local_topK</span><span class="p">]</span></pre>
<pre class='cython code score-69 '>      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 543, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_argpartition);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 543, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>((__pyx_v_local_topK - 1));<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 543, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_5 = NULL;
      __pyx_t_33 = 0;
      if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_14))) {
        __pyx_t_5 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_14);
        if (likely(__pyx_t_5)) {
          PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_14);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_5);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
          <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_14, function);
          __pyx_t_33 = 1;
        }
      }
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_14)) {
        PyObject *__pyx_temp[3] = {__pyx_t_5, ((PyObject *)__pyx_v_this_item_weights_np), __pyx_t_2};
        __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_14, __pyx_temp+1-__pyx_t_33, 2+__pyx_t_33);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 543, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_14)) {
        PyObject *__pyx_temp[3] = {__pyx_t_5, ((PyObject *)__pyx_v_this_item_weights_np), __pyx_t_2};
        __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_14, __pyx_temp+1-__pyx_t_33, 2+__pyx_t_33);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 543, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      } else
      #endif
      {
        __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(2+__pyx_t_33);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 543, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        if (__pyx_t_5) {
          <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_5); __pyx_t_5 = NULL;
        }
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_this_item_weights_np));
        <span class='refnanny'>__Pyx_GIVEREF</span>(((PyObject *)__pyx_v_this_item_weights_np));
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0+__pyx_t_33, ((PyObject *)__pyx_v_this_item_weights_np));
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 1+__pyx_t_33, __pyx_t_2);
        __pyx_t_2 = 0;
        __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_14, __pyx_t_3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 543, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      }
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_GetSlice</span>(__pyx_t_4, 0, __pyx_v_local_topK, NULL, NULL, NULL, 1, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 543, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      if (!(likely(((__pyx_t_14) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_14, __pyx_ptype_5numpy_ndarray))))) <span class='error_goto'>__PYX_ERR(0, 543, __pyx_L1_error)</span>
      __pyx_t_38 = ((PyArrayObject *)__pyx_t_14);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_top_k_partition.rcbuffer-&gt;pybuffer);
        __pyx_t_33 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_top_k_partition.rcbuffer-&gt;pybuffer, (PyObject*)__pyx_t_38, &amp;__Pyx_TypeInfo_long, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
        if (unlikely(__pyx_t_33 &lt; 0)) {
          <span class='py_c_api'>PyErr_Fetch</span>(&amp;__pyx_t_32, &amp;__pyx_t_31, &amp;__pyx_t_30);
          if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_top_k_partition.rcbuffer-&gt;pybuffer, (PyObject*)__pyx_v_top_k_partition, &amp;__Pyx_TypeInfo_long, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_32); Py_XDECREF(__pyx_t_31); Py_XDECREF(__pyx_t_30);
            <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
          } else {
            <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_32, __pyx_t_31, __pyx_t_30);
          }
          __pyx_t_32 = __pyx_t_31 = __pyx_t_30 = 0;
        }
        __pyx_pybuffernd_top_k_partition.diminfo[0].strides = __pyx_pybuffernd_top_k_partition.rcbuffer-&gt;pybuffer.strides[0]; __pyx_pybuffernd_top_k_partition.diminfo[0].shape = __pyx_pybuffernd_top_k_partition.rcbuffer-&gt;pybuffer.shape[0];
        if (unlikely(__pyx_t_33 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 543, __pyx_L1_error)</span>
      }
      __pyx_t_38 = 0;
      <span class='pyx_macro_api'>__Pyx_XDECREF_SET</span>(__pyx_v_top_k_partition, ((PyArrayObject *)__pyx_t_14));
      __pyx_t_14 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">544</span>:                 <span class="c"># Sort only the elements in the partition</span></pre>
<pre class="cython line score-67" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">545</span>:                 <span class="n">top_k_partition_sorting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">this_item_weights_np</span><span class="p">[</span><span class="n">top_k_partition</span><span class="p">])</span></pre>
<pre class='cython code score-67 '>      __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 545, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_argsort);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 545, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetItem</span>(((PyObject *)__pyx_v_this_item_weights_np), ((PyObject *)__pyx_v_top_k_partition));<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 545, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
      __pyx_t_2 = NULL;
      if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_3))) {
        __pyx_t_2 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_3);
        if (likely(__pyx_t_2)) {
          PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_3);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
          <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
          <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_3, function);
        }
      }
      if (!__pyx_t_2) {
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_3, __pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 545, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
      } else {
        #if CYTHON_FAST_PYCALL
        if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_3)) {
          PyObject *__pyx_temp[2] = {__pyx_t_2, __pyx_t_4};
          __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 545, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
        } else
        #endif
        #if CYTHON_FAST_PYCCALL
        if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_3)) {
          PyObject *__pyx_temp[2] = {__pyx_t_2, __pyx_t_4};
          __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 545, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
        } else
        #endif
        {
          __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 545, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
          <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
          <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
          <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+1, __pyx_t_4);
          __pyx_t_4 = 0;
          __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 545, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        }
      }
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      if (!(likely(((__pyx_t_14) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_14, __pyx_ptype_5numpy_ndarray))))) <span class='error_goto'>__PYX_ERR(0, 545, __pyx_L1_error)</span>
      __pyx_t_38 = ((PyArrayObject *)__pyx_t_14);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_top_k_partition_sorting.rcbuffer-&gt;pybuffer);
        __pyx_t_33 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_top_k_partition_sorting.rcbuffer-&gt;pybuffer, (PyObject*)__pyx_t_38, &amp;__Pyx_TypeInfo_long, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
        if (unlikely(__pyx_t_33 &lt; 0)) {
          <span class='py_c_api'>PyErr_Fetch</span>(&amp;__pyx_t_30, &amp;__pyx_t_31, &amp;__pyx_t_32);
          if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_top_k_partition_sorting.rcbuffer-&gt;pybuffer, (PyObject*)__pyx_v_top_k_partition_sorting, &amp;__Pyx_TypeInfo_long, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_30); Py_XDECREF(__pyx_t_31); Py_XDECREF(__pyx_t_32);
            <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
          } else {
            <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_30, __pyx_t_31, __pyx_t_32);
          }
          __pyx_t_30 = __pyx_t_31 = __pyx_t_32 = 0;
        }
        __pyx_pybuffernd_top_k_partition_sorting.diminfo[0].strides = __pyx_pybuffernd_top_k_partition_sorting.rcbuffer-&gt;pybuffer.strides[0]; __pyx_pybuffernd_top_k_partition_sorting.diminfo[0].shape = __pyx_pybuffernd_top_k_partition_sorting.rcbuffer-&gt;pybuffer.shape[0];
        if (unlikely(__pyx_t_33 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 545, __pyx_L1_error)</span>
      }
      __pyx_t_38 = 0;
      <span class='pyx_macro_api'>__Pyx_XDECREF_SET</span>(__pyx_v_top_k_partition_sorting, ((PyArrayObject *)__pyx_t_14));
      __pyx_t_14 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">546</span>:                 <span class="c"># Get original index</span></pre>
<pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">547</span>:                 <span class="n">top_k_idx</span> <span class="o">=</span> <span class="n">top_k_partition</span><span class="p">[</span><span class="n">top_k_partition_sorting</span><span class="p">]</span></pre>
<pre class='cython code score-5 '>      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_GetItem</span>(((PyObject *)__pyx_v_top_k_partition), ((PyObject *)__pyx_v_top_k_partition_sorting));<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 547, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
      __pyx_t_39 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_PY_LONG_LONG</span>(__pyx_t_14, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_39.memview)) __PYX_ERR(0, 547, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_v_top_k_idx, 1);
      __pyx_v_top_k_idx = __pyx_t_39;
      __pyx_t_39.memview = NULL;
      __pyx_t_39.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">548</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">549</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">550</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">551</span>:                 <span class="c"># Incrementally build sparse matrix, do not add zeros</span></pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">552</span>:                 <span class="k">for</span> <span class="n">innerItemIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_k_idx</span><span class="p">)):</span></pre>
<pre class='cython code score-2 '>      __pyx_t_40 = <span class='pyx_c_api'>__Pyx_MemoryView_Len</span>(__pyx_v_top_k_idx); 
      __pyx_t_41 = __pyx_t_40;
      for (__pyx_t_33 = 0; __pyx_t_33 &lt; __pyx_t_41; __pyx_t_33+=1) {
        __pyx_v_innerItemIndex = __pyx_t_33;
</pre><pre class="cython line score-0">&#xA0;<span class="">553</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">554</span>:                     <span class="n">topKItemIndex</span> <span class="o">=</span> <span class="n">top_k_idx</span><span class="p">[</span><span class="n">innerItemIndex</span><span class="p">]</span></pre>
<pre class='cython code score-2 '>        __pyx_t_42 = __pyx_v_innerItemIndex;
        __pyx_t_12 = -1;
        if (__pyx_t_42 &lt; 0) {
          __pyx_t_42 += __pyx_v_top_k_idx.shape[0];
          if (unlikely(__pyx_t_42 &lt; 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_42 &gt;= __pyx_v_top_k_idx.shape[0])) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_12);
          <span class='error_goto'>__PYX_ERR(0, 554, __pyx_L1_error)</span>
        }
        __pyx_v_topKItemIndex = (*((PY_LONG_LONG *) ( /* dim=0 */ (__pyx_v_top_k_idx.data + __pyx_t_42 * __pyx_v_top_k_idx.strides[0]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">555</span>: </pre>
<pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">556</span>:                     <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights_id</span><span class="p">[</span><span class="n">topKItemIndex</span><span class="p">]</span></pre>
<pre class='cython code score-7 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights_id.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 556, __pyx_L1_error)</span>}
        __pyx_t_43 = __pyx_v_topKItemIndex;
        __pyx_t_12 = -1;
        if (__pyx_t_43 &lt; 0) {
          __pyx_t_43 += __pyx_v_self-&gt;this_item_weights_id.shape[0];
          if (unlikely(__pyx_t_43 &lt; 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_43 &gt;= __pyx_v_self-&gt;this_item_weights_id.shape[0])) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_12);
          <span class='error_goto'>__PYX_ERR(0, 556, __pyx_L1_error)</span>
        }
        __pyx_v_item_id = (*((int *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights_id.data + __pyx_t_43 * __pyx_v_self-&gt;this_item_weights_id.strides[0]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">557</span>: </pre>
<pre class="cython line score-7" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">558</span>:                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span></pre>
<pre class='cython code score-7 '>        if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 558, __pyx_L1_error)</span>}
        __pyx_t_44 = __pyx_v_item_id;
        __pyx_t_12 = -1;
        if (__pyx_t_44 &lt; 0) {
          __pyx_t_44 += __pyx_v_self-&gt;this_item_weights.shape[0];
          if (unlikely(__pyx_t_44 &lt; 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_44 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_12);
          <span class='error_goto'>__PYX_ERR(0, 558, __pyx_L1_error)</span>
        }
        __pyx_t_9 = (((*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_44 * __pyx_v_self-&gt;this_item_weights.strides[0]) ))) != 0.0) != 0);
        if (__pyx_t_9) {
/* … */
        }
      }
    }
    __pyx_L26:;
</pre><pre class="cython line score-0">&#xA0;<span class="">559</span>: </pre>
<pre class="cython line score-9" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">560</span>:                         <span class="n">values</span><span class="p">[</span><span class="n">sparse_data_pointer</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_item_weights</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span></pre>
<pre class='cython code score-9 '>          if (unlikely(!__pyx_v_self-&gt;this_item_weights.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 560, __pyx_L1_error)</span>}
          __pyx_t_45 = __pyx_v_item_id;
          __pyx_t_12 = -1;
          if (__pyx_t_45 &lt; 0) {
            __pyx_t_45 += __pyx_v_self-&gt;this_item_weights.shape[0];
            if (unlikely(__pyx_t_45 &lt; 0)) __pyx_t_12 = 0;
          } else if (unlikely(__pyx_t_45 &gt;= __pyx_v_self-&gt;this_item_weights.shape[0])) __pyx_t_12 = 0;
          if (unlikely(__pyx_t_12 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_12);
            <span class='error_goto'>__PYX_ERR(0, 560, __pyx_L1_error)</span>
          }
          __pyx_t_46 = __pyx_v_sparse_data_pointer;
          __pyx_t_12 = -1;
          if (__pyx_t_46 &lt; 0) {
            __pyx_t_46 += __pyx_v_values.shape[0];
            if (unlikely(__pyx_t_46 &lt; 0)) __pyx_t_12 = 0;
          } else if (unlikely(__pyx_t_46 &gt;= __pyx_v_values.shape[0])) __pyx_t_12 = 0;
          if (unlikely(__pyx_t_12 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_12);
            <span class='error_goto'>__PYX_ERR(0, 560, __pyx_L1_error)</span>
          }
          *((double *) ( /* dim=0 */ (__pyx_v_values.data + __pyx_t_46 * __pyx_v_values.strides[0]) )) = (*((double *) ( /* dim=0 */ (__pyx_v_self-&gt;this_item_weights.data + __pyx_t_45 * __pyx_v_self-&gt;this_item_weights.strides[0]) )));
</pre><pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">561</span>:                         <span class="n">rows</span><span class="p">[</span><span class="n">sparse_data_pointer</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_id</span></pre>
<pre class='cython code score-2 '>          __pyx_t_47 = __pyx_v_sparse_data_pointer;
          __pyx_t_12 = -1;
          if (__pyx_t_47 &lt; 0) {
            __pyx_t_47 += __pyx_v_rows.shape[0];
            if (unlikely(__pyx_t_47 &lt; 0)) __pyx_t_12 = 0;
          } else if (unlikely(__pyx_t_47 &gt;= __pyx_v_rows.shape[0])) __pyx_t_12 = 0;
          if (unlikely(__pyx_t_12 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_12);
            <span class='error_goto'>__PYX_ERR(0, 561, __pyx_L1_error)</span>
          }
          *((int *) ( /* dim=0 */ (__pyx_v_rows.data + __pyx_t_47 * __pyx_v_rows.strides[0]) )) = __pyx_v_item_id;
</pre><pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">562</span>:                         <span class="n">cols</span><span class="p">[</span><span class="n">sparse_data_pointer</span><span class="p">]</span> <span class="o">=</span> <span class="n">itemIndex</span></pre>
<pre class='cython code score-2 '>          __pyx_t_48 = __pyx_v_sparse_data_pointer;
          __pyx_t_12 = -1;
          if (__pyx_t_48 &lt; 0) {
            __pyx_t_48 += __pyx_v_cols.shape[0];
            if (unlikely(__pyx_t_48 &lt; 0)) __pyx_t_12 = 0;
          } else if (unlikely(__pyx_t_48 &gt;= __pyx_v_cols.shape[0])) __pyx_t_12 = 0;
          if (unlikely(__pyx_t_12 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_12);
            <span class='error_goto'>__PYX_ERR(0, 562, __pyx_L1_error)</span>
          }
          *((int *) ( /* dim=0 */ (__pyx_v_cols.data + __pyx_t_48 * __pyx_v_cols.strides[0]) )) = __pyx_v_itemIndex;
</pre><pre class="cython line score-0">&#xA0;<span class="">563</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">564</span>:                         <span class="n">sparse_data_pointer</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>          __pyx_v_sparse_data_pointer = (__pyx_v_sparse_data_pointer + 1);
</pre><pre class="cython line score-0">&#xA0;<span class="">565</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">566</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">567</span>:             <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>    __pyx_v_itemIndex = (__pyx_v_itemIndex + 1);
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">568</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">569</span>:         <span class="c"># End while on columns</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">570</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">571</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">572</span>:         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TopK</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_9 = ((__pyx_v_self-&gt;TopK == 0) != 0);
  if (__pyx_t_9) {
/* … */
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">573</span>: </pre>
<pre class="cython line score-50" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">574</span>:             <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_dense</span><span class="p">)</span></pre>
<pre class='cython code score-50 '>    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 574, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 574, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    if (unlikely(!__pyx_v_self-&gt;W_dense.memview)) {<span class='py_c_api'>PyErr_SetString</span>(PyExc_AttributeError,"Memoryview is not initialized");<span class='error_goto'>__PYX_ERR(0, 574, __pyx_L1_error)</span>}
    __pyx_t_3 = __pyx_memoryview_fromslice(__pyx_v_self-&gt;W_dense, 2, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 574, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    __pyx_t_4 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_5))) {
      __pyx_t_4 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_5);
      if (likely(__pyx_t_4)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_5);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_4);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_5, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_5, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 574, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_5)) {
        PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_t_3};
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_5, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 574, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_5)) {
        PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_t_3};
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_5, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 574, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      } else
      #endif
      {
        __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 574, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_5, __pyx_t_2, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 574, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_r = __pyx_t_14;
    __pyx_t_14 = 0;
    goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">575</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">576</span>:         <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">577</span>: </pre>
<pre class="cython line score-47" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">578</span>:             <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mf">0</span><span class="p">:</span><span class="n">sparse_data_pointer</span><span class="p">])</span></pre>
<pre class='cython code score-47 '>  /*else*/ {
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_5, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_6.data = __pyx_v_values.data;
    __pyx_t_6.memview = __pyx_v_values.memview;
    __PYX_INC_MEMVIEW(&amp;__pyx_t_6, 0);
    __pyx_t_33 = -1;
    if (unlikely(__pyx_memoryview_slice_memviewslice(
    &amp;__pyx_t_6,
    __pyx_v_values.shape[0], __pyx_v_values.strides[0], __pyx_v_values.suboffsets[0],
    0,
    0,
    &amp;__pyx_t_33,
    0,
    __pyx_v_sparse_data_pointer,
    0,
    1,
    1,
    0,
    1) &lt; 0))
{
    <span class='error_goto'>__PYX_ERR(0, 578, __pyx_L1_error)</span>
}

__pyx_t_5 = __pyx_memoryview_fromslice(__pyx_t_6, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
    __pyx_t_6.memview = NULL;
    __pyx_t_6.data = NULL;
    __pyx_t_3 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
      __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
      if (likely(__pyx_t_3)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_2, __pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_2)) {
        PyObject *__pyx_temp[2] = {__pyx_t_3, __pyx_t_5};
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_2)) {
        PyObject *__pyx_temp[2] = {__pyx_t_3, __pyx_t_5};
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      } else
      #endif
      {
        __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0+1, __pyx_t_5);
        __pyx_t_5 = 0;
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_4, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_14, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_6.memview)) __PYX_ERR(0, 578, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
    __PYX_XDEC_MEMVIEW(&amp;__pyx_v_values, 1);
    __pyx_v_values = __pyx_t_6;
    __pyx_t_6.memview = NULL;
    __pyx_t_6.data = NULL;
</pre><pre class="cython line score-47" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">579</span>:             <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mf">0</span><span class="p">:</span><span class="n">sparse_data_pointer</span><span class="p">])</span></pre>
<pre class='cython code score-47 '>    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_7.data = __pyx_v_rows.data;
    __pyx_t_7.memview = __pyx_v_rows.memview;
    __PYX_INC_MEMVIEW(&amp;__pyx_t_7, 0);
    __pyx_t_33 = -1;
    if (unlikely(__pyx_memoryview_slice_memviewslice(
    &amp;__pyx_t_7,
    __pyx_v_rows.shape[0], __pyx_v_rows.strides[0], __pyx_v_rows.suboffsets[0],
    0,
    0,
    &amp;__pyx_t_33,
    0,
    __pyx_v_sparse_data_pointer,
    0,
    1,
    1,
    0,
    1) &lt; 0))
{
    <span class='error_goto'>__PYX_ERR(0, 579, __pyx_L1_error)</span>
}

__pyx_t_2 = __pyx_memoryview_fromslice(__pyx_t_7, 1, (PyObject *(*)(char *)) __pyx_memview_get_int, (int (*)(char *, PyObject *)) __pyx_memview_set_int, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
    __pyx_t_7.memview = NULL;
    __pyx_t_7.data = NULL;
    __pyx_t_5 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_4))) {
      __pyx_t_5 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_4);
      if (likely(__pyx_t_5)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_4);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_5);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_5) {
      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_4, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_4)) {
        PyObject *__pyx_temp[2] = {__pyx_t_5, __pyx_t_2};
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_4, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_4)) {
        PyObject *__pyx_temp[2] = {__pyx_t_5, __pyx_t_2};
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_4, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      } else
      #endif
      {
        __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_5); __pyx_t_5 = NULL;
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0+1, __pyx_t_2);
        __pyx_t_2 = 0;
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_4, __pyx_t_3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_14, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_7.memview)) __PYX_ERR(0, 579, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
    __PYX_XDEC_MEMVIEW(&amp;__pyx_v_rows, 1);
    __pyx_v_rows = __pyx_t_7;
    __pyx_t_7.memview = NULL;
    __pyx_t_7.data = NULL;
</pre><pre class="cython line score-47" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">580</span>:             <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mf">0</span><span class="p">:</span><span class="n">sparse_data_pointer</span><span class="p">])</span></pre>
<pre class='cython code score-47 '>    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_7.data = __pyx_v_cols.data;
    __pyx_t_7.memview = __pyx_v_cols.memview;
    __PYX_INC_MEMVIEW(&amp;__pyx_t_7, 0);
    __pyx_t_33 = -1;
    if (unlikely(__pyx_memoryview_slice_memviewslice(
    &amp;__pyx_t_7,
    __pyx_v_cols.shape[0], __pyx_v_cols.strides[0], __pyx_v_cols.suboffsets[0],
    0,
    0,
    &amp;__pyx_t_33,
    0,
    __pyx_v_sparse_data_pointer,
    0,
    1,
    1,
    0,
    1) &lt; 0))
{
    <span class='error_goto'>__PYX_ERR(0, 580, __pyx_L1_error)</span>
}

__pyx_t_4 = __pyx_memoryview_fromslice(__pyx_t_7, 1, (PyObject *(*)(char *)) __pyx_memview_get_int, (int (*)(char *, PyObject *)) __pyx_memview_set_int, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
    __pyx_t_7.memview = NULL;
    __pyx_t_7.data = NULL;
    __pyx_t_2 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_3))) {
      __pyx_t_2 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_3);
      if (likely(__pyx_t_2)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_3, __pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_3)) {
        PyObject *__pyx_temp[2] = {__pyx_t_2, __pyx_t_4};
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_3)) {
        PyObject *__pyx_temp[2] = {__pyx_t_2, __pyx_t_4};
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      } else
      #endif
      {
        __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+1, __pyx_t_4);
        __pyx_t_4 = 0;
        __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_14, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_7.memview)) __PYX_ERR(0, 580, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
    __PYX_XDEC_MEMVIEW(&amp;__pyx_v_cols, 1);
    __pyx_v_cols = __pyx_t_7;
    __pyx_t_7.memview = NULL;
    __pyx_t_7.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">581</span>: </pre>
<pre class="cython line score-30" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">582</span>:             <span class="n">W_sparse</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span></pre>
<pre class='cython code score-30 '>    __pyx_t_14 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_sps);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_14, __pyx_n_s_csr_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_14); __pyx_t_14 = 0;
    __pyx_t_14 = __pyx_memoryview_fromslice(__pyx_v_values, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
    __pyx_t_5 = __pyx_memoryview_fromslice(__pyx_v_rows, 1, (PyObject *(*)(char *)) __pyx_memview_get_int, (int (*)(char *, PyObject *)) __pyx_memview_set_int, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    __pyx_t_4 = __pyx_memoryview_fromslice(__pyx_v_cols, 1, (PyObject *(*)(char *)) __pyx_memview_get_int, (int (*)(char *, PyObject *)) __pyx_memview_set_int, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_t_5);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 1, __pyx_t_4);
    __pyx_t_5 = 0;
    __pyx_t_4 = 0;
    __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_14);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_14);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_2);
    __pyx_t_14 = 0;
    __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_t_4);
    __pyx_t_4 = 0;
/* … */
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_2, __pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 582, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_v_W_sparse = __pyx_t_5;
    __pyx_t_5 = 0;
</pre><pre class="cython line score-19" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">583</span>:                                     <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_columns</span><span class="p">),</span></pre>
<pre class='cython code score-19 '>    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 583, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 583, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyInt_From_long</span>(__pyx_v_self-&gt;n_columns);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 583, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 583, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_14);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_14);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 1, __pyx_t_5);
    __pyx_t_14 = 0;
    __pyx_t_5 = 0;
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_4, __pyx_n_s_shape, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 583, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-11" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">584</span>:                                     <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></pre>
<pre class='cython code score-11 '>    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 584, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_float32);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 584, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_5) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 583, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">585</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">586</span>:             <span class="k">return</span> <span class="n">W_sparse</span></pre>
<pre class='cython code score-2 '>    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_W_sparse);
    __pyx_r = __pyx_v_W_sparse;
    goto __pyx_L0;
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">587</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">588</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">589</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">590</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">591</span>: </pre>
<pre class="cython line score-37" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">592</span>: <span class="k">def</span> <span class="nf">cosine_common</span><span class="p">(</span><span class="n">X</span><span class="p">):</span></pre>
<pre class='cython code score-37 '>/* Python wrapper */
static PyObject *__pyx_pw_25Compute_Similarity_Cython_1cosine_common(PyObject *__pyx_self, PyObject *__pyx_v_X); /*proto*/
static char __pyx_doc_25Compute_Similarity_Cython_cosine_common[] = "\n    Function that pairwise cosine similarity of the columns in X.\n    It takes only the values in common between each pair of columns\n    :param X: instance of scipy.sparse.csc_matrix\n    :return:\n        the result of co_prodsum\n        the number of co_rated elements for every column pair\n    ";
static PyMethodDef __pyx_mdef_25Compute_Similarity_Cython_1cosine_common = {"cosine_common", (PyCFunction)__pyx_pw_25Compute_Similarity_Cython_1cosine_common, METH_O, __pyx_doc_25Compute_Similarity_Cython_cosine_common};
static PyObject *__pyx_pw_25Compute_Similarity_Cython_1cosine_common(PyObject *__pyx_self, PyObject *__pyx_v_X) {
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("cosine_common (wrapper)", 0);
  __pyx_r = __pyx_pf_25Compute_Similarity_Cython_cosine_common(__pyx_self, ((PyObject *)__pyx_v_X));

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_25Compute_Similarity_Cython_cosine_common(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_X) {
  __Pyx_memviewslice __pyx_v_indices = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_indptr = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_data = { 0, 0, { 0 }, { 0 }, { 0 } };
  int __pyx_v_n_cols;
  PyArrayObject *__pyx_v_result = 0;
  PyArrayObject *__pyx_v_common = 0;
  int __pyx_v_current_col;
  int __pyx_v_second_col;
  int __pyx_v_n_i;
  int __pyx_v_n_j;
  int __pyx_v_ii;
  int __pyx_v_jj;
  int __pyx_v_n_common;
  float __pyx_v_ii_sum;
  float __pyx_v_jj_sum;
  float __pyx_v_ij_sum;
  float __pyx_v_x_i;
  float __pyx_v_x_j;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_common;
  __Pyx_Buffer __pyx_pybuffer_common;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_result;
  __Pyx_Buffer __pyx_pybuffer_result;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("cosine_common", 0);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_X);
  __pyx_pybuffer_result.pybuffer.buf = NULL;
  __pyx_pybuffer_result.refcount = 0;
  __pyx_pybuffernd_result.data = NULL;
  __pyx_pybuffernd_result.rcbuffer = &amp;__pyx_pybuffer_result;
  __pyx_pybuffer_common.pybuffer.buf = NULL;
  __pyx_pybuffer_common.refcount = 0;
  __pyx_pybuffernd_common.data = NULL;
  __pyx_pybuffernd_common.rcbuffer = &amp;__pyx_pybuffer_common;
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_39);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&amp;__pyx_type, &amp;__pyx_value, &amp;__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_common.rcbuffer-&gt;pybuffer);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_result.rcbuffer-&gt;pybuffer);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.cosine_common", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_common.rcbuffer-&gt;pybuffer);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_result.rcbuffer-&gt;pybuffer);
  __pyx_L2:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_indices, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_indptr, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_data, 1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>((PyObject *)__pyx_v_result);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>((PyObject *)__pyx_v_common);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_X);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__35 = <span class='py_c_api'>PyTuple_Pack</span>(19, __pyx_n_s_X, __pyx_n_s_indices, __pyx_n_s_indptr, __pyx_n_s_data, __pyx_n_s_n_cols, __pyx_n_s_result, __pyx_n_s_common, __pyx_n_s_current_col, __pyx_n_s_second_col, __pyx_n_s_n_i, __pyx_n_s_n_j, __pyx_n_s_ii, __pyx_n_s_jj, __pyx_n_s_n_common, __pyx_n_s_ii_sum, __pyx_n_s_jj_sum, __pyx_n_s_ij_sum, __pyx_n_s_x_i, __pyx_n_s_x_j);<span class='error_goto'> if (unlikely(!__pyx_tuple__35)) __PYX_ERR(0, 592, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__35);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__35);
/* … */
  __pyx_t_1 = PyCFunction_NewEx(&amp;__pyx_mdef_25Compute_Similarity_Cython_1cosine_common, NULL, __pyx_n_s_Compute_Similarity_Cython);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 592, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_cosine_common, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 592, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_codeobj__36 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(1, 0, 19, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__35, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_Compute_Similarity_Cython_pyx, __pyx_n_s_cosine_common, 592, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__36)) __PYX_ERR(0, 592, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">593</span>:     <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">594</span>: <span class="sd">    Function that pairwise cosine similarity of the columns in X.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">595</span>: <span class="sd">    It takes only the values in common between each pair of columns</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">596</span>: <span class="sd">    :param X: instance of scipy.sparse.csc_matrix</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">597</span>: <span class="sd">    :return:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">598</span>: <span class="sd">        the result of co_prodsum</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">599</span>: <span class="sd">        the number of co_rated elements for every column pair</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">600</span>: <span class="sd">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">601</span>: </pre>
<pre class="cython line score-40" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">602</span>:     <span class="n">X</span> <span class="o">=</span> <span class="n">check_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="s">&#39;csc&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-40 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_check_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 602, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = NULL;
  __pyx_t_4 = 0;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
    __pyx_t_3 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
      __pyx_t_4 = 1;
    }
  }
  #if CYTHON_FAST_PYCALL
  if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_2)) {
    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_X, __pyx_n_s_csc};
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 602, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else
  #endif
  #if CYTHON_FAST_PYCCALL
  if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_2)) {
    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_X, __pyx_n_s_csc};
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 602, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else
  #endif
  {
    __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(2+__pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 602, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    if (__pyx_t_3) {
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
    }
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_X);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_X);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+__pyx_t_4, __pyx_v_X);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s_csc);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s_csc);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 1+__pyx_t_4, __pyx_n_s_csc);
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 602, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_X, __pyx_t_1);
  __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">603</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">604</span>:     <span class="c"># use Cython MemoryViews for fast access to the sparse structure of X</span></pre>
<pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">605</span>:     <span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:]</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">indices</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_X, __pyx_n_s_indices);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 605, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_6.memview)) __PYX_ERR(0, 605, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_indices = __pyx_t_6;
  __pyx_t_6.memview = NULL;
  __pyx_t_6.data = NULL;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">606</span>:     <span class="k">cdef</span> <span class="kt">int</span> [<span class="p">:]</span> <span class="n">indptr</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">indptr</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_X, __pyx_n_s_indptr);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 606, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_int</span>(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_6.memview)) __PYX_ERR(0, 606, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_indptr = __pyx_t_6;
  __pyx_t_6.memview = NULL;
  __pyx_t_6.data = NULL;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">607</span>:     <span class="k">cdef</span> <span class="kt">float</span> [<span class="p">:]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">data</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_X, __pyx_n_s_data);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 607, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_float</span>(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_7.memview)) __PYX_ERR(0, 607, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_data = __pyx_t_7;
  __pyx_t_7.memview = NULL;
  __pyx_t_7.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">608</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">609</span>:     <span class="c"># initialize the result variables</span></pre>
<pre class="cython line score-13" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">610</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n_cols</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-13 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_X, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 610, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 610, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyInt_As_int</span>(__pyx_t_2); if (unlikely((__pyx_t_4 == (int)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 610, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_n_cols = __pyx_t_4;
</pre><pre class="cython line score-45" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">611</span>:     <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span>[<span class="kt">np</span>.<span class="nf">float32_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></pre>
<pre class='cython code score-45 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyInt_From_int</span>(__pyx_v_n_cols);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyInt_From_int</span>(__pyx_v_n_cols);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_t_3 = <span class='py_c_api'>PyList_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_3, 1, __pyx_t_5);
  __pyx_t_2 = 0;
  __pyx_t_5 = 0;
  __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_3);
  __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float32);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_8) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_1, __pyx_t_5, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 611, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_8) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_8, __pyx_ptype_5numpy_ndarray))))) <span class='error_goto'>__PYX_ERR(0, 611, __pyx_L1_error)</span>
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_8);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_result.rcbuffer-&gt;pybuffer, (PyObject*)__pyx_t_9, &amp;__Pyx_TypeInfo_nn___pyx_t_5numpy_float32_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_result = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None); __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.buf = NULL;
      <span class='error_goto'>__PYX_ERR(0, 611, __pyx_L1_error)</span>
    } else {__pyx_pybuffernd_result.diminfo[0].strides = __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.strides[0]; __pyx_pybuffernd_result.diminfo[0].shape = __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.shape[0]; __pyx_pybuffernd_result.diminfo[1].strides = __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.strides[1]; __pyx_pybuffernd_result.diminfo[1].shape = __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.shape[1];
    }
  }
  __pyx_t_9 = 0;
  __pyx_v_result = ((PyArrayObject *)__pyx_t_8);
  __pyx_t_8 = 0;
</pre><pre class="cython line score-45" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">612</span>:     <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span>[<span class="kt">np</span>.<span class="nf">int32_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">]</span> <span class="n">common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></pre>
<pre class='cython code score-45 '>  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_8, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyInt_From_int</span>(__pyx_v_n_cols);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyInt_From_int</span>(__pyx_v_n_cols);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_t_1 = <span class='py_c_api'>PyList_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_8);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_8);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_1, 1, __pyx_t_5);
  __pyx_t_8 = 0;
  __pyx_t_5 = 0;
  __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_1);
  __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_8, __pyx_n_s_int32);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_5, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 612, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) <span class='error_goto'>__PYX_ERR(0, 612, __pyx_L1_error)</span>
  __pyx_t_10 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_common.rcbuffer-&gt;pybuffer, (PyObject*)__pyx_t_10, &amp;__Pyx_TypeInfo_nn___pyx_t_5numpy_int32_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_common = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None); __pyx_pybuffernd_common.rcbuffer-&gt;pybuffer.buf = NULL;
      <span class='error_goto'>__PYX_ERR(0, 612, __pyx_L1_error)</span>
    } else {__pyx_pybuffernd_common.diminfo[0].strides = __pyx_pybuffernd_common.rcbuffer-&gt;pybuffer.strides[0]; __pyx_pybuffernd_common.diminfo[0].shape = __pyx_pybuffernd_common.rcbuffer-&gt;pybuffer.shape[0]; __pyx_pybuffernd_common.diminfo[1].strides = __pyx_pybuffernd_common.rcbuffer-&gt;pybuffer.strides[1]; __pyx_pybuffernd_common.diminfo[1].shape = __pyx_pybuffernd_common.rcbuffer-&gt;pybuffer.shape[1];
    }
  }
  __pyx_t_10 = 0;
  __pyx_v_common = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">613</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">614</span>:     <span class="c"># let&#39;s declare all the variables that we&#39;ll use in the loop here</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">615</span>:     <span class="c"># NOTE: declaring the type of your variables makes your Cython code run MUCH faster</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">616</span>:     <span class="c"># NOTE: Cython allows cdef&#39;s only in the main scope</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">617</span>:     <span class="c"># cdef&#39;s in nested codes will result in compilation errors</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">618</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">current_col</span><span class="p">,</span> <span class="nf">second_col</span><span class="p">,</span> <span class="nf">n_i</span><span class="p">,</span> <span class="nf">n_j</span><span class="p">,</span> <span class="nf">ii</span><span class="p">,</span> <span class="nf">jj</span><span class="p">,</span> <span class="nf">n_common</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">619</span>:     <span class="k">cdef</span> <span class="kt">float</span> <span class="nf">ii_sum</span><span class="p">,</span> <span class="nf">jj_sum</span><span class="p">,</span> <span class="nf">ij_sum</span><span class="p">,</span> <span class="nf">x_i</span><span class="p">,</span> <span class="nf">x_j</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">620</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">621</span>:     <span class="k">for</span> <span class="n">current_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>  __pyx_t_4 = __pyx_v_n_cols;
  __pyx_t_11 = __pyx_t_4;
  for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_11; __pyx_t_12+=1) {
    __pyx_v_current_col = __pyx_t_12;
</pre><pre class="cython line score-4" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">622</span>:         <span class="n">n_i</span> <span class="o">=</span> <span class="n">indptr</span><span class="p">[</span><span class="n">current_col</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indptr</span><span class="p">[</span><span class="n">current_col</span><span class="p">]</span></pre>
<pre class='cython code score-4 '>    __pyx_t_13 = (__pyx_v_current_col + 1);
    __pyx_t_14 = -1;
    if (__pyx_t_13 &lt; 0) {
      __pyx_t_13 += __pyx_v_indptr.shape[0];
      if (unlikely(__pyx_t_13 &lt; 0)) __pyx_t_14 = 0;
    } else if (unlikely(__pyx_t_13 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_14 = 0;
    if (unlikely(__pyx_t_14 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_14);
      <span class='error_goto'>__PYX_ERR(0, 622, __pyx_L1_error)</span>
    }
    __pyx_t_15 = __pyx_v_current_col;
    __pyx_t_14 = -1;
    if (__pyx_t_15 &lt; 0) {
      __pyx_t_15 += __pyx_v_indptr.shape[0];
      if (unlikely(__pyx_t_15 &lt; 0)) __pyx_t_14 = 0;
    } else if (unlikely(__pyx_t_15 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_14 = 0;
    if (unlikely(__pyx_t_14 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_14);
      <span class='error_goto'>__PYX_ERR(0, 622, __pyx_L1_error)</span>
    }
    __pyx_v_n_i = ((*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_13 * __pyx_v_indptr.strides[0]) ))) - (*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_15 * __pyx_v_indptr.strides[0]) ))));
</pre><pre class="cython line score-0">&#xA0;<span class="">623</span>:         <span class="c"># the correlation matrix is symmetric,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">624</span>:         <span class="c"># let&#39;s compute only the values for the upper-right triangle</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">625</span>:         <span class="k">for</span> <span class="n">second_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">current_col</span><span class="o">+</span><span class="mf">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>    __pyx_t_14 = __pyx_v_n_cols;
    __pyx_t_16 = __pyx_t_14;
    for (__pyx_t_17 = (__pyx_v_current_col + 1); __pyx_t_17 &lt; __pyx_t_16; __pyx_t_17+=1) {
      __pyx_v_second_col = __pyx_t_17;
</pre><pre class="cython line score-4" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">626</span>:             <span class="n">n_j</span> <span class="o">=</span> <span class="n">indptr</span><span class="p">[</span><span class="n">second_col</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indptr</span><span class="p">[</span><span class="n">second_col</span><span class="p">]</span></pre>
<pre class='cython code score-4 '>      __pyx_t_18 = (__pyx_v_second_col + 1);
      __pyx_t_19 = -1;
      if (__pyx_t_18 &lt; 0) {
        __pyx_t_18 += __pyx_v_indptr.shape[0];
        if (unlikely(__pyx_t_18 &lt; 0)) __pyx_t_19 = 0;
      } else if (unlikely(__pyx_t_18 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_19 = 0;
      if (unlikely(__pyx_t_19 != -1)) {
        <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_19);
        <span class='error_goto'>__PYX_ERR(0, 626, __pyx_L1_error)</span>
      }
      __pyx_t_20 = __pyx_v_second_col;
      __pyx_t_19 = -1;
      if (__pyx_t_20 &lt; 0) {
        __pyx_t_20 += __pyx_v_indptr.shape[0];
        if (unlikely(__pyx_t_20 &lt; 0)) __pyx_t_19 = 0;
      } else if (unlikely(__pyx_t_20 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_19 = 0;
      if (unlikely(__pyx_t_19 != -1)) {
        <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_19);
        <span class='error_goto'>__PYX_ERR(0, 626, __pyx_L1_error)</span>
      }
      __pyx_v_n_j = ((*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_18 * __pyx_v_indptr.strides[0]) ))) - (*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_20 * __pyx_v_indptr.strides[0]) ))));
</pre><pre class="cython line score-0">&#xA0;<span class="">627</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">628</span>:             <span class="n">ij_sum</span><span class="p">,</span> <span class="n">ii_sum</span><span class="p">,</span> <span class="n">jj_sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span></pre>
<pre class='cython code score-0 '>      __pyx_t_21 = 0.0;
      __pyx_t_22 = 0.0;
      __pyx_t_23 = 0.0;
      __pyx_v_ij_sum = __pyx_t_21;
      __pyx_v_ii_sum = __pyx_t_22;
      __pyx_v_jj_sum = __pyx_t_23;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">629</span>:             <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">=</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>      __pyx_t_19 = 0;
      __pyx_t_24 = 0;
      __pyx_v_ii = __pyx_t_19;
      __pyx_v_jj = __pyx_t_24;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">630</span>:             <span class="n">n_common</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>      __pyx_v_n_common = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">631</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">632</span>:             <span class="c"># here we exploit the fact that the two subvectors in indices are sorted</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">633</span>:             <span class="c"># to compute the dot product of the rows in common between i and j in linear time.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">634</span>:             <span class="c"># (indices[indptr[i]:indptr[i]+n_i] and indices[indptr[j]:indptr[j]+n_j]</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">635</span>:             <span class="c"># contain the row indices of the non-zero items in columns i and j)</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">636</span>:             <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">n_i</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="n">n_j</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>      while (1) {
        __pyx_t_26 = ((__pyx_v_ii &lt; __pyx_v_n_i) != 0);
        if (__pyx_t_26) {
        } else {
          __pyx_t_25 = __pyx_t_26;
          goto __pyx_L9_bool_binop_done;
        }
        __pyx_t_26 = ((__pyx_v_jj &lt; __pyx_v_n_j) != 0);
        __pyx_t_25 = __pyx_t_26;
        __pyx_L9_bool_binop_done:;
        if (!__pyx_t_25) break;
</pre><pre class="cython line score-8" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">637</span>:                 <span class="k">if</span> <span class="n">indices</span><span class="p">[</span><span class="n">indptr</span><span class="p">[</span><span class="n">current_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">indices</span><span class="p">[</span><span class="n">indptr</span><span class="p">[</span><span class="n">second_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]:</span></pre>
<pre class='cython code score-8 '>        __pyx_t_27 = __pyx_v_current_col;
        __pyx_t_24 = -1;
        if (__pyx_t_27 &lt; 0) {
          __pyx_t_27 += __pyx_v_indptr.shape[0];
          if (unlikely(__pyx_t_27 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_27 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_24 = 0;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 637, __pyx_L1_error)</span>
        }
        __pyx_t_28 = ((*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_27 * __pyx_v_indptr.strides[0]) ))) + __pyx_v_ii);
        __pyx_t_24 = -1;
        if (__pyx_t_28 &lt; 0) {
          __pyx_t_28 += __pyx_v_indices.shape[0];
          if (unlikely(__pyx_t_28 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_28 &gt;= __pyx_v_indices.shape[0])) __pyx_t_24 = 0;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 637, __pyx_L1_error)</span>
        }
        __pyx_t_29 = __pyx_v_second_col;
        __pyx_t_24 = -1;
        if (__pyx_t_29 &lt; 0) {
          __pyx_t_29 += __pyx_v_indptr.shape[0];
          if (unlikely(__pyx_t_29 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_29 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_24 = 0;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 637, __pyx_L1_error)</span>
        }
        __pyx_t_30 = ((*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_29 * __pyx_v_indptr.strides[0]) ))) + __pyx_v_jj);
        __pyx_t_24 = -1;
        if (__pyx_t_30 &lt; 0) {
          __pyx_t_30 += __pyx_v_indices.shape[0];
          if (unlikely(__pyx_t_30 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_30 &gt;= __pyx_v_indices.shape[0])) __pyx_t_24 = 0;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 637, __pyx_L1_error)</span>
        }
        __pyx_t_25 = (((*((int *) ( /* dim=0 */ (__pyx_v_indices.data + __pyx_t_28 * __pyx_v_indices.strides[0]) ))) &lt; (*((int *) ( /* dim=0 */ (__pyx_v_indices.data + __pyx_t_30 * __pyx_v_indices.strides[0]) )))) != 0);
        if (__pyx_t_25) {
/* … */
          goto __pyx_L11;
        }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">638</span>:                     <span class="n">ii</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>          __pyx_v_ii = (__pyx_v_ii + 1);
</pre><pre class="cython line score-8" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">639</span>:                 <span class="k">elif</span> <span class="n">indices</span><span class="p">[</span><span class="n">indptr</span><span class="p">[</span><span class="n">current_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">indices</span><span class="p">[</span><span class="n">indptr</span><span class="p">[</span><span class="n">second_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]:</span></pre>
<pre class='cython code score-8 '>        __pyx_t_31 = __pyx_v_current_col;
        __pyx_t_24 = -1;
        if (__pyx_t_31 &lt; 0) {
          __pyx_t_31 += __pyx_v_indptr.shape[0];
          if (unlikely(__pyx_t_31 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_31 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_24 = 0;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 639, __pyx_L1_error)</span>
        }
        __pyx_t_32 = ((*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_31 * __pyx_v_indptr.strides[0]) ))) + __pyx_v_ii);
        __pyx_t_24 = -1;
        if (__pyx_t_32 &lt; 0) {
          __pyx_t_32 += __pyx_v_indices.shape[0];
          if (unlikely(__pyx_t_32 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_32 &gt;= __pyx_v_indices.shape[0])) __pyx_t_24 = 0;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 639, __pyx_L1_error)</span>
        }
        __pyx_t_33 = __pyx_v_second_col;
        __pyx_t_24 = -1;
        if (__pyx_t_33 &lt; 0) {
          __pyx_t_33 += __pyx_v_indptr.shape[0];
          if (unlikely(__pyx_t_33 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_33 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_24 = 0;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 639, __pyx_L1_error)</span>
        }
        __pyx_t_34 = ((*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_33 * __pyx_v_indptr.strides[0]) ))) + __pyx_v_jj);
        __pyx_t_24 = -1;
        if (__pyx_t_34 &lt; 0) {
          __pyx_t_34 += __pyx_v_indices.shape[0];
          if (unlikely(__pyx_t_34 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_34 &gt;= __pyx_v_indices.shape[0])) __pyx_t_24 = 0;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 639, __pyx_L1_error)</span>
        }
        __pyx_t_25 = (((*((int *) ( /* dim=0 */ (__pyx_v_indices.data + __pyx_t_32 * __pyx_v_indices.strides[0]) ))) &gt; (*((int *) ( /* dim=0 */ (__pyx_v_indices.data + __pyx_t_34 * __pyx_v_indices.strides[0]) )))) != 0);
        if (__pyx_t_25) {
/* … */
          goto __pyx_L11;
        }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">640</span>:                     <span class="n">jj</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>          __pyx_v_jj = (__pyx_v_jj + 1);
</pre><pre class="cython line score-0">&#xA0;<span class="">641</span>:                 <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-4" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">642</span>:                     <span class="n">x_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indptr</span><span class="p">[</span><span class="n">current_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">ii</span><span class="p">]</span></pre>
<pre class='cython code score-4 '>        /*else*/ {
          __pyx_t_35 = __pyx_v_current_col;
          __pyx_t_24 = -1;
          if (__pyx_t_35 &lt; 0) {
            __pyx_t_35 += __pyx_v_indptr.shape[0];
            if (unlikely(__pyx_t_35 &lt; 0)) __pyx_t_24 = 0;
          } else if (unlikely(__pyx_t_35 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_24 = 0;
          if (unlikely(__pyx_t_24 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
            <span class='error_goto'>__PYX_ERR(0, 642, __pyx_L1_error)</span>
          }
          __pyx_t_36 = ((*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_35 * __pyx_v_indptr.strides[0]) ))) + __pyx_v_ii);
          __pyx_t_24 = -1;
          if (__pyx_t_36 &lt; 0) {
            __pyx_t_36 += __pyx_v_data.shape[0];
            if (unlikely(__pyx_t_36 &lt; 0)) __pyx_t_24 = 0;
          } else if (unlikely(__pyx_t_36 &gt;= __pyx_v_data.shape[0])) __pyx_t_24 = 0;
          if (unlikely(__pyx_t_24 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
            <span class='error_goto'>__PYX_ERR(0, 642, __pyx_L1_error)</span>
          }
          __pyx_v_x_i = (*((float *) ( /* dim=0 */ (__pyx_v_data.data + __pyx_t_36 * __pyx_v_data.strides[0]) )));
</pre><pre class="cython line score-4" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">643</span>:                     <span class="n">x_j</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indptr</span><span class="p">[</span><span class="n">second_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span></pre>
<pre class='cython code score-4 '>          __pyx_t_37 = __pyx_v_second_col;
          __pyx_t_24 = -1;
          if (__pyx_t_37 &lt; 0) {
            __pyx_t_37 += __pyx_v_indptr.shape[0];
            if (unlikely(__pyx_t_37 &lt; 0)) __pyx_t_24 = 0;
          } else if (unlikely(__pyx_t_37 &gt;= __pyx_v_indptr.shape[0])) __pyx_t_24 = 0;
          if (unlikely(__pyx_t_24 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
            <span class='error_goto'>__PYX_ERR(0, 643, __pyx_L1_error)</span>
          }
          __pyx_t_38 = ((*((int *) ( /* dim=0 */ (__pyx_v_indptr.data + __pyx_t_37 * __pyx_v_indptr.strides[0]) ))) + __pyx_v_jj);
          __pyx_t_24 = -1;
          if (__pyx_t_38 &lt; 0) {
            __pyx_t_38 += __pyx_v_data.shape[0];
            if (unlikely(__pyx_t_38 &lt; 0)) __pyx_t_24 = 0;
          } else if (unlikely(__pyx_t_38 &gt;= __pyx_v_data.shape[0])) __pyx_t_24 = 0;
          if (unlikely(__pyx_t_24 != -1)) {
            <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
            <span class='error_goto'>__PYX_ERR(0, 643, __pyx_L1_error)</span>
          }
          __pyx_v_x_j = (*((float *) ( /* dim=0 */ (__pyx_v_data.data + __pyx_t_38 * __pyx_v_data.strides[0]) )));
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">644</span>:                     <span class="n">ij_sum</span> <span class="o">+=</span> <span class="n">x_i</span> <span class="o">*</span> <span class="n">x_j</span></pre>
<pre class='cython code score-0 '>          __pyx_v_ij_sum = (__pyx_v_ij_sum + (__pyx_v_x_i * __pyx_v_x_j));
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">645</span>:                     <span class="n">ii_sum</span> <span class="o">+=</span> <span class="n">x_i</span> <span class="o">**</span> <span class="mf">2</span></pre>
<pre class='cython code score-0 '>          __pyx_v_ii_sum = (__pyx_v_ii_sum + powf(__pyx_v_x_i, 2.0));
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">646</span>:                     <span class="n">jj_sum</span> <span class="o">+=</span> <span class="n">x_j</span> <span class="o">**</span> <span class="mf">2</span></pre>
<pre class='cython code score-0 '>          __pyx_v_jj_sum = (__pyx_v_jj_sum + powf(__pyx_v_x_j, 2.0));
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">647</span>:                     <span class="n">ii</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>          __pyx_v_ii = (__pyx_v_ii + 1);
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">648</span>:                     <span class="n">jj</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>          __pyx_v_jj = (__pyx_v_jj + 1);
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">649</span>:                     <span class="n">n_common</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>          __pyx_v_n_common = (__pyx_v_n_common + 1);
        }
        __pyx_L11:;
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">650</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">651</span>:             <span class="k">if</span> <span class="n">n_common</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>      __pyx_t_25 = ((__pyx_v_n_common &gt; 0) != 0);
      if (__pyx_t_25) {
/* … */
      }
    }
  }
</pre><pre class="cython line score-71" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">652</span>:                 <span class="n">result</span><span class="p">[</span><span class="n">current_col</span><span class="p">,</span> <span class="n">second_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">ij_sum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ii_sum</span> <span class="o">*</span> <span class="n">jj_sum</span><span class="p">)</span></pre>
<pre class='cython code score-71 '>        __pyx_t_2 = <span class='py_c_api'>PyFloat_FromDouble</span>(__pyx_v_ij_sum);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
        __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_5, __pyx_n_s_sqrt);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_5 = <span class='py_c_api'>PyFloat_FromDouble</span>((__pyx_v_ii_sum * __pyx_v_jj_sum));<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
        __pyx_t_8 = NULL;
        if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_3))) {
          __pyx_t_8 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_3);
          if (likely(__pyx_t_8)) {
            PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_3);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_8);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
            <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_3, function);
          }
        }
        if (!__pyx_t_8) {
          __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_3, __pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
        } else {
          #if CYTHON_FAST_PYCALL
          if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_3)) {
            PyObject *__pyx_temp[2] = {__pyx_t_8, __pyx_t_5};
            __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
            <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
            <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
            <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
          } else
          #endif
          #if CYTHON_FAST_PYCCALL
          if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_3)) {
            PyObject *__pyx_temp[2] = {__pyx_t_8, __pyx_t_5};
            __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
            <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
            <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
            <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
          } else
          #endif
          {
            __pyx_t_39 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_39)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
            <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_39);
            <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_8); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_39, 0, __pyx_t_8); __pyx_t_8 = NULL;
            <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
            <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_39, 0+1, __pyx_t_5);
            __pyx_t_5 = 0;
            __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_39, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
            <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
            <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_39); __pyx_t_39 = 0;
          }
        }
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyNumber_Divide</span>(__pyx_t_2, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 652, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
        __pyx_t_40 = __pyx_<span class='py_c_api'>PyFloat_AsFloat</span>(__pyx_t_3); if (unlikely((__pyx_t_40 == ((npy_float32)-1)) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 652, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
        __pyx_t_41 = __pyx_v_current_col;
        __pyx_t_42 = __pyx_v_second_col;
        __pyx_t_24 = -1;
        if (__pyx_t_41 &lt; 0) {
          __pyx_t_41 += __pyx_pybuffernd_result.diminfo[0].shape;
          if (unlikely(__pyx_t_41 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_41 &gt;= __pyx_pybuffernd_result.diminfo[0].shape)) __pyx_t_24 = 0;
        if (__pyx_t_42 &lt; 0) {
          __pyx_t_42 += __pyx_pybuffernd_result.diminfo[1].shape;
          if (unlikely(__pyx_t_42 &lt; 0)) __pyx_t_24 = 1;
        } else if (unlikely(__pyx_t_42 &gt;= __pyx_pybuffernd_result.diminfo[1].shape)) __pyx_t_24 = 1;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 652, __pyx_L1_error)</span>
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float32_t *, __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.buf, __pyx_t_41, __pyx_pybuffernd_result.diminfo[0].strides, __pyx_t_42, __pyx_pybuffernd_result.diminfo[1].strides) = __pyx_t_40;
</pre><pre class="cython line score-4" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">653</span>:                 <span class="n">result</span><span class="p">[</span><span class="n">second_col</span><span class="p">,</span> <span class="n">current_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">current_col</span><span class="p">,</span> <span class="n">second_col</span><span class="p">]</span></pre>
<pre class='cython code score-4 '>        __pyx_t_43 = __pyx_v_current_col;
        __pyx_t_44 = __pyx_v_second_col;
        __pyx_t_24 = -1;
        if (__pyx_t_43 &lt; 0) {
          __pyx_t_43 += __pyx_pybuffernd_result.diminfo[0].shape;
          if (unlikely(__pyx_t_43 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_43 &gt;= __pyx_pybuffernd_result.diminfo[0].shape)) __pyx_t_24 = 0;
        if (__pyx_t_44 &lt; 0) {
          __pyx_t_44 += __pyx_pybuffernd_result.diminfo[1].shape;
          if (unlikely(__pyx_t_44 &lt; 0)) __pyx_t_24 = 1;
        } else if (unlikely(__pyx_t_44 &gt;= __pyx_pybuffernd_result.diminfo[1].shape)) __pyx_t_24 = 1;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 653, __pyx_L1_error)</span>
        }
        __pyx_t_45 = __pyx_v_second_col;
        __pyx_t_46 = __pyx_v_current_col;
        __pyx_t_24 = -1;
        if (__pyx_t_45 &lt; 0) {
          __pyx_t_45 += __pyx_pybuffernd_result.diminfo[0].shape;
          if (unlikely(__pyx_t_45 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_45 &gt;= __pyx_pybuffernd_result.diminfo[0].shape)) __pyx_t_24 = 0;
        if (__pyx_t_46 &lt; 0) {
          __pyx_t_46 += __pyx_pybuffernd_result.diminfo[1].shape;
          if (unlikely(__pyx_t_46 &lt; 0)) __pyx_t_24 = 1;
        } else if (unlikely(__pyx_t_46 &gt;= __pyx_pybuffernd_result.diminfo[1].shape)) __pyx_t_24 = 1;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 653, __pyx_L1_error)</span>
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float32_t *, __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.buf, __pyx_t_45, __pyx_pybuffernd_result.diminfo[0].strides, __pyx_t_46, __pyx_pybuffernd_result.diminfo[1].strides) = (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float32_t *, __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.buf, __pyx_t_43, __pyx_pybuffernd_result.diminfo[0].strides, __pyx_t_44, __pyx_pybuffernd_result.diminfo[1].strides));
</pre><pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">654</span>:                 <span class="n">common</span><span class="p">[</span><span class="n">current_col</span><span class="p">,</span> <span class="n">second_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_common</span></pre>
<pre class='cython code score-2 '>        __pyx_t_47 = __pyx_v_current_col;
        __pyx_t_48 = __pyx_v_second_col;
        __pyx_t_24 = -1;
        if (__pyx_t_47 &lt; 0) {
          __pyx_t_47 += __pyx_pybuffernd_common.diminfo[0].shape;
          if (unlikely(__pyx_t_47 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_47 &gt;= __pyx_pybuffernd_common.diminfo[0].shape)) __pyx_t_24 = 0;
        if (__pyx_t_48 &lt; 0) {
          __pyx_t_48 += __pyx_pybuffernd_common.diminfo[1].shape;
          if (unlikely(__pyx_t_48 &lt; 0)) __pyx_t_24 = 1;
        } else if (unlikely(__pyx_t_48 &gt;= __pyx_pybuffernd_common.diminfo[1].shape)) __pyx_t_24 = 1;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 654, __pyx_L1_error)</span>
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_int32_t *, __pyx_pybuffernd_common.rcbuffer-&gt;pybuffer.buf, __pyx_t_47, __pyx_pybuffernd_common.diminfo[0].strides, __pyx_t_48, __pyx_pybuffernd_common.diminfo[1].strides) = __pyx_v_n_common;
</pre><pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">655</span>:                 <span class="n">common</span><span class="p">[</span><span class="n">second_col</span><span class="p">,</span> <span class="n">current_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_common</span></pre>
<pre class='cython code score-2 '>        __pyx_t_49 = __pyx_v_second_col;
        __pyx_t_50 = __pyx_v_current_col;
        __pyx_t_24 = -1;
        if (__pyx_t_49 &lt; 0) {
          __pyx_t_49 += __pyx_pybuffernd_common.diminfo[0].shape;
          if (unlikely(__pyx_t_49 &lt; 0)) __pyx_t_24 = 0;
        } else if (unlikely(__pyx_t_49 &gt;= __pyx_pybuffernd_common.diminfo[0].shape)) __pyx_t_24 = 0;
        if (__pyx_t_50 &lt; 0) {
          __pyx_t_50 += __pyx_pybuffernd_common.diminfo[1].shape;
          if (unlikely(__pyx_t_50 &lt; 0)) __pyx_t_24 = 1;
        } else if (unlikely(__pyx_t_50 &gt;= __pyx_pybuffernd_common.diminfo[1].shape)) __pyx_t_24 = 1;
        if (unlikely(__pyx_t_24 != -1)) {
          <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_24);
          <span class='error_goto'>__PYX_ERR(0, 655, __pyx_L1_error)</span>
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_int32_t *, __pyx_pybuffernd_common.rcbuffer-&gt;pybuffer.buf, __pyx_t_49, __pyx_pybuffernd_common.diminfo[0].strides, __pyx_t_50, __pyx_pybuffernd_common.diminfo[1].strides) = __pyx_v_n_common;
</pre><pre class="cython line score-0">&#xA0;<span class="">656</span>: </pre>
<pre class="cython line score-10" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">657</span>:     <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">common</span></pre>
<pre class='cython code score-10 '>  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 657, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_result));
  <span class='refnanny'>__Pyx_GIVEREF</span>(((PyObject *)__pyx_v_result));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, ((PyObject *)__pyx_v_result));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_common));
  <span class='refnanny'>__Pyx_GIVEREF</span>(((PyObject *)__pyx_v_common));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 1, ((PyObject *)__pyx_v_common));
  __pyx_r = __pyx_t_3;
  __pyx_t_3 = 0;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">658</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">659</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">660</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">661</span>: <span class="c">###################################################################################################################</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">662</span>: <span class="c">#########################</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">663</span>: <span class="c">#########################       ARGSORT</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">664</span>: <span class="c">#########################</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">665</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">666</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">667</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">668</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">669</span>: <span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">malloc</span><span class="p">,</span> <span class="n">free</span><span class="c">#, qsort</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">670</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">671</span>: <span class="c"># Declaring QSORT as &quot;gil safe&quot;, appending &quot;nogil&quot; at the end of the declaration</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">672</span>: <span class="c"># Otherwise I will not be able to pass the comparator function pointer</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">673</span>: <span class="c"># https://stackoverflow.com/questions/8353076/how-do-i-pass-a-pointer-to-a-c-function-in-cython</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">674</span>: <span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;stdlib.h&quot;</span><span class="p">:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">675</span>:     <span class="k">ctypedef</span> <span class="n">void</span> <span class="n">const_void</span> <span class="s">&quot;const void&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">676</span>:     <span class="n">void</span> <span class="n">qsort</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="nb">int</span> <span class="n">nmemb</span><span class="p">,</span> <span class="nb">int</span> <span class="n">size</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">677</span>:             <span class="nb">int</span><span class="p">(</span><span class="o">*</span><span class="n">compar</span><span class="p">)(</span><span class="n">const_void</span> <span class="o">*</span><span class="p">,</span> <span class="n">const_void</span> <span class="o">*</span><span class="p">))</span> <span class="k">nogil</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">678</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">679</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">680</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">681</span>: <span class="c"># Node struct</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">682</span>: <span class="k">ctypedef</span> <span class="k">struct</span> <span class="nc">matrix_element_s</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>struct __pyx_t_25Compute_Similarity_Cython_matrix_element_s {
  long coordinate;
  double data;
};
</pre><pre class="cython line score-0">&#xA0;<span class="">683</span>:     <span class="nb">long</span> <span class="n">coordinate</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">684</span>:     <span class="n">double</span> <span class="n">data</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">685</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">686</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">687</span>: <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">compare_struct_on_data</span><span class="p">(</span><span class="n">const</span> <span class="n">void</span> <span class="o">*</span> <span class="n">a_input</span><span class="p">,</span> <span class="n">const</span> <span class="n">void</span> <span class="o">*</span> <span class="n">b_input</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>static int __pyx_f_25Compute_Similarity_Cython_compare_struct_on_data(void const *__pyx_v_a_input, void const *__pyx_v_b_input) {
  __pyx_t_25Compute_Similarity_Cython_matrix_element_s *__pyx_v_a_casted;
  __pyx_t_25Compute_Similarity_Cython_matrix_element_s *__pyx_v_b_casted;
  int __pyx_r;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("compare_struct_on_data", 0);
/* … */
  /* function exit code */
  __pyx_L0:;
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">688</span>:     <span class="sd">&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">689</span>: <span class="sd">    The function compares the data contained in the two struct passed.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">690</span>: <span class="sd">    If a.data &gt; b.data returns &gt;0  </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">691</span>: <span class="sd">    If a.data &lt; b.data returns &lt;0      </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">692</span>: <span class="sd">    </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">693</span>: <span class="sd">    :return int: +1 or -1</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">694</span>: <span class="sd">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">695</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">696</span>:     <span class="k">cdef</span> <span class="kt">matrix_element_s</span> * <span class="nf">a_casted</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">matrix_element_s</span> <span class="o">*&gt;</span> <span class="n">a_input</span></pre>
<pre class='cython code score-0 '>  __pyx_v_a_casted = ((__pyx_t_25Compute_Similarity_Cython_matrix_element_s *)__pyx_v_a_input);
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">697</span>:     <span class="k">cdef</span> <span class="kt">matrix_element_s</span> * <span class="nf">b_casted</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">matrix_element_s</span> <span class="o">*&gt;</span> <span class="n">b_input</span></pre>
<pre class='cython code score-0 '>  __pyx_v_b_casted = ((__pyx_t_25Compute_Similarity_Cython_matrix_element_s *)__pyx_v_b_input);
</pre><pre class="cython line score-0">&#xA0;<span class="">698</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">699</span>:     <span class="k">if</span> <span class="p">(</span><span class="n">a_casted</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">b_casted</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_1 = (((__pyx_v_a_casted-&gt;data - __pyx_v_b_casted-&gt;data) &gt; 0.0) != 0);
  if (__pyx_t_1) {
/* … */
  }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">700</span>:         <span class="k">return</span> <span class="o">+</span><span class="mf">1</span></pre>
<pre class='cython code score-0 '>    __pyx_r = 1;
    goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">701</span>:     <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">702</span>:         <span class="k">return</span> <span class="o">-</span><span class="mf">1</span></pre>
<pre class='cython code score-0 '>  /*else*/ {
    __pyx_r = -1;
    goto __pyx_L0;
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">703</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">704</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">705</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">706</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">707</span>: </pre>
<pre class="cython line score-22" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">708</span>: <span class="k">cdef</span> <span class="kt">long</span>[<span class="p">:]</span> <span class="n">argsort</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">this_item_weights</span><span class="p">,</span> <span class="nb">int</span> <span class="n">TopK</span><span class="p">):</span></pre>
<pre class='cython code score-22 '>static __Pyx_memviewslice __pyx_f_25Compute_Similarity_Cython_argsort(__Pyx_memviewslice __pyx_v_this_item_weights, int __pyx_v_TopK) {
  arrayobject *__pyx_v_template_zero = 0;
  arrayobject *__pyx_v_result = 0;
  __pyx_t_25Compute_Similarity_Cython_matrix_element_s *__pyx_v_matrix_element_array;
  int __pyx_v_index;
  int __pyx_v_num_elements;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_result;
  __Pyx_Buffer __pyx_pybuffer_result;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_template_zero;
  __Pyx_Buffer __pyx_pybuffer_template_zero;
  __Pyx_memviewslice __pyx_r = { 0, 0, { 0 }, { 0 }, { 0 } };
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("argsort", 0);
  __pyx_pybuffer_template_zero.pybuffer.buf = NULL;
  __pyx_pybuffer_template_zero.refcount = 0;
  __pyx_pybuffernd_template_zero.data = NULL;
  __pyx_pybuffernd_template_zero.rcbuffer = &amp;__pyx_pybuffer_template_zero;
  __pyx_pybuffer_result.pybuffer.buf = NULL;
  __pyx_pybuffer_result.refcount = 0;
  __pyx_pybuffernd_result.data = NULL;
  __pyx_pybuffernd_result.rcbuffer = &amp;__pyx_pybuffer_result;
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_10, 1);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&amp;__pyx_type, &amp;__pyx_value, &amp;__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_result.rcbuffer-&gt;pybuffer);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  __pyx_r.data = NULL;
  __pyx_r.memview = NULL;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("Compute_Similarity_Cython.argsort", __pyx_clineno, __pyx_lineno, __pyx_filename);

  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_result.rcbuffer-&gt;pybuffer);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&amp;__pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer);
  if (unlikely(!__pyx_r.memview)) {
    <span class='py_c_api'>PyErr_SetString</span>(PyExc_TypeError, "Memoryview return value is not initialized");
  }
  __pyx_L2:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>((PyObject *)__pyx_v_template_zero);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>((PyObject *)__pyx_v_result);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">709</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">710</span>:     <span class="c">#start_time = time.time()</span></pre>
<pre class="cython line score-10" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">711</span>:     <span class="k">cdef</span> <span class="kt">array</span>[<span class="kt">long</span>] <span class="nf">template_zero</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;l&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(((PyObject *)__pyx_ptype_7cpython_5array_array), __pyx_tuple__3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 711, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer, (PyObject*)((arrayobject *)__pyx_t_1), &amp;__Pyx_TypeInfo_long, PyBUF_FORMAT| PyBUF_INDIRECT, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_template_zero = ((arrayobject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None); __pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer.buf = NULL;
      <span class='error_goto'>__PYX_ERR(0, 711, __pyx_L1_error)</span>
    } else {__pyx_pybuffernd_template_zero.diminfo[0].strides = __pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer.strides[0]; __pyx_pybuffernd_template_zero.diminfo[0].shape = __pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer.shape[0]; __pyx_pybuffernd_template_zero.diminfo[0].suboffsets = __pyx_pybuffernd_template_zero.rcbuffer-&gt;pybuffer.suboffsets[0];
    }
  }
  __pyx_v_template_zero = ((arrayobject *)__pyx_t_1);
  __pyx_t_1 = 0;
/* … */
  __pyx_tuple__3 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_n_s_l);<span class='error_goto'> if (unlikely(!__pyx_tuple__3)) __PYX_ERR(0, 711, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__3);
</pre><pre class="cython line score-3" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">712</span>:     <span class="k">cdef</span> <span class="kt">array</span>[<span class="kt">long</span>] <span class="nf">result</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">template_zero</span><span class="p">,</span> <span class="n">TopK</span><span class="p">,</span> <span class="n">zero</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></pre>
<pre class='cython code score-3 '>  __pyx_t_1 = ((PyObject *)__pyx_f_7cpython_5array_clone(((arrayobject *)__pyx_v_template_zero), __pyx_v_TopK, 0));<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 712, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&amp;__pyx_pybuffernd_result.rcbuffer-&gt;pybuffer, (PyObject*)((arrayobject *)__pyx_t_1), &amp;__Pyx_TypeInfo_long, PyBUF_FORMAT| PyBUF_INDIRECT| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_result = ((arrayobject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None); __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.buf = NULL;
      <span class='error_goto'>__PYX_ERR(0, 712, __pyx_L1_error)</span>
    } else {__pyx_pybuffernd_result.diminfo[0].strides = __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.strides[0]; __pyx_pybuffernd_result.diminfo[0].shape = __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.shape[0]; __pyx_pybuffernd_result.diminfo[0].suboffsets = __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.suboffsets[0];
    }
  }
  __pyx_v_result = ((arrayobject *)__pyx_t_1);
  __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">713</span>:     <span class="c">#print(&quot;clone {} sec&quot;.format(time.time()-start_time))</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">714</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">715</span>:     <span class="k">cdef</span> <span class="kt">matrix_element_s</span> *<span class="nf">matrix_element_array</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">716</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">index</span><span class="p">,</span> <span class="nf">num_elements</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">717</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">718</span>:     <span class="n">num_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_item_weights</span><span class="p">)</span></pre>
<pre class='cython code score-2 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_MemoryView_Len</span>(__pyx_v_this_item_weights); 
  __pyx_v_num_elements = __pyx_t_2;
</pre><pre class="cython line score-0">&#xA0;<span class="">719</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">720</span>:     <span class="c"># Allocate vector that will be used for sorting</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">721</span>:     <span class="n">matrix_element_array</span> <span class="o">=</span> <span class="o">&lt;</span> <span class="n">matrix_element_s</span> <span class="o">*&gt;</span> <span class="n">malloc</span><span class="p">(</span><span class="n">num_elements</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">matrix_element_s</span><span class="p">))</span></pre>
<pre class='cython code score-0 '>  __pyx_v_matrix_element_array = ((__pyx_t_25Compute_Similarity_Cython_matrix_element_s *)malloc((__pyx_v_num_elements * (sizeof(__pyx_t_25Compute_Similarity_Cython_matrix_element_s)))));
</pre><pre class="cython line score-0">&#xA0;<span class="">722</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">723</span>:     <span class="c">#start_time = time.time()</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">724</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">725</span>:     <span class="c"># Fill vector wit pointers to list elements</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">726</span>:     <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_elements</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>  __pyx_t_3 = __pyx_v_num_elements;
  __pyx_t_4 = __pyx_t_3;
  for (__pyx_t_5 = 0; __pyx_t_5 &lt; __pyx_t_4; __pyx_t_5+=1) {
    __pyx_v_index = __pyx_t_5;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">727</span>:         <span class="n">matrix_element_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">index</span></pre>
<pre class='cython code score-0 '>    (__pyx_v_matrix_element_array[__pyx_v_index]).coordinate = __pyx_v_index;
</pre><pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">728</span>:         <span class="n">matrix_element_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">this_item_weights</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></pre>
<pre class='cython code score-2 '>    __pyx_t_6 = __pyx_v_index;
    __pyx_t_7 = -1;
    if (__pyx_t_6 &lt; 0) {
      __pyx_t_6 += __pyx_v_this_item_weights.shape[0];
      if (unlikely(__pyx_t_6 &lt; 0)) __pyx_t_7 = 0;
    } else if (unlikely(__pyx_t_6 &gt;= __pyx_v_this_item_weights.shape[0])) __pyx_t_7 = 0;
    if (unlikely(__pyx_t_7 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_7);
      <span class='error_goto'>__PYX_ERR(0, 728, __pyx_L1_error)</span>
    }
    (__pyx_v_matrix_element_array[__pyx_v_index]).data = (*((double *) ( /* dim=0 */ (__pyx_v_this_item_weights.data + __pyx_t_6 * __pyx_v_this_item_weights.strides[0]) )));
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">729</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">730</span>:     <span class="c">#print(&quot;Init {} sec&quot;.format(time.time()-start_time))</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">731</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">732</span>:     <span class="c">#start_time = time.time()</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">733</span>:     <span class="c"># Sort array elements on their data field</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">734</span>:     <span class="n">qsort</span><span class="p">(</span><span class="n">matrix_element_array</span><span class="p">,</span> <span class="n">num_elements</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">matrix_element_s</span><span class="p">),</span> <span class="n">compare_struct_on_data</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>  qsort(__pyx_v_matrix_element_array, __pyx_v_num_elements, (sizeof(__pyx_t_25Compute_Similarity_Cython_matrix_element_s)), __pyx_f_25Compute_Similarity_Cython_compare_struct_on_data);
</pre><pre class="cython line score-0">&#xA0;<span class="">735</span>:     <span class="c">#print(&quot;qsort {} sec&quot;.format(time.time()-start_time))</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">736</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">737</span>:     <span class="c">#start_time = time.time()</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">738</span>:     <span class="c"># Sort is from lower to higher, therefore the elements to be considered are from len-topK to len</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">739</span>:     <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TopK</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>  __pyx_t_3 = __pyx_v_TopK;
  __pyx_t_4 = __pyx_t_3;
  for (__pyx_t_5 = 0; __pyx_t_5 &lt; __pyx_t_4; __pyx_t_5+=1) {
    __pyx_v_index = __pyx_t_5;
</pre><pre class="cython line score-0">&#xA0;<span class="">740</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">741</span>:         <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix_element_array</span><span class="p">[</span><span class="n">num_elements</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mf">1</span><span class="p">]</span><span class="o">.</span><span class="n">coordinate</span></pre>
<pre class='cython code score-2 '>    __pyx_t_8 = (__pyx_v_matrix_element_array[((__pyx_v_num_elements - __pyx_v_index) - 1)]).coordinate;
    __pyx_t_9 = __pyx_v_index;
    __pyx_t_7 = -1;
    if (__pyx_t_9 &lt; 0) {
      __pyx_t_9 += __pyx_pybuffernd_result.diminfo[0].shape;
      if (unlikely(__pyx_t_9 &lt; 0)) __pyx_t_7 = 0;
    } else if (unlikely(__pyx_t_9 &gt;= __pyx_pybuffernd_result.diminfo[0].shape)) __pyx_t_7 = 0;
    if (unlikely(__pyx_t_7 != -1)) {
      <span class='pyx_c_api'>__Pyx_RaiseBufferIndexError</span>(__pyx_t_7);
      <span class='error_goto'>__PYX_ERR(0, 741, __pyx_L1_error)</span>
    }
    *__Pyx_BufPtrFull1d(long *, __pyx_pybuffernd_result.rcbuffer-&gt;pybuffer.buf, __pyx_t_9, __pyx_pybuffernd_result.diminfo[0].strides, __pyx_pybuffernd_result.diminfo[0].suboffsets) = __pyx_t_8;
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">742</span>:     <span class="c">#print(&quot;result {} sec&quot;.format(time.time()-start_time))</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">743</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">744</span>:     <span class="n">free</span><span class="p">(</span><span class="n">matrix_element_array</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>  free(__pyx_v_matrix_element_array);
</pre><pre class="cython line score-0">&#xA0;<span class="">745</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">746</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">747</span>: </pre>
<pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">748</span>:     <span class="k">return</span> <span class="n">result</span></pre>
<pre class='cython code score-2 '>  __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_long</span>(((PyObject *)__pyx_v_result), PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 748, __pyx_L1_error)</span>
  __pyx_r = __pyx_t_10;
  __pyx_t_10.memview = NULL;
  __pyx_t_10.data = NULL;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">749</span>: </pre>
</div></body></html>
